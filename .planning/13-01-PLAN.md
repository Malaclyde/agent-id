# Phase 13 Plan: Frontend Subscription OAuth Usage Bugfix

**Phase:** 13  
**Goal:** Fix the missing oauth_count in /v1/subscriptions/usage endpoint so the frontend correctly displays OAuth usage

## Bug Analysis

### Current Behavior
- Frontend (SubscriptionManagement.tsx line 169) tries to display OAuth usage:
  ```typescript
  const oauthUsage = formatLimit(subscription.max_oauth_per_period, usage?.oauth_count || 0);
  ```
- Backend `/v1/subscriptions/usage` endpoint returns:
  ```typescript
  usage: {
    agents_claimed: agentsClaimed,
    clients_registered: clientsRegistered,
    can_register_more_clients: canRegisterMore.allowed,
    client_limit_reason: canRegisterMore.reason
  }
  ```
- **Missing:** `oauth_count` is NOT returned!

### Result
The OAuth usage display always shows "0/10" or "0/unlimited" instead of the actual usage count.

## Requirements

1. **FIX-OAUTH-01:** Add function to count total OAuth requests across all agents for an overseer
2. **FIX-OAUTH-02:** Update /v1/subscriptions/usage endpoint to return oauth_count
3. **FIX-OAUTH-03:** Update TypeScript types if needed
4. **FIX-OAUTH-04:** Verify frontend displays OAuth usage correctly

## Implementation Steps

### Step 1: Add OAuth count function (5 min)
- Add `countOAuthRequestsByOverseer` function in backend/src/services/agent.ts
- Query sum of oauth_count from agents table for the overseer

### Step 2: Update usage endpoint (10 min)
- Modify `/v1/subscriptions/usage` in backend/src/routes/subscriptions.ts
- Call the new count function and include oauth_count in response

### Step 3: Verify types (5 min)
- Check if SubscriptionUsage type needs update
- frontend/src/types/index.ts already has oauth_count field

### Step 4: Verify frontend (10 min)
- Test the subscription management page
- Confirm OAuth usage shows correct count

## Execution

```bash
# Navigate to backend
cd backend

# Run the relevant tests (if any exist)
npx vitest run --reporter=verbose src/services/agent

# Test the endpoint manually after deployment
curl -H "Authorization: Bearer <session>" https://<worker>/v1/subscriptions/usage
```

## Verification Checklist

- [ ] /v1/subscriptions/usage returns oauth_count in usage object
- [ ] OAuth usage display shows actual count (e.g., "5/10")
- [ ] FREE tier shows correct "X/10" format
- [ ] Paid tiers with unlimited show "X/âˆž" format
- [ ] No console errors on subscription page load
