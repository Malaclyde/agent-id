---
phase: 25-frontend-update
plan: 08
type: execute
wave: 1
depends_on: ["25-06", "25-07"]
files_modified:
  - frontend/src/pages/ShadowClaimPayment.tsx
  - frontend/src/api/client.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Payment amount fetched from Paddle using paddle_price_id"
    - "Tier capabilities displayed from database (requests limit, clients limit)"
    - "Cancel buttons show message to close browser tab"
    - "Success state displays message, no navigation"
    - "Cancelled checkout only shows Retry Payment button"
  artifacts:
    - path: "frontend/src/pages/ShadowClaimPayment.tsx"
      provides: "Payment UI with correct data and behaviors"
  key_links:
    - from: "ShadowClaimPayment.tsx"
      to: "Paddle API"
      via: "fetch price using paddle_price_id"
---

<objective>
Fix payment page issues: hardcoded price, cancel buttons, success navigation, cancelled checkout buttons.

Purpose: Fix Tests 6, 7, 9, 10 - payment display and navigation issues
Output: Payment page shows correct data and appropriate behaviors
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/25-frontend-update/25-UAT.md
# Gaps to fix:

Test 6: Payment amount does not equal paddle - fetch from paddle directly. 
Information should include capabilities from db (requests limit, clients limit).
Do not display "BASIC" tier name.

Test 7: Cancel buttons navigate away instead of showing message.
- Cancel on claim page: navigates to /agent/dashboard
- Cancel on payment page: navigates back to claim page

Test 9: Payment completion navigates to home instead of showing success message.

Test 10: Cancelled checkout shows two buttons (Retry Payment + Return to Claim Page).
Only retry should be allowed.
</context>

<tasks>

<task type="auto">
<name>Fetch price from Paddle API</name>
  <files>frontend/src/api/client.ts</files>
  <action>
    Add a new method to fetch price details from Paddle:
    
    ```typescript
    async getPaddlePrice(priceId: string): Promise<{
      price: number;
      currency: string;
      formatted: string;
    }> {
      return this.request<{
        price: number;
        currency: string;
        formatted: string;
      }>(`/v1/prices/${priceId}`);
    }
    ```
    
    Note: This requires a backend endpoint. If it doesn't exist, use the paddle_price_id 
    to construct the display and note that actual price comes from backend's awaiting-payment response.
    
    Alternative: Update backend to include price in challenge status response.
  </action>
  <verify>API method exists or backend returns price in status response.</verify>
  <done>Price can be fetched from Paddle</done>
</task>

<task type="auto">
  <name>Update payment page to use dynamic price</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
    1. Remove hardcoded "$19.00" from line 476
    2. Update ChallengeData interface to include price info:
       ```typescript
       interface ChallengeData {
         // existing fields
         price?: {
           amount: number;
           currency: string;
           formatted: string;
         };
         tier?: {
           requests_limit: number;
           clients_limit: number;
         };
       }
       ```
    3. When status is 'awaiting-payment', fetch price using paddle_price_id
    4. Display formatted price: `${price.formatted}` or `$${(price.amount / 100).toFixed(2)}`
    5. Remove "Basic Tier" text - show only the limits
  </action>
  <verify>TypeScript compiles. Price displays dynamically.</verify>
  <done>Payment amount fetched from Paddle</done>
</task>

<task type="auto">
  <name>Display tier capabilities from database</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
    Update the payment UI to show tier capabilities:
    
    1. Remove "Shadow Claim - Basic Tier Access" heading
    2. Show capabilities as:
       - "Requests per billing period: X"
       - "Clients you can register: Y"
    3. Use the tier data from backend (update backend if needed to include tier info)
    
    If backend doesn't provide tier info, display generic message:
    "This subscription allows you to oversee this agent with full API access."
  </action>
  <verify>TypeScript compiles. Capabilities displayed.</verify>
  <done>Tier capabilities shown without "BASIC" name</done>
</task>

<task type="auto">
  <name>Fix cancel button on claim page</name>
  <files>frontend/src/pages/ShadowClaim.tsx</files>
  <action>
    Find the Cancel button (around line 770-799) and change its behavior:
    
    1. Remove the onClick navigate to dashboard
    2. Instead, show a message below the button:
       "You can close this browser tab. The challenge will expire automatically."
    3. The button can either:
       a) Be removed entirely, OR
       b) Show an alert/message when clicked
    
    Current code (line 774): onClick={() => navigate('/agent/dashboard')}
    Replace with: Show inline message
  </action>
  <verify>Clicking cancel shows message, doesn't navigate away.</verify>
  <done>Cancel button shows close tab message</done>
</task>

<task type="auto">
  <name>Fix cancel button on payment page</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
    Find the cancel button (around line 545-563 - handleReturnToClaim):
    
    1. Remove the handleReturnToClaim function or change its behavior
    2. Replace with a message display:
       "You can close this browser tab. The payment is not complete."
    3. Update the button text from "Cancel and Return" to just show the message
    
    Current code (line 559): onClick={handleReturnToClaim}
    Replace with: Show inline message without navigation
  </action>
  <verify>Cancel shows message, doesn't navigate to claim page.</verify>
  <done>Payment page cancel shows close tab message</done>
</task>

<task type="auto">
  <name>Fix success state to not navigate away</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
    Find the success state (lines 284-317):
    
    1. Remove the handleReturnToDashboard call (line 309)
    2. Keep the success message displayed
    3. Add a "Close this window" message
    4. Optionally add a button to navigate to dashboard (but don't auto-navigate)
    
    Current code auto-navigates after showing success.
    Replace with: Display success message, stay on page
  </action>
  <verify>Success message stays displayed, no navigation.</verify>
  <done>Success state shows message without navigation</done>
</task>

<task type="auto">
  <name>Fix cancelled checkout buttons</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
    Find the cancelled state (lines 397-438):
    
    1. Remove the "Return to Claim Page" button (lines 428-433)
    2. Keep only the "Retry Payment" button
    3. Update message to clarify: "You cancelled the payment. Click below to try again."
    
    The cancelled state should only allow retrying payment, not returning to claim page.
  </action>
  <verify>Only Retry Payment button appears in cancelled state.</verify>
  <done>Cancelled checkout shows only retry option</done>
</task>

</tasks>

<verification>
1. Run `cd frontend && npm run build` - should complete without errors
2. Payment amount is dynamic (not hardcoded)
3. Cancel buttons show message, don't navigate
4. Success stays on page
5. Cancelled state has one button
</verification>

<success_criteria>
- Price fetched from Paddle
- Tier capabilities shown without "BASIC"
- Cancel buttons show message
- Success doesn't navigate
- Cancelled shows only retry
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-update/25-08-SUMMARY.md`
</output>
