---
phase: 25-frontend-update
plan: 04
type: execute
wave: 3
depends_on: [25-02]
files_modified:
  - frontend/src/pages/ShadowClaim.tsx
autonomous: true

must_haves:
  truths:
    - Agent confirmation instructions displayed clearly when status is initiated
    - Instructions include URL, request body, and auth method
    - Countdown timer shows challenge expiration
    - Error and expiration states have user-friendly messages
  artifacts:
    - path: frontend/src/pages/ShadowClaim.tsx
      provides: Complete UI with instructions and error handling
      contains: "Agent Confirmation|Waiting for agent|challenge.*expire"
  key_links:
    - from: Instructions UI
      to: User (shadow overseer)
      via: Display in browser
      pattern: "Agent Confirmation Required|POST.*claim/complete"
    - from: Countdown timer
      to: expires_at timestamp
      via: Calculation on render
      pattern: "expires_at|setInterval.*timer"
---

<objective>
Add agent confirmation instructions UI and comprehensive error handling.

Purpose: Provide clear instructions for agent confirmation and handle all error states gracefully
Output: Complete ShadowClaim component with user-friendly instructions and error messages
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/25-frontend-update/25-02-SUMMARY.md

@frontend/src/pages/ShadowClaim.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent confirmation instructions UI</name>
  <files>frontend/src/pages/ShadowClaim.tsx</files>
  <action>
    Implement the instructions screen shown when status is 'initiated':
    
    1. Display clear heading: "Agent Confirmation Required"
    
    2. Show instructions in a clean, readable format:
       - "Instruct your agent to send a POST request to the following endpoint:"
       - Display URL in a code block: `<apiBaseUrl>/v1/agents/claim/complete/{challengeId}`
       - Use a monospace font and copy button for the URL
    
    3. Show request body in a code block:
       ```json
       {
         "overseer_id": "{shadowId}"
       }
       ```
       - Include copy button
       - Use syntax highlighting if available
    
    4. Show authentication instructions:
       - "The agent must authenticate using their DPoP JWT"
       - "Include the DPoP proof in the Authorization header"
       - Example header: `Authorization: Bearer <DPoP_JWT>`
    
    5. Show waiting indicator:
       - Animated spinner or pulse animation
       - Message: "Waiting for agent to confirm..."
       - Display a countdown timer showing time until challenge expiration
       - Calculate remaining time from expires_at timestamp
    
    6. Show cancel option:
       - Button: "Cancel Claim" (secondary style)
       - Note below button: "You can close this window. The challenge will expire automatically in {minutes} minutes."
       - On click: Navigate back to agent page or home
    
    7. Style with clear typography and good spacing:
       - Use consistent spacing between sections
       - Make code blocks visually distinct (dark background)
       - Use appropriate heading hierarchy
       - Ensure mobile responsiveness
    
    8. Make instructions copy-paste friendly:
       - Click to copy functionality for URL and body
       - Show "Copied!" feedback for 2 seconds after copy
  </action>
  <verify>
    - Instructions are clear and complete
    - URL and body are copy-paste friendly
    - Countdown timer works and updates every second
    - Cancel option present and functional
    - Copy buttons work with feedback
    - Mobile layout looks correct
  </verify>
  <done>
    Agent confirmation instructions UI displays all required information clearly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add error and expiration handling</name>
  <files>frontend/src/pages/ShadowClaim.tsx</files>
  <action>
    Implement comprehensive error handling:
    
    1. Error states:
       - API errors (network, 4xx, 5xx)
       - Challenge not found (404 from status endpoint)
       - Challenge expired
       - Agent already claimed by real overseer
       - Paddle checkout errors (for payment-related issues)
    
    2. Expiration handling:
       - Show clear expiration message: "This claim challenge has expired"
       - Display helpful context: "Challenges expire after 60 minutes for security"
       - Provide button: "Start New Claim" (primary style)
       - Clean up polling interval
       - Clear challengeId from state
    
    3. Already claimed handling:
       - If agent already has real overseer (check API response or error code)
       - Show error: "This agent is already claimed by another overseer"
       - Provide option: "View Agent Details" (navigate to agent page)
       - Disable further claim actions
    
    4. Network error handling:
       - Implement retry logic for API calls
       - Use exponential backoff (start at 2s, double to max 30s)
       - Track retry count and stop after 3 failed attempts
       - Show error after max retries: "Unable to connect. Please check your connection and try again."
       - Provide retry button
    
    5. User-friendly error messages:
       - Don't show raw API errors or stack traces to users
       - Provide helpful context and next steps
       - Use clear, non-technical language
       - Link to support documentation if available
    
    6. Error boundary:
       - Wrap component in React error boundary
       - Catch unexpected errors
       - Show fallback UI: "Something went wrong. Please refresh and try again."
       - Log error details to console for debugging
    
    7. Display error states in the UI:
       - Use error icon or red color scheme
       - Show error message prominently
       - Include specific guidance for each error type
       - Provide appropriate action buttons
  </action>
  <verify>
    - All error states handled
    - User-friendly messages displayed
    - Retry logic works with exponential backoff
    - Cleanup happens on errors
    - Error boundary catches unexpected errors
    - Mobile error UI looks correct
  </verify>
  <done>
    Comprehensive error handling implemented for all failure modes
  </done>
</task>

</tasks>

<verification>
1. Agent confirmation instructions display all required information
2. Instructions are copy-paste friendly
3. Countdown timer shows remaining time correctly
4. All error states handled with user-friendly messages
5. Expiration state shows clear message and retry option
6. Network errors trigger retry with exponential backoff
7. Error boundary catches unexpected errors
</verification>

<success_criteria>
- ShadowClaim component builds on core structure from plan 02
- Agent confirmation instructions are clear, complete, and user-friendly
- Countdown timer works accurately
- All error states handled gracefully
- Error messages are user-friendly and actionable
- Component handles edge cases (network failure, unexpected errors)
- Mobile layout and styling correct
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-update/25-04-SUMMARY.md`
</output>
