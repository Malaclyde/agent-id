---
phase: 25-frontend-update
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/ShadowClaimPayment.tsx
  - frontend/src/api/client.ts
  - frontend/src/index.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Payment amount fetched from Paddle (not hardcoded $19.00)"
    - "Tier capabilities shown from database (not tier name)"
    - "Cancel buttons show 'close browser tab' message (not navigate)"
    - "Success state displays message (not navigate away)"
    - "Cancelled checkout shows only 'Retry Payment' button"
  artifacts:
    - path: "frontend/src/pages/ShadowClaimPayment.tsx"
      provides: "Payment UI with correct behavior"
      contains: "dynamic price, proper button actions"
---

<objective>
Fix ShadowClaimPayment.tsx to display dynamic pricing, fix button behaviors, and improve styling.
</objective>

<context>
@.planning/phases/25-frontend-update/25-UAT.md

Gaps:
1. Hardcoded $19.00 instead of fetching from Paddle
2. Shows "BASIC" tier name instead of capabilities from DB
3. Cancel buttons navigate instead of showing info message
4. Success state navigates away instead of displaying message
5. Cancelled checkout shows two buttons (should only show Retry Payment)
</context>

<tasks>

<task type="auto">
  <name>Fix hardcoded price and add tier capabilities</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
1. Fetch actual price from Paddle:
   - The backend should return the price when fetching challenge status. Check if ChallengeStatusResponse already has price info.
   - If not, add an API method to fetch price details from Paddle using the paddle_price_id
   - Alternatively, use Paddle.js to get price details client-side

2. Display dynamic price instead of hardcoded $19.00:
   - Replace line 476 `$19.00` with dynamic price from API
   - Format price as currency

3. Show tier capabilities instead of "BASIC" tier name:
   - Backend should return tier limits (requests_per_hour, max_clients)
   - Display: "This tier allows your agent to make X requests per hour and register up to Y clients"
   - Remove any mention of "BASIC" tier name
   - Show actual numbers from the database/config

4. Add state for price and tier info:
   ```typescript
   const [priceInfo, setPriceInfo] = useState<{amount: number; currency: string} | null>(null);
   const [tierCapabilities, setTierCapabilities] = useState<{requestsPerHour: number; maxClients: number} | null>(null);
   ```

5. Fetch price on mount (when challenge data loads):
   - Use Paddle.PricePreview or similar to get actual price
   - Fallback: Display "Loading price..." while fetching
  </action>
  <verify>
- Price displayed matches Paddle configuration
- Tier shows capabilities (e.g., "100 requests per hour, 10 clients") not "BASIC"
  </verify>
  <done>
- No hardcoded $19.00 in UI
- Tier capabilities displayed from database/config
- No "BASIC" tier name shown
  </done>
</task>

<task type="auto">
  <name>Fix cancel button behaviors</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
Fix the cancel button behavior in the payment page:

1. In the main payment view (lines 545-563), replace the navigation with message display:
   - Remove the `handleReturnToClaim` navigation
   - Instead, show a message: "You can close this browser tab. The challenge will remain pending until payment is completed or the challenge expires."
   - Change button to display-only text (not clickable navigation)

2. Also check the "Cancel" link in the error state (lines 354-395):
   - Should show similar message, not navigate

3. Change from:
   ```typescript
   const handleReturnToClaim = () => {
     navigate(`/malice/${challengeData?.agent_id}`);
   };
   ```
   
   To:
   ```typescript
   const [showCancelInfo, setShowCancelInfo] = useState(false);
   
   // In render:
   {showCancelInfo ? (
     <div className="cancel-info">
       <p>You can close this browser tab.</p>
       <p>The challenge will remain pending until payment is completed or expires.</p>
       <button className="btn btn-secondary" onClick={() => setShowCancelInfo(false)}>
         Back to Payment
       </button>
     </div>
   ) : (
     <button className="btn" onClick={() => setShowCancelInfo(true)}>
       Cancel
     </button>
   )}
   ```
  </action>
  <verify>
- Cancel button shows information message, not navigation
- User can close tab and challenge remains pending
  </verify>
  <done>
- Cancel button displays "close browser tab" message
- No navigation away from payment page
  </done>
</task>

<task type="auto">
  <name>Fix success state to display message (not navigate)</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
In the success state (lines 283-317):

1. Remove the automatic navigation to dashboard:
   - Remove or comment out `handleReturnToDashboard` call
   - The page should display the success message and stay there

2. Update the success UI:
   - Keep the success message displayed
   - Optionally add a button to navigate to dashboard (but user must choose to click it)
   - Do NOT auto-navigate

3. Change from:
   ```typescript
   // Line 309-313:
   <button
     className="btn btn-primary"
     onClick={handleReturnToDashboard}
     style={{ width: '100%' }}
   >
     Go to Dashboard
   </button>
   ```

   To display success without auto-navigation:
   ```typescript
   <div className="success-message">
     <CheckCircle size={64} ... />
     <h1>Shadow Claim Complete!</h1>
     <p>Your payment was successful and your shadow claim is being processed.</p>
     <p>The agent is now under your shadow oversight.</p>
     {/* Optional: button to navigate, but don't auto-navigate */}
     <button
       className="btn btn-primary"
       onClick={() => navigate('/overseer/dashboard')}
     >
       Go to Dashboard
     </button>
   </div>
   ```
  </action>
  <verify>
- Success state stays on page with message
- No automatic navigation to dashboard
  </verify>
  <done>
- Success message displayed to user
- User can read confirmation before navigating
  </done>
</task>

<task type="auto">
  <name>Fix cancelled checkout buttons</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
In the cancelled state (lines 397-438):

1. Remove the "Return to Claim Page" button:
   - This button starts a new claim which is wrong behavior
   - Only show "Retry Payment" button

2. Change from:
   ```typescript
   // Lines 421-434:
   <div style={{ display: 'flex', gap: '0.5rem', flexDirection: 'column' }}>
     <button
       className="btn btn-primary"
       onClick={handleRetry}
     >
       Retry Payment
     </button>
     <button
       className="btn btn-secondary"
       onClick={handleReturnToClaim}
     >
       Return to Claim Page
     </button>
   </div>
   ```

   To:
   ```typescript
   <div style={{ display: 'flex', gap: '0.5rem', flexDirection: 'column' }}>
     <button
       className="btn btn-primary"
       onClick={handleRetry}
     >
       Retry Payment
     </button>
   </div>
   ```

3. Also fix error state (lines 354-395) - remove "Return to Claim Page" button there too if present
  </verify>
  <verify>
- Cancelled state shows only one button: "Retry Payment"
- No way to accidentally start a new claim
  </verify>
  <done>
- Only "Retry Payment" button shown in cancelled state
- "Return to Claim Page" button removed
  </done>
</task>

<task type="auto">
  <name>Apply consistent styling to ShadowClaimPayment</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx, frontend/src/index.css</files>
  <action>
Apply the same styling approach as ShadowClaim.tsx:

1. Replace inline styles with CSS classes:
   - Use `.card`, `.btn`, `.btn-primary`, `.btn-secondary` classes
   - Add `.payment-container`, `.payment-amount`, `.payment-info` classes to index.css

2. Ensure squared corners (border-radius: 0):
   - Add `border-radius: 0` to payment-specific CSS classes

3. Use project color palette:
   - Replace `#f3f4f6` with `var(--surface-alt)`
   - Replace `#3b82f6` with `var(--primary)`
   - Replace `#ef4444` with `var(--error)`
   - Replace `#10b981` with `var(--success)`
   - Replace `#f59e0b` with `var(--warning)`
   - Replace `#1e40af` with `var(--text)` or adjust

4. Replace inline button styles:
   - Lines 521-533: Use `.btn.btn-primary` class
   - Lines 378-391: Use button classes
  </action>
  <verify>
- Frontend builds without errors
- Payment page styling matches project theme
- All corners squared
  </verify>
  <done>
- Consistent styling with ShadowClaim.tsx
- Project color palette used throughout
- Border-radius: 0 on all elements
  </done>
</task>

</tasks>

<verification>
- Frontend builds without TypeScript errors
- All button behaviors match requirements
- Dynamic price displayed
- Test 6, 7, 9, 10 pass
</verification>

<success_criteria>
- Test 6: Payment amount from Paddle, tier capabilities shown
- Test 7: Cancel shows "close browser tab" message
- Test 9: Success displays message (no auto-navigation)
- Test 10: Cancelled checkout only shows "Retry Payment"
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-update/25-12-SUMMARY.md`
</output>
