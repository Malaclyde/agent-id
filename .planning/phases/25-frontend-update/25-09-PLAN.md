---
phase: 25-frontend-update
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/agents.ts
  - backend/src/utils/helpers.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Challenge expires in 60 minutes from initiation"
    - "Backend correctly returns expires_at with 60 minute TTL"
  artifacts:
    - path: "backend/src/utils/helpers.ts"
      provides: "getExpirationTime function"
    - path: "backend/src/routes/agents.ts"
      provides: "Shadow claim initiation endpoint"
  key_links:
    - from: "agents.ts"
      to: "helpers.ts"
      via: "getExpirationTime(60)"
---

<objective>
Fix challenge TTL - currently expires in 45 seconds instead of 60 minutes.

Purpose: Fix Test 2 (part 2) - Challenge expiry TTL issue
Output: Challenge expires in 60 minutes as specified
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/25-frontend-update/25-UAT.md
# Gap: Test 2 - Challenge expires in 45 seconds

User reported: created shadow claim at 17:05, but expires_at shows 17:05:45 (only 45 seconds).
Challenge TTL should be 60 minutes, not ~45 seconds.

Root cause: Backend code shows getExpirationTime(60) at lines 798, 810 in agents.ts - 
appears correct but user observes ~45s. May be deployment/version mismatch or different code path.
</context>

<tasks>

<task type="auto">
  <name>Verify getExpirationTime implementation</name>
  <files>backend/src/utils/helpers.ts</files>
  <action>
    Read the getExpirationTime function in helpers.ts:
    
    Expected implementation:
    ```typescript
    export function getExpirationTime(minutes: number): string {
      const now = Date.now();
      const expiration = now + (minutes * 60 * 1000);
      return new Date(expiration).toISOString();
    }
    ```
    
    Check if:
    1. The function correctly calculates minutes * 60 * 1000
    2. There's no division by 1000 somewhere that converts to seconds
    3. The return value is ISO string format
  </action>
  <verify>Function correctly calculates 60 minutes in milliseconds.</verify>
  <done>helpers.ts getExpirationTime works correctly</done>
</task>

<task type="auto">
  <name>Verify agents.ts calls getExpirationTime correctly</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Find all calls to getExpirationTime in agents.ts:
    
    1. Search for "getExpirationTime" 
    2. Verify calls pass 60 as the parameter for shadow claims
    3. Verify the return value is stored correctly in the challenge data
    4. Check if there's any override or different code path for shadow claims
    
    The issue may be:
    - Different code path for shadow claims
    - Wrong parameter passed (60 instead of minutes)
    - Time being calculated in seconds somewhere
  </action>
  <verify>All getExpirationTime calls use correct parameter.</verify>
  <done>agents.ts calls getExpirationTime correctly</done>
</task>

<task type="auto">
  <name>Add debug logging to verify expires_at value</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Add console.log to verify the actual expires_at value before returning:
    
    ```typescript
    const expiresAt = getExpirationTime(60);
    console.log('Shadow claim expires_at:', expiresAt, 'ms:', Date.now() + (60 * 60 * 1000));
    ```
    
    This will help verify the value being set and returned to the frontend.
  </action>
  <verify>Console shows correct 60-minute expiration time.</verify>
  <done>Debug logging added to verify TTL</done>
</task>

<task type="auto">
  <name>Test and verify fix</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Deploy or run the backend and test:
    
    1. Make a POST to /v1/agents/malice/:agentId
    2. Check the response: expires_at should be ~60 minutes in the future
    3. Example: If request at 17:05:00, expires_at should be ~18:05:00
    
    If still showing ~45 seconds, investigate:
    - Is there a different endpoint or code path?
    - Is Cloudflare KV overwriting the value?
    - Is there a cached response?
  </action>
  <verify>Response shows expires_at 60 minutes in future.</verify>
  <done>Challenge TTL is 60 minutes</done>
</task>

</tasks>

<verification>
1. Test shadow claim initiation
2. Verify expires_at is 60 minutes from now
3. Verify no regression in other challenge types
</verification>

<success_criteria>
- Challenge expires in 60 minutes (not 45 seconds)
- Backend correctly calculates and returns expires_at
</success_criteria>

<output>
After completion, create `.planning/phases/25-frontend-update/25-09-SUMMARY.md`
</output>
