---
phase: 28-audit-test-strategy
plan: 03
type: execute
wave: 2
depends_on:
  - 28-01
  - 28-02
files_modified:
  - "docs/v1/test scenarios/COVERAGE_GAPS.md"
  - "docs/v1/test scenarios/TEST_STRATEGY.md"
  - "docs/v1/test scenarios/TEST_SCENARIOS.md"
autonomous: true
must_haves:
  truths:
    - The gap between current codebase tests and documented flows is clearly outlined.
    - The test strategy specifies vitest-pool-workers for backend and Playwright for E2E.
    - A master list of test scenarios to implement is provided for future phases.
  artifacts:
    - path: docs/v1/test scenarios/COVERAGE_GAPS.md
      provides: "Gap analysis between current tests and edge cases"
      min_lines: 20
    - path: docs/v1/test scenarios/TEST_STRATEGY.md
      provides: "vitest+D1 and Playwright instructions"
      contains: "vitest-pool-workers"
    - path: docs/v1/test scenarios/TEST_SCENARIOS.md
      provides: "Master list of test scenarios"
      min_lines: 30
  key_links: []
---

<objective>
Identify the coverage gaps in current testing suites and design the comprehensive test strategy/scenarios.

Purpose: Generate a concrete map of all the testing work that needs to be done in subsequent phases (Phase 29+).
Output: COVERAGE_GAPS.md, TEST_STRATEGY.md, TEST_SCENARIOS.md.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-*/28-CONTEXT.md
@.planning/phases/28-*/28-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify Coverage Gaps</name>
  <files>docs/v1/test scenarios/COVERAGE_GAPS.md</files>
  <action>
    Analyze current test files in `backend/src/services/__tests__` and any `test/` or `tests/` directories at the project root by reading their contents.
    Compare what is currently tested against the full list of edge cases now documented in `docs/v1/flows/*`.
    Create `"docs/v1/test scenarios/COVERAGE_GAPS.md"` detailing the specific testing gaps in Cryptography, Subscription (Paddle), and general Auth flows.
  </action>
  <verify>
    test -f "docs/v1/test scenarios/COVERAGE_GAPS.md" && cat "docs/v1/test scenarios/COVERAGE_GAPS.md" | grep -i "gap"
  </verify>
  <done>
    Coverage gaps are fully documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document Test Strategy</name>
  <files>docs/v1/test scenarios/TEST_STRATEGY.md</files>
  <action>
    Create `"docs/v1/test scenarios/TEST_STRATEGY.md"` according to Phase 28 RESEARCH.md recommendations.
    - Specify using `@cloudflare/vitest-pool-workers` with `applyD1Migrations` for backend integration tests to ensure Web Crypto API parity.
    - Specify using `@playwright/test` with `browser.newContext()` for E2E multi-actor testing.
    - Detail the approach for using direct Webhook injection (like in `SELF.fetch()`) for mocked Paddle webhook testing, as shown in the code examples of RESEARCH.md (but adapted for Paddle instead of Stripe).
  </action>
  <verify>
    test -f "docs/v1/test scenarios/TEST_STRATEGY.md" && cat "docs/v1/test scenarios/TEST_STRATEGY.md" | grep -i "vitest-pool-workers"
  </verify>
  <done>
    Test strategy is established and formally documented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document Master Test Scenarios</name>
  <files>docs/v1/test scenarios/TEST_SCENARIOS.md</files>
  <action>
    Create a master list of new test scenarios required to cover all the identified gaps and edge cases.
    Write this in `"docs/v1/test scenarios/TEST_SCENARIOS.md"`.
    Organize the scenarios by domain (Auth, Subscription, Client) and by testing type (Unit, Integration, E2E).
    This document will serve as the exact roadmap for execution in the next testing phases.
  </action>
  <verify>
    test -f "docs/v1/test scenarios/TEST_SCENARIOS.md" && wc -l < "docs/v1/test scenarios/TEST_SCENARIOS.md"
  </verify>
  <done>
    All necessary test scenarios are documented and organized.
  </done>
</task>

</tasks>

<verification>
ls -la "docs/v1/test scenarios/"
grep "vitest-pool-workers" "docs/v1/test scenarios/TEST_STRATEGY.md"
</verification>

<success_criteria>
Coverage gaps are identified, the comprehensive testing strategy is laid out, and the master list of test scenarios for Phase 29+ is fully written.
</success_criteria>

<output>
After completion, create `.planning/phases/28-audit-test-strategy/28-03-SUMMARY.md`
</output>