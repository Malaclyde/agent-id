---
phase: 28-audit-test-strategy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/v1/flows/agent/agent_authorization.md
  - docs/v1/flows/agent/agent_claim_procedure.md
  - docs/v1/flows/oauth/oauth_requests.md
  - docs/v1/flows/oauth/oauth2_flow.md
autonomous: true
must_haves:
  truths:
    - Auth flows are fully documented in the unified format with Mermaid diagrams.
    - DPoP and Ed25519 cryptographic edge cases are explicitly listed in API traces.
  artifacts:
    - path: docs/v1/flows/agent/agent_claim_procedure.md
      provides: "Detailed API trace for agent claiming"
      contains: "Edge Cases"
    - path: docs/v1/flows/oauth/oauth2_flow.md
      provides: "Detailed API trace for OAuth with DPoP"
      contains: "Edge Cases"
  key_links: []
---

<objective>
Audit and formalize the cryptographic authentication and agent flows in the documentation.

Purpose: To provide a source of truth for all auth edge cases (DPoP, Ed25519) before we start writing tests to cover them.
Output: Standardized flow markdown files with Quick Glance, Mermaid sequence diagrams, and Detailed API Traces.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-*/28-CONTEXT.md
@.planning/phases/28-*/28-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and Rewrite Agent Flows</name>
  <files>docs/v1/flows/agent/agent_authorization.md, docs/v1/flows/agent/agent_claim_procedure.md</files>
  <action>
    Read the existing documentation in `docs/v1/flows/agent/` and cross-reference with `backend/src/services/agent.ts` and `backend/src/services/shadowClaimService.ts`.
    Rewrite both files to match the new strict format:
    1. Quick Glance (short list of steps)
    2. Sequence Diagram (using mermaid)
    3. Detailed API Trace (Endpoint, Request Payload, Response Payload)
    Ensure you explicitly list cryptographic edge cases (Ed25519 signature validation failures, agent claim challenge expirations) under an "Edge Cases" section for each flow.
  </action>
  <verify>
    cat "docs/v1/flows/agent/agent_claim_procedure.md" | grep -i "Edge Cases" && cat "docs/v1/flows/agent/agent_claim_procedure.md" | grep "mermaid"
  </verify>
  <done>
    Agent flows conform to the standard format with edge cases detailed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit and Rewrite OAuth Flows</name>
  <files>docs/v1/flows/oauth/oauth_requests.md, docs/v1/flows/oauth/oauth2_flow.md</files>
  <action>
    Read the existing documentation in `docs/v1/flows/oauth/` and cross-reference with `backend/src/services/oauth-flow.ts` and `backend/src/services/dpop.ts`.
    Rewrite both files to the new strict format:
    1. Quick Glance
    2. Sequence Diagram (using mermaid)
    3. Detailed API Trace
    Explicitly list DPoP cryptographic edge cases (reused nonces/jti, expired iat, mismatched htm/htu) under the "Edge Cases" section.
  </action>
  <verify>
    cat "docs/v1/flows/oauth/oauth2_flow.md" | grep -i "Edge Cases" && cat "docs/v1/flows/oauth/oauth2_flow.md" | grep "mermaid"
  </verify>
  <done>
    OAuth flows conform to the standard format with DPoP edge cases detailed.
  </done>
</task>

</tasks>

<verification>
grep -r "Edge Cases" docs/v1/flows/agent/ docs/v1/flows/oauth/
grep -r "mermaid" docs/v1/flows/agent/ docs/v1/flows/oauth/
</verification>

<success_criteria>
All authentication-related flow documents are upgraded to include Mermaid diagrams and explicit, detailed edge case lists.
</success_criteria>

<output>
After completion, create `.planning/phases/28-audit-test-strategy/28-01-SUMMARY.md`
</output>