---
phase: 27-testing-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/test/unit/shadow-claim-webhook.test.ts
  - backend/test/unit/shadow-claim-race.test.ts
autonomous: true

must_haves:
  truths:
    - Webhook handler correctly processes transaction.completed events
    - Shadow overseer reuse logic works correctly on renewals
    - Concurrent claims on the same agent are handled gracefully
  artifacts:
    - path: backend/test/unit/shadow-claim-webhook.test.ts
      provides: Unit test suite for webhook processing
      min_lines: 80
    - path: backend/test/unit/shadow-claim-race.test.ts
      provides: Unit test suite for race conditions
      min_lines: 40
  key_links:
    - from: backend/test/unit/shadow-claim-webhook.test.ts
      to: backend/src/services/shadowClaimService.ts
      via: processShadowClaimWebhook imports
      pattern: "import.*processShadowClaimWebhook"
---

<objective>
Implement unit tests for webhook processing and race condition handling to ensure system resilience and idempotency.

Purpose: Guarantee that payments correctly activate shadow oversight, handle renewals gracefully, and prevent concurrent claim conflicts.
Output: Comprehensive unit tests covering webhook logic and race conditions.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@docs/v1/requirements/agent/shadow-claim.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for Webhook Handler & Renewals</name>
  <files>backend/test/unit/shadow-claim-webhook.test.ts</files>
  <action>
    Create a new test file `backend/test/unit/shadow-claim-webhook.test.ts`.
    Write Jest unit tests for `processShadowClaimWebhook`:
    - Test that receiving a `transaction.completed` event extracts custom_data and activates oversight.
    - Test that it updates the KV challenge status to `completed`.
    - Test Shadow Overseer Renewal: If the shadow overseer ID exists, ensure it reuses the overseer email/ID and just creates a new active oversight.
    - Test that only one active oversight exists per agent (old ones are deactivated).
    - Test idempotency: processing the same webhook twice results in only one oversight activation.
    Mock DB, KV, and provide mock Paddle webhook payloads.
  </action>
  <verify>Run `npm run test backend/test/unit/shadow-claim-webhook.test.ts` to confirm tests pass.</verify>
  <done>Tests verify webhook data extraction, status updates, renewal logic, uniqueness, and idempotency.</done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for Race Conditions</name>
  <files>backend/test/unit/shadow-claim-race.test.ts</files>
  <action>
    Create a new test file `backend/test/unit/shadow-claim-race.test.ts`.
    Write Jest unit tests to simulate concurrent requests:
    - Test that two concurrent initiation requests for the same agent result in only one active challenge, or both succeed safely without overwriting critically.
    - Test that two concurrent confirmations for the same agent result in the first one winning, and the second one rejecting.
    Mock KV put/get operations with delays to simulate race conditions if necessary.
  </action>
  <verify>Run `npm run test backend/test/unit/shadow-claim-race.test.ts` to confirm tests pass.</verify>
  <done>Tests verify system behavior under concurrent initiation and confirmation load.</done>
</task>

</tasks>

<verification>
- `backend/test/unit/shadow-claim-webhook.test.ts` and `backend/test/unit/shadow-claim-race.test.ts` exist.
- All unit tests pass when run via `npm test`.
</verification>

<success_criteria>
- Unit tests pass with mock dependencies.
- Coverage includes webhook processing, renewal logic, and race condition handling.
</success_criteria>

<output>
After completion, create `.planning/phases/27-testing-verification/27-02-SUMMARY.md`
</output>
