---
phase: 27-testing-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/test/unit/shadow-claim-service.test.ts
autonomous: true

must_haves:
  truths:
    - Shadow claim initiation generates valid challenge with isShadow flag
    - Agent confirmation verifies identity via DPoP
    - Real overseer check prevents shadow claim conflicts
    - Challenge expiration correctly triggers 404/409
  artifacts:
    - path: backend/test/unit/shadow-claim-service.test.ts
      provides: Unit test suite for initiation and confirmation
      min_lines: 100
  key_links:
    - from: backend/test/unit/shadow-claim-service.test.ts
      to: backend/src/services/shadowClaimService.ts
      via: imports and assertions
      pattern: "import.*shadowClaimService"
---

<objective>
Implement core unit tests for shadow claim initiation and agent confirmation flows to ensure basic business logic validity.

Purpose: Guarantee that shadow claims begin securely and agents correctly authorize them.
Output: Comprehensive unit tests covering initiation and confirmation endpoints.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@docs/v1/requirements/agent/shadow-claim.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for shadow claim initiation</name>
  <files>backend/test/unit/shadow-claim-service.test.ts</files>
  <action>
    Create a new test file `backend/test/unit/shadow-claim-service.test.ts`.
    Write Jest unit tests for the initiation flow (`initiateShadowClaim` equivalent):
    - Test that calling initiation creates a challenge in KV with `isShadow: true`.
    - Test that the challenge contains a generated `shadow_overseer_id`.
    - Test that the challenge TTL is set to 60 minutes.
    - Test that initiating on an agent already claimed by a real overseer throws a 409 conflict error.
    Mock KV namespace, DB, and any external service dependencies.
  </action>
  <verify>Run `npm run test backend/test/unit/shadow-claim-service.test.ts` to confirm tests pass.</verify>
  <done>Tests verify `isShadow` flag, `shadow_overseer_id`, 60-minute TTL, and real overseer conflict rejection.</done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for agent confirmation & security</name>
  <files>backend/test/unit/shadow-claim-service.test.ts</files>
  <action>
    Append Jest unit tests to the same file for the agent confirmation flow:
    - Test that valid DPoP proof successfully confirms the challenge.
    - Test that invalid DPoP proof or missing session throws a 401 error.
    - Test that confirming an expired challenge throws a 404 error.
    - Test that an agent rejecting (ignoring) the claim simply lets it expire without action.
    - Test that confirming updates the challenge status to `awaiting-payment`.
    Mock the DPoP validation helper to simulate valid/invalid proofs.
  </action>
  <verify>Run `npm run test backend/test/unit/shadow-claim-service.test.ts` to confirm tests pass.</verify>
  <done>Tests verify DPoP requirement, expiration handling, and state transition to `awaiting-payment`.</done>
</task>

</tasks>

<verification>
- `backend/test/unit/shadow-claim-service.test.ts` exists and contains at least 8 distinct test cases.
- All unit tests pass when run via `npm test`.
</verification>

<success_criteria>
- Unit tests pass with mock dependencies.
- Coverage includes initiation and confirmation logic.
</success_criteria>

<output>
After completion, create `.planning/phases/27-testing-verification/27-01-SUMMARY.md`
</output>
