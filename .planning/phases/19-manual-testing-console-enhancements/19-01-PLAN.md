---
phase: 19-manual-testing-console-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/manual-console/public/js/panes/oauth.js
  - test/manual-console/public/js/state.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see fetched clients from database in OAuth clients pane"
    - "User can click Actions dropdown on a client tile"
    - "User can select Add Keys option for clients without private_key"
    - "User can enter public_key and private_key in input form"
    - "User can save keys and see Keys Loaded indicator"
    - "Keys persist in localStorage for console use across sessions"
  artifacts:
    - path: "test/manual-console/public/js/panes/oauth.js"
      provides: "Client tile rendering with actions dropdown"
      contains: "renderClientTiles, addClientKeys, showAddKeysForm"
    - path: "test/manual-console/public/js/state.js"
      provides: "State persistence with localStorage"
      contains: "saveState, loadStateFromStorage"
  key_links:
    - from: "renderClientTiles()"
      to: "state.oauthClients[i].private_key"
      via: "conditional check for empty string"
      pattern: "private_key.*length"
    - from: "saveClientKeys()"
      to: "localStorage"
      via: "state.oauthClients update + saveState()"
      pattern: "saveState\\(\\)"
---

<objective>
Add client key restoration feature to the OAuth clients pane in test/manual-console. Users can add missing public/private key pairs to clients fetched from the database, enabling the console to sign DPoP challenges.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@test/manual-console/public/js/panes/oauth.js
@test/manual-console/public/js/state.js
@test/manual-console/public/js/api/oauth.js (lines 145-165 show syncClientsFromDb sets private_key to '')

# Understanding the problem:
- syncClientsFromDb() fetches clients from DB but sets private_key to empty string ''
- This prevents DPoP proof generation for fetched clients
- Users need a way to manually add keys back to enable OAuth flows
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Actions dropdown to client tiles with Add Keys option</name>
  <files>test/manual-console/public/js/panes/oauth.js</files>
  <action>
    Modify renderClientTiles() function to add an Actions dropdown to each client tile:

    1. Add clickable "Actions" button to each client tile that opens a dropdown
    2. In the dropdown, show "Add Keys" option ONLY when client.private_key is empty or falsy
    3. Show "Keys Loaded" indicator (green checkmark) when client.private_key exists and is non-empty
    4. Use the existing tile structure - add actions button in tile-header next to the status badge
    5. Create inline dropdown (not modal) - similar to other dropdowns in the console

    IMPORTANT: Do NOT modify api/oauth.js syncClientsFromDb - keys remain empty after DB sync by design
  </action>
  <verify>
    - Open manual console OAuth pane
    - Click "Refresh" to sync clients from DB
    - Verify client tiles show "Actions" button
    - Verify "Add Keys" appears in dropdown for clients without keys
    - Verify "Keys Loaded" indicator shows for clients with keys
  </verify>
  <done>
    Client tiles display Actions dropdown with conditional "Add Keys" option
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement key input form and localStorage storage</name>
  <files>test/manual-console/public/js/panes/oauth.js</files>
  <action>
    Implement key input form and storage functions:

    1. Create showAddKeysForm(clientIndex) function that:
       - Displays inline form below the client tile (not modal)
       - Two textarea inputs: public_key and private_key
       - Use plain text inputs (not masked - per user discretion to see keys)
       - Add basic validation: keys must be non-empty base64-like strings
       - "Save Keys" button and "Cancel" button

    2. Create saveClientKeys(clientIndex, publicKey, privateKey) function that:
       - Validates input (non-empty, reasonable length)
       - Updates state.oauthClients[clientIndex].public_key and .private_key
       - Calls saveState() to persist to localStorage
       - Re-renders client tiles to show "Keys Loaded" indicator
       - Logs success/error message

    3. Use existing log() function for user feedback

    Storage approach: Keys stored in state.oauthClients array and persisted via existing saveState() localStorage mechanism - no separate localStorage key needed
  </action>
  <verify>
    - Click "Add Keys" on a client without keys
    - Verify inline form appears with two textarea fields
    - Paste public_key and private_key values
    - Click "Save Keys"
    - Verify "Keys Loaded" indicator appears
    - Refresh page and verify keys persist
  </verify>
  <done>
    User can input and save keys via inline form that persists to localStorage
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify complete functionality with DPoP flow</name>
  <files>test/manual-console/public/js/panes/oauth.js</files>
  <action>
    Verify the complete key restoration workflow:

    1. Test complete flow:
       - Sync clients from DB (keys are empty)
       - Add keys to a client via Actions dropdown
       - Verify "Keys Loaded" indicator shows
       - Attempt OAuth authorize flow using that client
       - Verify DPoP proof generation works with restored keys

    2. Check that api/oauth.js generateDPoPProofForUserinfo() (line 77) can use the restored keys

    3. Ensure the feature works correctly:
       - Keys persist across page refreshes (localStorage)
       - Multiple clients can have different keys
       - Clients synced from DB retain their added keys (until next sync overwrites)
    </action>
  <verify>
    - Run full OAuth flow test:
      1. Sync clients from DB
      2. Add keys to a client
      3. Select that client in Authorization section
      4. Complete authorize flow
      5. Exchange token
      6. Verify DPoP proof generated successfully
  </verify>
  <done>
    Complete key restoration feature works end-to-end - keys can be added, saved, persist, and enable DPoP OAuth flows
  </done>
</task>

</tasks>

<verification>
- Client tiles show Actions dropdown
- "Add Keys" option only appears for clients without private_key
- "Keys Loaded" indicator shows for clients with keys
- Keys can be entered and saved via inline form
- Keys persist in localStorage across page refreshes
- OAuth flows work with restored keys (DPoP proof generation)
</verification>

<success_criteria>
1. User can add keys to clients fetched from database
2. Keys stored in localStorage (not database) - no backend changes
3. "Keys Loaded" indicator shows for clients with restored keys
4. DPoP OAuth flows work with restored keys
5. All existing functionality preserved (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/19-manual-testing-console-enhancements/19-01-SUMMARY.md`
</output>
