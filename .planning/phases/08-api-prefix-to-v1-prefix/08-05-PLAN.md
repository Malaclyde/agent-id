---
phase: 08-api-prefix-to-v1-prefix
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/test/integration/utils/database.js
  - frontend/test/integration/utils/paddle-sandbox.js
  - frontend/test/integration/scripts/check-services.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Integration test utilities use backend /v1/* API paths"
    - "Integration tests call backend API (port 8787) with /v1 prefix"
  artifacts:
    - path: "frontend/test/integration/utils/database.js"
      contains: "http://localhost:8787"
      contains: "'/v1/overseers'"
      not_contains: "'/api/overseers'"
    - path: "frontend/test/integration/utils/paddle-sandbox.js"
      contains: "'/v1/subscriptions/me'"
      not_contains: "'/api/subscriptions/me'"
    - path: "frontend/test/integration/scripts/check-services.js"
      not_contains: "'/api/stats'"
  key_links:
    - from: "frontend/test/integration/utils/database.js"
      to: "backend/src/index.ts"
      via: "HTTP requests to localhost:8787"
      pattern: "http://localhost:8787/v1/"
---

<objective>
Fix integration test utilities to use backend /v1 API paths

Purpose: Update integration test utilities to call the backend API (port 8787) using /v1 prefix instead of calling non-existent /api endpoints on the manual console (port 8788)
Output: Integration test utilities using backend /v1/* API paths
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-api-prefix-to-v1-prefix/08-CONTEXT.md
@.planning/phases/08-api-prefix-to-v1-prefix/08-01-SUMMARY.md
@.planning/phases/08-api-prefix-to-v1-prefix/08-VERIFICATION.md

Gap source: 08-VERIFICATION.md - "Frontend integration test utilities still use /api/* paths"

The manual testing console (port 8788) is a separate service with different endpoints (/overseer/:id, /test-data/load, etc.). The integration test utilities should call the backend API (port 8787) using /v1 prefix, not the manual console.
</context>

<tasks>

<task type="auto">
  <name>Update integration test database utilities to use backend /v1 API</name>
  <files>frontend/test/integration/utils/database.js</files>
  <action>
  Update the test database utilities to call the backend API (port 8787) with /v1 prefix instead of the manual console (port 8788) with /api prefix:

  Step 1: Verify endpoint existence
  First, check if the backend has /v1/test-data/load and /v1/stats endpoints:
  ```bash
  curl -s http://localhost:8787/v1/test-data/load 2>&1 | head -1
  curl -s http://localhost:8787/v1/stats 2>&1 | head -1
  ```
  
  Step 2: Change TEST_BACKEND_URL
  Change TEST_BACKEND_URL from 'http://localhost:8788' to 'http://localhost:8787'

  Step 3: Update all endpoint paths from /api/* to /v1/*:
  - Line 43: Change '/api/overseers' to '/v1/overseers'
  - Line 64: Change `/api/overseers/${id}` to `/v1/overseers/${id}`
  - Line 81: Change '/api/overseers' to '/v1/overseers'
  - Line 99: Change `/api/overseers/${overseer.id}` to `/v1/overseers/${overseer.id}`
  - Line 117: Change `/api/overseers/${overseer.id}` to `/v1/overseers/${overseer.id}`
  - Line 154: Change '/api/health' to '/health' (backend root endpoint)

  Step 4: Handle /v1/test-data/load and /v1/stats endpoints
  If backend DOES have /v1/test-data/load endpoint:
    - Line 133: Change '/api/test-data/load' to '/v1/test-data/load'
  If backend DOES NOT have /v1/test-data/load endpoint:
    - Remove the loadTestData function (lines ~127-138)
    - Replace any calls to loadTestData with direct Prisma operations in test files
    - Update test files to use direct DB operations for test data setup
  
  If backend DOES have /v1/stats endpoint:
    - Line 144: Change '/api/stats' to '/v1/stats'
  If backend DOES NOT have /v1/stats endpoint:
    - Remove the getStats function (lines ~140-150)
    - If tests need stats data, implement direct DB query or mock the response
  
  Reference: Plan 08-01 migrated all backend routes to /v1 prefix (agents, overseers, clients, subscriptions, webhooks, oauth)
  Gap reason: "Multiple calls to /api/overseers, /api/test-data/*, /api/stats - these endpoints don't exist"
  </action>
  <verify>
    grep -n "'/api/" frontend/test/integration/utils/database.js 2>&1
    Expected output: No /api/ paths found
    
    grep "TEST_BACKEND_URL = 'http://localhost:8787'" frontend/test/integration/utils/database.js 2>&1
    Expected output: Backend URL set to 8787
    
    grep -n "'/v1/" frontend/test/integration/utils/database.js 2>&1 | head -5
    Expected output: Multiple /v1/ path matches
    
    grep -n "loadTestData\|getStats" frontend/test/integration/utils/database.js 2>&1
    Expected output: Functions either removed or using /v1 endpoints (no /api in function calls)
  </verify>
  <done>All integration test utilities call backend API (port 8787) using /v1/* paths; loadTestData and getStats either use /v1 endpoints if they exist, or are replaced with direct DB operations</done>
</task>

<task type="auto">
  <name>Update paddle-sandbox utility to use /v1 prefix</name>
  <files>frontend/test/integration/utils/paddle-sandbox.js</files>
  <action>
  Update the paddle-sandbox utility to use /v1 prefix for API calls:

  Line 415: Change '/api/subscriptions/me' to '/v1/subscriptions/me'
  
  This ensures the utility calls the correct backend endpoint for fetching current subscription.
  
  Reference: Plan 08-01 created /v1/subscriptions route; Plan 08-02 updated frontend client to use /v1/subscriptions/* paths
  Gap reason: "Call to /api/subscriptions/me (line 415) should be /v1/subscriptions/me"
  </action>
  <verify>
    grep -n "'/api/subscriptions/me'" frontend/test/integration/utils/paddle-sandbox.js 2>&1
    Expected output: No matches
    
    grep -n "'/v1/subscriptions/me'" frontend/test/integration/utils/paddle-sandbox.js 2>&1
    Expected output: 1 match at line 415
  </verify>
  <done>Paddle-sandbox utility uses /v1/subscriptions/me endpoint</done>
</task>

<task type="auto">
  <name>Update check-services script to use /v1 prefix</name>
  <files>frontend/test/integration/scripts/check-services.js</files>
  <action>
  Update the check-services script to handle /v1 prefix correctly:

  Step 1: Verify if /v1/stats exists on backend
  Run: curl -s http://localhost:8787/v1/stats 2>&1 | head -1
  
  Step 2: Based on verification result:
  
  If backend HAS /v1/stats endpoint:
    - Line 31: Change path: '/api/stats' to path: '/v1/stats'
    - This will check the backend's stats endpoint instead of the non-existent manual console endpoint
  
  If backend DOES NOT have /v1/stats endpoint:
    - Remove the entire stats check block (lines ~30-35)
    - The script should only check the endpoints that actually exist
    - Alternative: Change to check /v1/overseers or /v1/subscriptions instead if those endpoints exist
  
  Note: The check-services script currently checks the manual testing console (port 8788) which is a separate service. Since we're migrating to /v1 prefix, this script should either:
  - Check the backend (port 8787) using /v1 paths
  - Remove checks for non-existent endpoints
  
  Gap reason: "Call to /api/stats should be /v1/stats or removed"
  </action>
  <verify>
    grep -n "'/api/" frontend/test/integration/scripts/check-services.js 2>&1
    Expected output: No /api/ paths found
    
    grep -n "'/v1/" frontend/test/integration/scripts/check-services.js 2>&1
    Expected output: /v1/ paths used OR no output (endpoint check removed)
  </verify>
  <done>Check-services script either uses /v1/stats (if endpoint exists) or removes the endpoint check entirely</done>
</task>

</tasks>

<verification>
After completion, run:
```bash
# Verify no /api/ paths remain in integration test utilities
grep "'/api/" frontend/test/integration/utils/*.js
# Expected: No matches

# Verify backend URL is used in database.js
grep "TEST_BACKEND_URL" frontend/test/integration/utils/database.js
# Expected: http://localhost:8787

# Verify /v1/ paths are used
grep "'/v1/" frontend/test/integration/utils/*.js
# Expected: Multiple matches

# Verify loadTestData and getStats are properly handled
grep "loadTestData\|getStats" frontend/test/integration/utils/database.js
# Expected: Functions either removed or using /v1 endpoints (no /api in output)
```
</verification>

<success_criteria>
All integration test utilities use backend API (port 8787) with /v1/* paths; non-existent endpoint calls are either updated to /v1 endpoints or replaced with direct DB operations; no /api/* paths remain
</success_criteria>

<output>
After completion, create `.planning/phases/08-api-prefix-to-v1-prefix/08-05-SUMMARY.md`
</output>
