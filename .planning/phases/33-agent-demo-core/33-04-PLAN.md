---
phase: 33-agent-demo-core
plan: 04
type: execute
wave: 4
depends_on: [33-03]
files_modified: [demos/agent_demo.py]
autonomous: true
must_haves:
  truths:
    - "User can log in with agent_id and DPoP proof"
    - "Login returns session_id and expires_in"
    - "User can log out with session_id"
    - "Logout revokes the session"
    - "User can query agent info with session_id"
    - "Agent info returns agent object with id, name, description"
  artifacts:
    - path: "demos/agent_demo.py"
      provides: "Authentication operations"
      exports: ["login_agent", "logout_agent", "get_agent_info"]
  key_links:
    - from: "login_agent"
      to: "/api/agents/login"
      via: "DPoP header"
      pattern: "'DPoP':"
    - from: "logout_agent"
      to: "/api/agents/logout"
      via: "Bearer token"
      pattern: "'Authorization':.*Bearer"
    - from: "get_agent_info"
      to: "/api/agents/me"
      via: "Bearer token"
      pattern: "/agents/me"
---

<objective>
Implement authentication operations: login with DPoP proof, logout with session revocation, and agent info query. These complete the basic authentication flow after registration.

Purpose: Login establishes a session for subsequent operations. Logout and agent info provide session management capabilities.

Output: Working login, logout, and agent info functions (AAUTH-02, AAUTH-03, AAUTH-04).
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-agent-demo-core/33-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement DPoP-based login</name>
  <files>demos/agent_demo.py</files>
  <action>
Add the login function to `demos/agent_demo.py`:

**`login_agent(backend_url: str, agent_id: str, private_key: SigningKey) -> dict`:**

1. Build login URL: `{backend_url}/api/agents/login`

2. Normalize URL for DPoP HTU:
   ```python
   from urllib.parse import urlparse
   parsed = urlparse(login_url)
   normalized_htu = f'{parsed.scheme}://{parsed.netloc}{parsed.path}'
   ```
   This strips query params and trailing slashes.

3. Create DPoP proof using `create_dpop_proof(private_key, 'POST', normalized_htu)`

4. Make POST request:
   - URL: `{backend_url}/api/agents/login`
   - Body: `{'agent_id': agent_id}`
   - Headers: `{'Content-Type': 'application/json', 'DPoP': dpop_proof}`

5. Parse response:
   - Returns `{session_id: string, expires_in: number}`
   - `expires_in` is typically 1800 (30 minutes)

6. Handle errors:
   - HTTP 401: Invalid agent_id or proof
   - HTTP 400: DPoP proof validation failed

CRITICAL: The DPoP header name is exactly `'DPoP'` (case-sensitive). The HTU must be normalized without query params.
  </action>
  <verify>
    ```bash
    cd demos && python3 -c "
    from agent_demo import login_agent, create_dpop_proof
    from nacl.signing import SigningKey
    import inspect
    
    # Test login_agent signature
    sig = inspect.signature(login_agent)
    params = list(sig.parameters.keys())
    assert 'backend_url' in params
    assert 'agent_id' in params
    assert 'private_key' in params
    
    # Test DPoP proof creation for login URL
    sk = SigningKey.generate()
    proof = create_dpop_proof(sk, 'POST', 'https://example.com/api/agents/login')
    parts = proof.split('.')
    assert len(parts) == 3  # JWT format
    
    print('Login function verified')
    "
    ```
  </verify>
  <done>login_agent function implemented. Uses DPoP proof for authentication, returns session_id and expires_in.</done>
</task>

<task type="auto">
  <name>Task 2: Implement logout and agent info</name>
  <files>demos/agent_demo.py</files>
  <action>
Add logout and agent info functions to `demos/agent_demo.py`:

1. **`logout_agent(backend_url: str, session_id: str) -> bool`:**
   - Make POST request to `{backend_url}/api/agents/logout`
   - Headers: `{'Authorization': f'Bearer {session_id}'}`
   - No body required
   - Returns True on success, False on failure
   - Parse response `{success: bool, message: string}`

2. **`get_agent_info(backend_url: str, session_id: str) -> dict`:**
   - Make GET request to `{backend_url}/api/agents/me`
   - Headers: `{'Authorization': f'Bearer {session_id}'}`
   - Returns `{agent: {id, name, description, created_at, ...}}`
   - Handle 401 for expired/invalid session

Both functions should:
- Use `urllib.request.Request` with appropriate method
- Handle `urllib.error.HTTPError` for error responses
- Parse JSON response body
- Return meaningful results or raise exceptions

IMPORTANT: These endpoints use Bearer token authentication (session_id), NOT DPoP. Only /agents/login uses DPoP.
  </action>
  <verify>
    ```bash
    cd demos && python3 -c "
    from agent_demo import logout_agent, get_agent_info
    import inspect
    
    # Test logout_agent signature
    sig = inspect.signature(logout_agent)
    params = list(sig.parameters.keys())
    assert 'backend_url' in params
    assert 'session_id' in params
    
    # Test get_agent_info signature
    sig2 = inspect.signature(get_agent_info)
    params2 = list(sig2.parameters.keys())
    assert 'backend_url' in params2
    assert 'session_id' in params2
    
    print('Logout and agent info functions verified')
    "
    ```
  </verify>
  <done>logout_agent and get_agent_info functions implemented. Use Bearer token authentication with session_id.</done>
</task>

</tasks>

<verification>
1. Run verification commands in Task 1 and Task 2
2. Verify login uses DPoP header, not Bearer token
3. Verify logout and agent info use Bearer token, not DPoP
</verification>

<success_criteria>
- login_agent creates DPoP proof and POSTs to /api/agents/login
- DPoP HTU is normalized (no query params, no trailing slash)
- logout_agent POSTs to /api/agents/logout with Bearer token
- get_agent_info GETs /api/agents/me with Bearer token
- All functions handle HTTP errors appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/33-agent-demo-core/33-04-SUMMARY.md`
</output>
