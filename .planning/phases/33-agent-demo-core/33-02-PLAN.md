---
phase: 33-agent-demo-core
plan: 02
type: execute
wave: 2
depends_on: [33-01]
files_modified: [demos/agent_demo.py, demos/.env.agent]
autonomous: true
must_haves:
  truths:
    - "User can load configuration from .env.agent file"
    - "User can save configuration to .env.agent file"
    - "Script validates public key derives from private key on load"
    - "Configuration includes backend_url, private_key, public_key, agent_id, session_id"
  artifacts:
    - path: "demos/agent_demo.py"
      provides: "Configuration management functions"
      exports: ["load_config", "save_config", "validate_config"]
    - path: "demos/.env.agent"
      provides: "Configuration file for agent demo"
  key_links:
    - from: "load_config"
      to: ".env.agent"
      via: "python-dotenv"
      pattern: "load_dotenv"
    - from: "validate_config"
      to: "validate_keys_match"
      via: "ACONF-03 validation"
      pattern: "validate_keys_match\\("
---

<objective>
Implement configuration management for the agent demo script using python-dotenv to read/write the .env.agent file. Include validation that ensures public key derives from private key.

Purpose: Configuration is required before any authentication operations. The .env file persists agent credentials between script runs.

Output: Working configuration load/save with key validation (ACONF-01, ACONF-02, ACONF-03).
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-agent-demo-core/33-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement .env file handling</name>
  <files>demos/agent_demo.py</files>
  <action>
Add the following configuration functions to `demos/agent_demo.py`:

1. **Constants:**
   ```python
   ENV_FILE = '.env.agent'
   
   ENV_KEYS = {
       'backend_url': 'AGENT_BACKEND_URL',
       'private_key': 'AGENT_PRIVATE_KEY',
       'public_key': 'AGENT_PUBLIC_KEY',
       'agent_id': 'AGENT_ID',
       'session_id': 'AGENT_SESSION_ID'
   }
   ```

2. **`load_config(env_file: str = ENV_FILE) -> dict`:**
   - Use `python-dotenv.load_dotenv(env_file)` to load environment
   - Read each key from `os.getenv()`
   - Return dict with all config values (None for missing keys)
   - Include validation if both keys present

3. **`save_config(config: dict, env_file: str = ENV_FILE)`:**
   - Use `python-dotenv.set_key(env_file, key, value)` for each non-None value
   - Map internal keys to env var names using ENV_KEYS
   - Create file if it doesn't exist

4. **`validate_config(config: dict) -> tuple[bool, str]`:**
   - Check backend_url is set
   - Check private_key is set
   - Check public_key is set
   - If both keys present, call `validate_keys_match()` (ACONF-03)
   - Return `(True, "OK")` or `(False, "error message")`

5. **Add imports:**
   ```python
   import os
   from dotenv import load_dotenv, set_key
   ```

CRITICAL: The validation that public key derives from private key (ACONF-03) must happen on config load, not just on key generation.
  </action>
  <verify>
    ```bash
    cd demos && python3 -c "
    import os
    from agent_demo import generate_keypair, load_config, save_config, validate_config
    
    # Create test config
    priv, pub = generate_keypair()
    test_config = {
        'backend_url': 'https://test.example.com',
        'private_key': priv,
        'public_key': pub
    }
    
    # Test save
    save_config(test_config, '.env.test')
    assert os.path.exists('.env.test')
    
    # Test load
    loaded = load_config('.env.test')
    assert loaded['backend_url'] == 'https://test.example.com'
    assert loaded['private_key'] == priv
    assert loaded['public_key'] == pub
    
    # Test validation - valid config
    valid, msg = validate_config(loaded)
    assert valid == True, f'Expected valid, got: {msg}'
    
    # Test validation - mismatched keys
    priv2, pub2 = generate_keypair()
    bad_config = {**loaded, 'public_key': pub2}
    valid, msg = validate_config(bad_config)
    assert valid == False
    assert 'do not match' in msg.lower() or 'mismatch' in msg.lower()
    
    # Cleanup
    os.remove('.env.test')
    print('All configuration tests passed')
    "
    ```
  </verify>
  <done>Configuration functions implemented. load_config reads .env file, save_config writes .env file, validate_config checks keys match (ACONF-03).</done>
</task>

<task type="auto">
  <name>Task 2: Create initial .env.agent template</name>
  <files>demos/.env.agent.example</files>
  <action>
Create `demos/.env.agent.example` as a template file with commented placeholders:

```env
# Agent Demo Configuration
# Copy this file to .env.agent and fill in values

# Backend API URL
AGENT_BACKEND_URL=https://your-backend.example.com

# Ed25519 keypair (base64url encoded, no padding)
# Generate with: python agent_demo.py generate-keys
AGENT_PRIVATE_KEY=
AGENT_PUBLIC_KEY=

# Agent ID (assigned during registration)
AGENT_ID=

# Session ID (from login, expires in 30 minutes)
AGENT_SESSION_ID=
```

This serves as documentation for users setting up the demo script.

Also add `.env.agent` to `.gitignore` if not already present (to avoid committing secrets).
  </action>
  <verify>
    ```bash
    cd demos && test -f .env.agent.example && echo "Template exists" && grep -q "AGENT_PRIVATE_KEY" .env.agent.example && echo "Contains expected keys"
    ```
  </verify>
  <done>Template file created with all required configuration keys documented.</done>
</task>

</tasks>

<verification>
1. Run verification commands in Task 1 and Task 2
2. Test full round-trip: generate keys -> save config -> load config -> validate
3. Verify .gitignore includes .env.agent
</verification>

<success_criteria>
- load_config reads all config keys from .env.agent
- save_config writes all non-None values to .env.agent
- validate_config returns False with error message when keys don't match (ACONF-03)
- .env.agent.example template created with documentation
</success_criteria>

<output>
After completion, create `.planning/phases/33-agent-demo-core/33-02-SUMMARY.md`
</output>
