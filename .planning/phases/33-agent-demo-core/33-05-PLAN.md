---
phase: 33-agent-demo-core
plan: 05
type: execute
wave: 5
depends_on: [33-04]
files_modified: [demos/agent_demo.py]
autonomous: false
must_haves:
  truths:
    - "User can run 'python agent_demo.py generate-keys' to create keypair"
    - "User can run 'python agent_demo.py register --name X' to register agent"
    - "User can run 'python agent_demo.py login' to authenticate"
    - "User can run 'python agent_demo.py info' to see agent details"
    - "User can run 'python agent_demo.py logout' to end session"
    - "All commands save results to .env.agent for persistence"
  artifacts:
    - path: "demos/agent_demo.py"
      provides: "CLI interface"
      contains: "argparse"
      exports: ["main"]
  key_links:
    - from: "CLI command"
      to: "corresponding function"
      via: "argparse subparsers"
      pattern: "subparsers.add_parser"
    - from: "command result"
      to: ".env.agent"
      via: "save_config"
      pattern: "save_config\\("
---

<objective>
Implement the CLI interface using argparse that exposes all agent demo functionality as subcommands. Add a final human verification checkpoint to test the complete flow end-to-end.

Purpose: The CLI is the user interface for the demo script. All previous functions are wired together through commands.

Output: Working CLI with all commands and verified end-to-end flow.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-agent-demo-core/33-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement argparse CLI</name>
  <files>demos/agent_demo.py</files>
  <action>
Add a complete CLI to `demos/agent_demo.py` using argparse:

1. **Main entry point:**
   ```python
   def main():
       parser = argparse.ArgumentParser(
           description='Agent-ID Demo Script',
           formatter_class=argparse.RawDescriptionHelpFormatter
       )
       subparsers = parser.add_subparsers(dest='command', help='Available commands')
       
       # Add subcommands...
       
       args = parser.parse_args()
       
       if args.command is None:
           parser.print_help()
           return
       
       # Dispatch to command handlers
       ...
   
   if __name__ == '__main__':
       main()
   ```

2. **Subcommands to implement:**

   **`generate-keys`:**
   - Generate new Ed25519 keypair
   - Save to .env.agent
   - Print public key for user reference
   - No arguments required

   **`register --name NAME [--description DESC]`:**
   - Load config (needs backend_url and keys)
   - Validate config (keys match)
   - Call `register_agent()`
   - Save agent_id and session_id to config
   - Print agent details

   **`login`:**
   - Load config (needs backend_url, private_key, agent_id)
   - Call `login_agent()`
   - Save session_id to config
   - Print session info

   **`logout`:**
   - Load config (needs backend_url, session_id)
   - Call `logout_agent()`
   - Clear session_id from config
   - Print confirmation

   **`info`:**
   - Load config (needs backend_url, session_id)
   - Call `get_agent_info()`
   - Print agent details (id, name, description, created_at)

   **`config`:**
   - Load and display current config (mask private key)
   - Show validation status

3. **Error handling:**
   - Print user-friendly error messages
   - Exit with code 1 on error
   - Exit with code 0 on success

4. **Output formatting:**
   - Use `json.dumps()` for structured output
   - Print key information clearly
   - Include success/error indicators
  </action>
  <verify>
    ```bash
    cd demos && python3 agent_demo.py --help
    cd demos && python3 agent_demo.py generate-keys --help
    cd demos && python3 agent_demo.py register --help
    cd demos && python3 agent_demo.py login --help
    cd demos && python3 agent_demo.py logout --help
    cd demos && python3 agent_demo.py info --help
    cd demos && python3 agent_demo.py config --help
    ```
  </verify>
  <done>CLI implemented with all subcommands. Each command has help text and properly calls the corresponding function.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete agent demo CLI script with:
- `generate-keys` - Ed25519 keypair generation
- `register` - Agent registration with challenge-response
- `login` - DPoP-based authentication
- `logout` - Session revocation
- `info` - Agent info query
- `config` - Configuration display

All operations persist state to `.env.agent` file.
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Backend must be running at a known URL
2. Have a terminal ready

**Test Steps:**

1. **Navigate to demos directory:**
   ```bash
   cd demos
   ```

2. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Configure backend URL:**
   ```bash
   # Edit .env.agent and set AGENT_BACKEND_URL to your backend
   echo "AGENT_BACKEND_URL=http://localhost:8787" > .env.agent
   ```

4. **Generate keys:**
   ```bash
   python3 agent_demo.py generate-keys
   ```
   Expected: Keys generated and saved. Public key displayed.

5. **Register agent:**
   ```bash
   python3 agent_demo.py register --name "Test Agent" --description "Demo agent"
   ```
   Expected: Agent registered. Agent ID and session saved.

6. **Get agent info:**
   ```bash
   python3 agent_demo.py info
   ```
   Expected: Agent details displayed (id, name, description).

7. **Logout:**
   ```bash
   python3 agent_demo.py logout
   ```
   Expected: Session revoked. Session ID cleared.

8. **Login again:**
   ```bash
   python3 agent_demo.py login
   ```
   Expected: New session created. Session ID saved.

9. **Verify config persistence:**
   ```bash
   python3 agent_demo.py config
   ```
   Expected: All config values displayed (private key masked).
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. Run `python3 agent_demo.py --help` to verify CLI structure
2. Run each subcommand's help to verify argument parsing
3. Follow human verification checkpoint for end-to-end testing
</verification>

<success_criteria>
- All 6 CLI commands implemented with proper help text
- `generate-keys` creates and saves keypair
- `register` performs two-step registration and saves agent_id
- `login` creates DPoP proof and saves session_id
- `logout` revokes session and clears session_id
- `info` displays agent details
- `config` shows current configuration
- End-to-end flow verified by user
</success_criteria>

<output>
After completion, create `.planning/phases/33-agent-demo-core/33-05-SUMMARY.md`
</output>
