---
phase: 03-paddle-integration-fix
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/overseers.ts
  - backend/src/services/subscription.ts
autonomous: true

must_haves:
  truths:
    - "/me endpoint returns subscription information from Paddle"
    - "Paddle is the single source of truth for subscription data"
    - "Subscription info returned even if not cached locally"
  artifacts:
    - path: "backend/src/routes/overseers.ts"
      provides: "/me endpoint with subscription data"
      contains: "getActiveSubscription"
    - path: "backend/src/services/subscription.ts"
      provides: "Subscription query logic with Paddle fallback"
      contains: "getSubscriptionFromPaddle"
---

<objective>
Fix the /me endpoint to include subscription information queried directly from Paddle API.

Purpose: Currently /me returns only basic overseer info without subscription. Users expect /me to include their subscription tier and limits. Per locked decision: "Paddle is the single source of truth" and "/me endpoint must query Paddle customer API directly".

Output: Updated /me endpoint returning subscription data from Paddle
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-paddle-integration-fix/03-CONTEXT.md
@.planning/phases/03-paddle-integration-fix/03-RESEARCH.md

# Key source files
@backend/src/routes/overseers.ts
@backend/src/services/subscription.ts
@backend/src/routes/subscriptions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subscription query to /me endpoint</name>
  <files>backend/src/routes/overseers.ts</files>
  <action>
    Modify the GET /me endpoint (line 111-131) to include subscription information from Paddle.

    Currently returns:
    ```typescript
    return c.json({
      success: true,
      overseer: {
        id: overseer.id,
        name: overseer.name,
        email: overseer.email,
        created_at: overseer.created_at,
      },
    });
    ```

    Change to include subscription by calling getActiveSubscription:
    1. Import getActiveSubscription from '../services/subscription'
    2. Add subscription to the response:
    ```typescript
    const subscription = await getActiveSubscription(c.env.DB, overseerId, c.env);
    
    return c.json({
      success: true,
      overseer: {
        id: overseer.id,
        name: overseer.name,
        email: overseer.email,
        created_at: overseer.created_at,
        paddle_customer_id: overseer.paddle_customer_id,
        paddle_subscription_id: overseer.paddle_subscription_id,
      },
      subscription: {
        tier_id: subscription.tier_id,
        is_free_tier: subscription.is_free_tier,
        num_allowed_agents: subscription.num_allowed_agents,
        num_allowed_requests: subscription.num_allowed_requests,
        num_allowed_registrations: subscription.num_allowed_registrations,
      },
    });
    ```

    This satisfies the locked decision: "Paddle is the single source of truth" and "/me endpoint must query Paddle customer API directly".
  </action>
  <verify>
    grep -n "getActiveSubscription" backend/src/routes/overseers.ts
  </verify>
  <done>
    /me endpoint returns subscription info from Paddle
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify subscription service queries Paddle as fallback</name>
  <files>backend/src/services/subscription.ts</files>
  <action>
    Verify that getActiveSubscription correctly queries Paddle when local DB has no subscription record.

    The current implementation (line 62-122) should:
    1. Check for paddle_subscription_id in overseers table
    2. If exists, query Paddle API for subscription details
    3. If not exists but is shadow overseer, query Paddle for payment transactions
    4. Return FREE tier defaults only if no Paddle data exists

    Verify the function:
    - Line 106-110: If no paddle_subscription_id, returns FREE tier (correct for non-shadow)
    - Line 110-115: Queries Paddle for subscription if paddle_subscription_id exists
    - Line 84-103: For shadow overseers, queries Paddle for transaction validity

    This is already implemented correctly. Just verify it's working as expected per the locked decision: "No local DB caching for subscription data".
  </action>
  <verify>
    grep -n "getSubscriptionFromPaddle\|isShadowPaymentValid" backend/src/services/subscription.ts
  </verify>
  <done>
    Subscription service queries Paddle as source of truth
  </done>
</task>

</tasks>

<verification>
1. /me endpoint includes subscription information in response
2. Subscription data comes from Paddle (not local cache)
3. FREE tier returned only when Paddle has no data
4. Both paddle_subscription_id and paddle_customer_id included in response
</verification>

<success_criteria>
- /me endpoint returns subscription tier and limits from Paddle
- Paddle is queried directly, not from local DB cache
- Subscription info returned even if not cached locally
- Response includes both overseer info and subscription info
</success_criteria>

<output>
After completion, create `.planning/phases/03-paddle-integration-fix/03-03-SUMMARY.md`
</output>
