---
phase: 03-paddle-integration-fix
plan: "04"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/redacted/webhook-security.ts
  - backend/src/routes/webhooks.ts
autonomous: true

must_haves:
  truths:
    - "Manual webhook signature verification is retained (SDK doesn't provide it)"
    - "Signature verification works correctly with h1= format"
    - "All necessary webhook event types are handled"
  artifacts:
    - path: "backend/src/redacted/webhook-security.ts"
      provides: "Working manual signature verification"
    - path: "backend/src/routes/webhooks.ts"
      provides: "Webhook event handlers"
---

<objective>
Clarify and verify that manual webhook signature verification is retained (as SDK doesn't provide it) while fixing the implementation to work correctly.

Purpose: PADDLE-FIX-06 states "Remove manual signature validation, use Paddle library tools" but research shows Paddle SDK doesn't provide webhook signature verification. The manual approach is correct and necessary. This plan clarifies and ensures it works.

Output: Verified working webhook system with proper signature handling
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-paddle-integration-fix/03-RESEARCH.md
@backend/src/redacted/webhook-security.ts
@backend/src/routes/webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document why manual verification is retained</name>
  <files>backend/src/redacted/webhook-security.ts</files>
  <action>
    Add a comment at the top of verifyPaddleSignature explaining why manual verification is used:

    ```typescript
    /**
     * Verify Paddle webhook signature
     * 
     * NOTE: Paddle's official SDK (@paddle/paddle-node-sdk) does NOT provide
     * webhook signature verification. This manual HMAC-SHA256 implementation
     * is the official way to verify Paddle webhooks per their documentation:
     * https://developer.paddle.com/webhooks/signature-verification
     * 
     * We use manual verification (not community packages) to:
     * 1. Avoid additional dependencies
     * 2. Have full control over the implementation
     * 3. Match Paddle's official recommended approach
     */
    ```

    This clarifies PADDLE-FIX-06 - we ARE using manual verification but it's the correct approach per Paddle's own documentation.
  </action>
  <verify>
    grep -n "Paddle's official SDK" backend/src/redacted/webhook-security.ts
  </verify>
  <done>
    Documentation explains manual verification is required (not a bug)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify all necessary webhook events are handled</name>
  <files>backend/src/routes/webhooks.ts</files>
  <action>
    Verify the webhook handler handles all necessary event types per the locked decision: "Handle only events necessary for our subscription flows".

    Current event handlers (line 109-140):
    - customer.created → handleCustomerCreated ✅
    - payment.succeeded → handlePaymentSuccess ✅
    - subscription.activated → handlePaymentSuccess ✅
    - subscription.updated → handleTierUpdate ✅
    - subscription.cancelled → handleSubscriptionCancellation ✅
    - payment.shadow_claim_succeeded → handleShadowClaimPayment ✅
    - unhandled events → return HTTP 200 (correct per locked decision)

    Also verify we should handle these additional events per RESEARCH.md:
    - subscription.paused (consider logging)
    - subscription.resumed (consider logging)  
    - subscription.trialing (consider logging)
    - subscription.past_due (consider logging)

    For each additional event type, add a case that logs but doesn't fail:
    ```typescript
    case 'subscription.paused':
    case 'subscription.resumed':
    case 'subscription.trialing':
    case 'subscription.past_due':
      console.log(`Subscription event: ${eventType} for ${eventData.subscription_id}`);
      break;
    ```

    This ensures we acknowledge these events without blocking webhooks.
  </action>
  <verify>
    grep -n "case 'subscription" backend/src/routes/webhooks.ts
  </verify>
  <done>
    All necessary webhook event types are handled
  </done>
</task>

</tasks>

<verification>
1. Manual verification retained with documentation explaining why
2. Signature verification works for h1= format
3. All subscription-related event types handled
4. Unhandled events return HTTP 200 (per locked decision)
</verification>

<success_criteria>
- Manual webhook verification retained (SDK doesn't provide it)
- Signature verification fixed and working
- All necessary webhook event types handled
- Unhandled events acknowledged with HTTP 200
</success_criteria>

<output>
After completion, create `.planning/phases/03-paddle-integration-fix/03-04-SUMMARY.md`
</output>
