---
phase: 03-paddle-integration-fix
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/redacted/webhook-security.ts
autonomous: true

must_haves:
  truths:
    - "Paddle webhook signatures are verified successfully for both h1= and v1= formats"
    - "All valid Paddle webhook requests return HTTP 200"
    - "Invalid signatures are rejected with HTTP 401"
  artifacts:
    - path: "backend/src/redacted/webhook-security.ts"
      provides: "Webhook signature verification"
      contains: "verifyPaddleSignature"
  key_links:
    - from: "backend/src/routes/webhooks.ts"
      to: "backend/src/redacted/webhook-security.ts"
      via: "verifyPaddleSignature import"
      pattern: "verifyPaddleSignature.*payload.*signature"
---

<objective>
Fix Paddle webhook signature verification to support both `h1=` and `v1=` signature formats.

Purpose: Paddle sends webhook signatures with `h1=` prefix but current code only parses `v1=`. This causes all webhook requests to fail signature validation, blocking subscription updates.
Output: Fixed signature verification in webhook-security.ts
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-paddle-integration-fix/03-CONTEXT.md
@.planning/phases/03-paddle-integration-fix/03-RESEARCH.md

# Key source files
@backend/src/redacted/webhook-security.ts
@backend/src/routes/webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix signature parsing to support both h1= and v1= formats</name>
  <files>backend/src/redacted/webhook-security.ts</files>
  <action>
    In the verifyPaddleSignature function (around line 311), modify the signature parsing to support BOTH `h1=` AND `v1=` formats. Currently it only looks for `v1=`.

    Replace:
    ```typescript
    const v1Part = parts.find(p => p.startsWith('v1='));
    if (!tsPart || !v1Part) {
      return false;
    }
    const receivedSignature = v1Part.substring(3);
    ```

    With:
    ```typescript
    // Support both h1= (current Paddle format) and v1= (legacy) signature keys
    const h1Part = parts.find(p => p.startsWith('h1='));
    const v1Part = parts.find(p => p.startsWith('v1='));
    const signaturePart = h1Part || v1Part;
    
    if (!tsPart || !signaturePart) {
      return false;
    }
    
    const receivedSignature = signaturePart.substring(3);
    ```

    Add a console.log before the check to help debug which format Paddle is actually sending:
    ```typescript
    console.log('Paddle signature format:', { 
      hasH1: !!h1Part, 
      hasV1: !!v1Part,
      timestamp: timestamp?.substring(0, 10) 
    });
    ```
  </action>
  <verify>
    grep -n "h1Part.*v1Part" backend/src/redacted/webhook-security.ts
  </verify>
  <done>
    Signature verification parses both h1= and v1= formats
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify webhook endpoint returns HTTP 200 for all valid Paddle requests</name>
  <files>backend/src/routes/webhooks.ts</files>
  <action>
    Check that the webhook endpoint follows the locked decision: "Always respond HTTP 200 to all valid Paddle requests (even unhandled events)". 

    Current code at line 132-139 already handles unhandled events correctly by returning success: true. Verify this is working and that invalid signatures return HTTP 401 (line 49-55).

    No code changes needed if current implementation is correct - just verify:
    1. Valid signature + any event type = HTTP 200
    2. Invalid signature = HTTP 401
    3. Missing signature = HTTP 400
    
    Add console.log to help debug signature verification results:
    ```typescript
    // After signature check (around line 49)
    if (!signatureValid) {
      console.error('Invalid Paddle signature received:', { 
        hasSignature: !!signature, 
        hasSecret: !!c.env.PADDLE_WEBHOOK_SECRET 
      });
    ```
  </action>
  <verify>
    grep -n "return c.json" backend/src/routes/webhooks.ts | head -20
  </verify>
  <done>
    Webhook endpoint returns appropriate HTTP status codes
  </done>
</task>

</tasks>

<verification>
1. Signature verification function now handles both h1= and v1= formats
2. Invalid signatures are rejected with 401
3. All valid requests return 200, even unhandled event types
4. Logging helps debug any remaining issues
</verification>

<success_criteria>
- Paddle webhook signature verification works for current h1= format
- Legacy v1= format still supported for backward compatibility
- All valid webhook requests return HTTP 200
- Invalid signatures return HTTP 401
</success_criteria>

<output>
After completion, create `.planning/phases/03-paddle-integration-fix/03-01-SUMMARY.md`
</output>
