---
phase: 03-paddle-integration-fix
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/SubscriptionManagement.tsx
  - backend/src/routes/subscriptions.ts
  - backend/src/services/webhook-handler.ts
autonomous: true

must_haves:
  truths:
    - "Checkout requests include overseer_id in customData"
    - "Webhook handlers extract overseer_id from customData"
    - "Subscriptions are linked to correct overseer via customData"
  artifacts:
    - path: "frontend/src/pages/SubscriptionManagement.tsx"
      provides: "Frontend checkout with customData"
      contains: "customData.*overseer_id"
    - path: "backend/src/routes/subscriptions.ts"
      provides: "Backend checkout API response"
      contains: "customData.*overseer_id"
    - path: "backend/src/services/webhook-handler.ts"
      provides: "Webhook handler extracting overseer_id"
      contains: "custom_data.*overseer_id"
---

<objective>
Verify that overseer_id is correctly passed as customData in all Paddle checkout requests and properly extracted in webhook handlers.

Purpose: The webhook handlers need to know which overseer to link subscriptions to. This requires overseer_id in customData during checkout and proper extraction in webhook handlers.

Output: Verified checkout flow with overseer_id in customData
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-paddle-integration-fix/03-CONTEXT.md
@.planning/phases/03-paddle-integration-fix/03-RESEARCH.md

# Key source files - verify these
@frontend/src/pages/SubscriptionManagement.tsx
@backend/src/routes/subscriptions.ts
@backend/src/services/webhook-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify frontend sends overseer_id in customData</name>
  <files>frontend/src/pages/SubscriptionManagement.tsx</files>
  <action>
    Verify that the Paddle Checkout open call includes overseer_id in customData.

    Check around line 467-488 where Paddle.Checkout.open is called. The customData object should include:
    ```typescript
    customData: {
      tier: tier,
      overseer_id: user.id  // This links webhook to overseer
    }
    ```

    If missing, add it. The overseer_id is critical for webhook handlers to know which overseer owns the subscription.
  </action>
  <verify>
    grep -n "overseer_id" frontend/src/pages/SubscriptionManagement.tsx
  </verify>
  <done>
    Frontend sends overseer_id in customData to Paddle
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify backend returns customData in upgrade response</name>
  <files>backend/src/routes/subscriptions.ts</files>
  <action>
    Verify the /upgrade endpoint (POST /subscriptions/upgrade) returns customData with overseer_id in the response.

    Check around line 154-165 where the response is constructed. The customData object should be included:
    ```typescript
    return c.json({
      success: true,
      price_id: priceId,
      customer_email: overseer.email,
      customer_name: overseer.name,
      customData: {
        overseer_id: overseerId  // For frontend to pass to Paddle
      },
      // ...
    });
    ```

    This is used by the frontend to pass to Paddle.Checkout.open.
  </action>
  <verify>
    grep -n "customData" backend/src/routes/subscriptions.ts
  </verify>
  <done>
    Backend returns customData with overseer_id in upgrade response
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify webhook handlers extract overseer_id from custom_data</name>
  <files>backend/src/services/webhook-handler.ts</files>
  <action>
    Verify that webhook handlers correctly extract overseer_id from custom_data in Paddle webhook payloads.

    Check:
    1. handlePaymentSuccess (line 159-190) - extracts overseerId from custom_data.overseer_id
    2. handleCustomerCreated (line 91-142) - extracts overseer_id from custom_data.overseer_id
    3. handleShadowClaimPayment (line 207-295) - extracts from custom_data

    These handlers use the overseer_id to:
    - Link paddle_subscription_id to the correct overseer
    - Link paddle_customer_id to the correct overseer
    - Create or update shadow overseer relationships
  </action>
  <verify>
    grep -n "custom_data.*overseer" backend/src/services/webhook-handler.ts
  </verify>
  <done>
    Webhook handlers correctly extract overseer_id from custom_data
  </done>
</task>

</tasks>

<verification>
1. Frontend sends overseer_id in customData to Paddle
2. Backend returns customData in upgrade response
3. Webhook handlers extract and use overseer_id correctly
4. All three components work together for proper subscription linking
</verification>

<success_criteria>
- Frontend checkout includes overseer_id in customData
- Backend upgrade endpoint returns customData with overseer_id  
- Webhook handlers extract and use overseer_id from custom_data
- Subscriptions are correctly linked to overseers
</success_criteria>

<output>
After completion, create `.planning/phases/03-paddle-integration-fix/03-02-SUMMARY.md`
</output>
