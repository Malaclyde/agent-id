---
phase: 23-shadow-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/agents.ts
  - backend/src/services/ownership.ts
autonomous: true

must_haves:
  truths:
    - Shadow claim initiation creates claim challenges (not payment challenges)
    - Claim challenge includes isShadow flag, shadow_overseer_id, agent_id
    - Status endpoint returns correct states for shadow claims
    - Legacy payment challenge code removed or deprecated
  artifacts:
    - path: backend/src/routes/agents.ts
      provides: Refactored malice endpoints using claim challenges
      min_lines: 50
    - path: backend/src/services/ownership.ts
      provides: Shadow overseer ID generation
      min_lines: 20
  key_links:
    - from: POST /v1/agents/malice/:agentId
      to: CHALLENGES KV (claim: prefix)
      via: storeChallenge helper
      pattern: isShadow: true
    - from: GET /v1/agents/malice/status/:challengeId
      to: CHALLENGES KV
      via: getChallenge helper
      pattern: status field checks
---

<objective>
Refactor shadow claim backend to use unified claim challenge system instead of separate payment challenges.

Purpose: Align implementation with specification for consistent architecture and security
Output: Refactored endpoints using claim challenges with isShadow flag
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@docs/v1/requirements/agent/shadow-claim.md

@backend/src/routes/agents.ts
@backend/src/services/ownership.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor POST /v1/agents/malice/:agentId endpoint</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Refactor the shadow claim initiation endpoint to use claim challenges instead of payment challenges:
    
    1. Replace payment challenge creation with claim challenge creation
    2. Use CHALLENGES KV namespace with 'claim:' prefix (not 'payment:')
    3. Store challenge data with structure:
       {
         challenge_id: string,
         agent_id: string,
         overseer_id: string (shadow_overseer_id),
         isShadow: true,
         status: 'initiated',
         expires_at: string (ISO 8601, 60 min TTL)
       }
    4. Generate shadow_overseer_id using generateShadowOverseerId()
    5. Set TTL to 3600 seconds (60 minutes)
    6. Return response with challenge_id (not payment_challenge_id)
    7. Remove payment_url from response (not needed at this stage)
    
    Key differences from current implementation:
    - Uses 'claim:' prefix instead of 'payment:'
    - Includes isShadow flag
    - Includes status field
    - Returns challenge_id for agent to use
    
    Remove or comment out the old payment challenge code.
  </action>
  <verify>
    - Endpoint compiles without errors
    - Check that storeChallenge is called with 'claim' prefix
    - Verify isShadow: true is in stored data
  </verify>
  <done>
    POST /v1/agents/malice/:agentId creates claim challenges with isShadow flag and returns challenge_id
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GET /v1/agents/malice/status/:challengeId endpoint</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Update the status endpoint to work with claim challenges:
    
    1. Change from looking up 'payment' prefix to 'claim' prefix
    2. Support challengeId param (not paymentChallengeId)
    3. Return status based on challenge data:
       - If challenge not found → 'expired'
       - If challenge.expires_at < now → 'expired'
       - If challenge.status === 'initiated' → 'initiated'
       - If challenge.status === 'awaiting-payment' → 'awaiting-payment'
       - If challenge.status === 'completed' → 'completed'
    4. For 'completed' status, verify by checking database for active oversight
    5. Return response structure:
       {
         status: 'initiated' | 'awaiting-payment' | 'completed' | 'expired',
         agent_id: string,
         shadow_overseer_id: string,
         expires_at: string
       }
    
    Remove the old logic that checked payment challenges.
  </action>
  <verify>
    - Endpoint compiles without errors
    - Returns correct status for each state
    - Handles expired challenges correctly
  </verify>
  <done>
    Status endpoint correctly returns all four states for claim challenges
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove or deprecate legacy payment challenge endpoints</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Clean up legacy shadow claim code:
    
    1. Remove or deprecate GET /v1/agents/malice/:agentId/payment/:paymentChallengeId
       - This endpoint returns HTML payment page
       - No longer needed with new flow
       - Either remove entirely or add deprecation warning
    
    2. Remove or deprecate POST /v1/agents/malice/:agentId/complete
       - This was the manual payment completion endpoint
       - No longer needed with webhook flow
       - Either remove entirely or add deprecation warning
    
    3. If keeping deprecated endpoints, add console.warn() logs
    4. Update any internal references to use new endpoints
    
    Note: Be careful not to break any existing tests - update tests to use new flow.
  </action>
  <verify>
    - No TypeScript errors
    - Tests updated or removed as appropriate
    - No references to payment challenge system remain
  </verify>
  <done>
    Legacy payment challenge endpoints removed or deprecated
  </done>
</task>

</tasks>

<verification>
1. All shadow claim endpoints use claim challenges (not payment challenges)
2. Challenge data includes isShadow flag, shadow_overseer_id, status field
3. Status endpoint returns all four states correctly
4. Legacy payment challenge code removed or deprecated
5. All existing tests pass after refactoring
</verification>

<success_criteria>
- POST /v1/agents/malice/:agentId creates claim challenges with isShadow: true
- GET /v1/agents/malice/status/:challengeId returns correct status for all states
- Legacy payment challenge system removed
- Backend compiles without errors
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-shadow-refactor/23-01-SUMMARY.md`
</output>
