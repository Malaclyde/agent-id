---
phase: 30-frontend-test-implementation
plan: 10
type: execute
wave: 4
depends_on: [30-01, 30-02, 30-03, 30-04]
files_modified:
  - frontend/test/unit/pages/agent-dashboard.test.tsx
autonomous: true
must_haves:
  truths:
    - "Developer can verify AgentDashboard shows agent info and subscription status"
    - "Developer can verify OAuth history is displayed correctly"
    - "Developer can verify shadow upgrade button works for FREE tier agents"
    - "Developer can verify subscription status affects UI display"
  artifacts:
    - path: "frontend/test/unit/pages/agent-dashboard.test.tsx"
      provides: "AgentDashboard page tests"
      contains: "describe('AgentDashboard'"
  key_links:
    - from: "frontend/test/unit/pages/agent-dashboard.test.tsx"
      to: "frontend/test/mocks/handlers/agents.ts"
      via: "MSW handler override"
      pattern: "server.use\\(http\\.get"
---

<objective>
Create tests for AgentDashboard covering agent info display, OAuth history, subscription status, and shadow upgrade functionality.

Purpose: AgentDashboard is the main interface for agents. Tests verify info display, OAuth activity, and subscription-based UI variations.
Output: Comprehensive AgentDashboard tests.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Component to test
@frontend/src/pages/AgentDashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Create AgentDashboard page tests</name>
  <files>frontend/test/unit/pages/agent-dashboard.test.tsx</files>
  <action>
    Create comprehensive tests for AgentDashboard:
    
    ```typescript
    // frontend/test/unit/pages/agent-dashboard.test.tsx
    import { describe, it, expect, beforeEach, vi } from 'vitest';
    import { screen, waitFor } from '@testing-library/react';
    import userEvent from '@testing-library/user-event';
    import { renderWithAllProviders } from '../../utils/render-helpers';
    import { mockAuthenticatedAgent, clearAuthMocks } from '../../utils/auth-helpers';
    import { server } from '../../mocks/server';
    import { http, HttpResponse } from 'msw';
    import { createMockAgent, createMockSubscription } from '../../factories';
    import AgentDashboard from '../../../src/pages/AgentDashboard';
    
    describe('AgentDashboard', () => {
      const user = userEvent.setup();
      
      beforeEach(() => {
        vi.clearAllMocks();
        clearAuthMocks();
        server.resetHandlers();
      });
      
      describe('Agent info display', () => {
        it('shows agent ID', async () => {
          const mockAgent = createMockAgent({ id: 'test-agent-id-123' });
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription(),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/test-agent-id-123/i)).toBeInTheDocument();
          });
        });
        
        it('shows agent name', async () => {
          const mockAgent = createMockAgent({ name: 'Test Agent Name' });
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription(),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByDisplayValue('Test Agent Name')).toBeInTheDocument();
          });
        });
        
        it('shows agent description', async () => {
          const mockAgent = createMockAgent({ description: 'This is my agent description' });
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription(),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/this is my agent description/i)).toBeInTheDocument();
          });
        });
        
        it('shows "No description" when description is null', async () => {
          const mockAgent = createMockAgent({ description: null });
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription(),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/no description/i)).toBeInTheDocument();
          });
        });
      });
      
      describe('OAuth history', () => {
        it('shows empty state when no OAuth history', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription(),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/no.*oauth.*activity/i)).toBeInTheDocument();
          });
        });
        
        it('displays OAuth history entries', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          const mockHistory = [
            {
              id: 'history-1',
              client_id: 'client-123',
              scopes: 'read write',
              status: 'approved',
              created_at: '2026-02-22T10:00:00Z',
            },
            {
              id: 'history-2',
              client_id: 'client-456',
              scopes: 'read',
              status: 'rejected',
              created_at: '2026-02-21T10:00:00Z',
            },
          ];
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: mockHistory });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription(),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText('client-123')).toBeInTheDocument();
            expect(screen.getByText('client-456')).toBeInTheDocument();
            expect(screen.getByText('approved')).toBeInTheDocument();
            expect(screen.getByText('rejected')).toBeInTheDocument();
          });
        });
        
        it('shows OAuth count in stats', async () => {
          const mockAgent = createMockAgent({ oauth_count: 7 });
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({ max_oauth_per_period: 10 }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText('7')).toBeInTheDocument();
          });
        });
      });
      
      describe('Subscription display', () => {
        it('shows FREE tier subscription', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({ tier: 'FREE', is_active: true }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/free/i)).toBeInTheDocument();
          });
        });
        
        it('shows PRO tier subscription', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({
                  tier: 'PRO',
                  is_active: true,
                  max_oauth_per_period: 100,
                }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/pro/i)).toBeInTheDocument();
          });
        });
        
        it('shows billing period end date', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          const billingEnd = '2026-03-22T00:00:00Z';
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({
                  tier: 'PRO',
                  is_active: true,
                  billing_period_end: billingEnd,
                }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/3\/22\/2026|22.*3.*2026/i)).toBeInTheDocument();
          });
        });
        
        it('shows expired subscription message', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({
                  tier: 'PRO',
                  is_active: false,
                  grace_period_end: null,
                }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/expired/i)).toBeInTheDocument();
          });
        });
        
        it('shows grace period message', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          const graceEnd = '2026-02-29T00:00:00Z';
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({
                  tier: 'PRO',
                  is_active: false,
                  grace_period_end: graceEnd,
                }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByText(/grace period/i)).toBeInTheDocument();
          });
        });
      });
      
      describe('Shadow upgrade', () => {
        it('shows upgrade button for FREE tier agents', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({
                  tier: 'FREE',
                  is_active: true,
                }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByRole('button', { name: /upgrade/i })).toBeInTheDocument();
          });
        });
        
        it('hides upgrade button for paid tier agents', async () => {
          const mockAgent = createMockAgent();
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({
                  tier: 'PRO',
                  is_active: true,
                }),
              });
            })
          );
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.queryByRole('button', { name: /upgrade.*\$20/i })).not.toBeInTheDocument();
          });
        });
        
        it('initiates shadow upgrade when button clicked', async () => {
          const mockAgent = createMockAgent({ id: 'agent-123' });
          mockAuthenticatedAgent(mockAgent);
          
          server.use(
            http.get('/v1/agents/me', () => {
              return HttpResponse.json({ success: true, agent: mockAgent });
            }),
            http.get('/v1/agents/me/oauth-history', () => {
              return HttpResponse.json({ success: true, history: [] });
            }),
            http.get('/v1/subscriptions/me', () => {
              return HttpResponse.json({
                success: true,
                subscription: createMockSubscription({
                  tier: 'FREE',
                  is_active: true,
                }),
              });
            }),
            http.post('/v1/agents/malice/:agentId', () => {
              return HttpResponse.json({
                success: true,
                challenge_id: 'challenge-123',
                shadow_overseer_id: 'shadow-123',
                expires_at: new Date(Date.now() + 3600000).toISOString(),
              });
            })
          );
          
          // Mock window.location.href
          const originalLocation = window.location;
          delete (window as any).location;
          window.location = { ...originalLocation, href: '' };
          
          renderWithAllProviders(<AgentDashboard />);
          
          await waitFor(() => {
            expect(screen.getByRole('button', { name: /upgrade/i })).toBeInTheDocument();
          });
          
          await user.click(screen.getByRole('button', { name: /upgrade/i }));
          
          await waitFor(() => {
            expect(window.location.href).toContain('/malice/agent-123');
          });
          
          // Restore
          window.location = originalLocation;
        });
      });
    });
    ```
  </action>
  <verify>`cd frontend && npm run test:unit -- --run test/unit/pages/agent-dashboard.test.tsx` passes</verify>
  <done>AgentDashboard tests cover info display, OAuth history, subscription status, shadow upgrade</done>
</task>

</tasks>

<verification>
1. Test file exists at frontend/test/unit/pages/agent-dashboard.test.tsx
2. Tests cover agent info, OAuth history, subscription display, shadow upgrade
3. All tests pass
</verification>

<success_criteria>
- AgentDashboard tests verify agent info display (ID, name, description)
- Tests cover OAuth history list and empty state
- Tests verify subscription tier display and status indicators
- Tests cover shadow upgrade button for FREE tier agents
</success_criteria>

<output>
After completion, create `.planning/phases/30-frontend-test-implementation/30-10-SUMMARY.md`
</output>