---
phase: 22-shadow-claim-in-frontend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/App.tsx
  - frontend/src/pages/ShadowClaim.tsx (new)
autonomous: true

must_haves:
  truths:
    - "User visiting /malice/:agentId initiates shadow claim flow"
    - "User sees instructions to relay to their agent"
    - "Frontend polls for challenge completion status"
    - "After challenge complete, user sees payment option"
    - "After payment, user redirected to success"
  artifacts:
    - path: "frontend/src/pages/ShadowClaim.tsx"
      provides: "Shadow claim flow UI component"
      min_lines: 100
    - path: "frontend/src/App.tsx"
      provides: "Routes for /malice/:agentId paths"
      adds_routes: ["/malice/:agentId", "/malice/:agentId/payment/:paymentChallengeId"]
  key_links:
    - from: "frontend/src/pages/ShadowClaim.tsx"
      to: "/v1/agents/malice/:agentId"
      via: "fetch POST to initiate shadow claim"
    - from: "frontend/src/pages/ShadowClaim.tsx"
      to: "/v1/agents/claim/status/:challengeId"
      via: "polling fetch to check status"
---

<objective>
Implement shadow claim frontend UI that allows a human to initiate payment for an agent claim

Purpose: The backend already has shadow claim endpoints (/v1/agents/malice/*). The frontend needs pages to:
1. Initiate shadow claim when user visits /malice/:agentId
2. Display instructions for user to relay to their agent
3. Poll for challenge completion
4. Show payment page with Paddle checkout
5. Handle success redirect

Output: Working shadow claim UI flow
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md (Phase 22)
@docs/v1/immediate_roadmap.md (lines 22-47 describe frontend flow)
@docs/v1/requirements/agent/claim.md (lines 32-47 describe shadow claim flow)

## Backend Already Implemented (from agents.ts):
- POST /api/agents/malice/:agentId - Initiates shadow claim, returns challenge info
- GET /api/agents/malice/:agentId/payment/:paymentChallengeId - Returns HTML with Paddle checkout form
- POST /api/agents/malice/:agentId/complete - Processes payment completion
- GET /api/agents/claim/status/:challengeId - Returns challenge status

## Frontend Routing Pattern:
Routes in App.tsx use react-router-dom. Example:
```tsx
<Route path="/subscription/success" element={<SubscriptionSuccess />} />
```
</context>

<tasks>

<task type="auto">
  <name>Add shadow claim routes to App.tsx</name>
  <files>frontend/src/App.tsx</files>
  <action>
Add routes for shadow claim pages:
1. Import ShadowClaim component (create in task 2)
2. Add route: path="/malice/:agentId" element={<ShadowClaim />}
3. Add route: path="/malice/:agentId/payment/:paymentChallengeId" element={<ShadowClaimPayment />}

Place these routes BEFORE the catch-all route (path="*") to ensure they're matched.
  </action>
  <verify>Routes compile without errors, no TypeScript errors</verify>
  <done>Two new routes added to App.tsx for /malice/:agentId and /malice/:agentId/payment/:challengeId</done>
</task>

<task type="auto">
  <name>Create ShadowClaim page component</name>
  <files>frontend/src/pages/ShadowClaim.tsx</files>
  <action>
Create ShadowClaim.tsx component implementing the shadow claim flow:

1. **Initial Loading State:**
   - On mount, immediately show empty page with loading progress bar labeled "Please wait..."

2. **POST to /v1/agents/malice/:agentId:**
   - On mount, POST to initiate shadow claim
   - Handle response: { challenge_id, challenge_url, shadow_overseer_id, message }

3. **Display Instructions (after initiation):**
   - Show in human-friendly format:
     "Tell your agent to post this body: {overseerId: [shadowOverseerId]} to this callback url: [challenge_url] and sign this request with their DPoP JWT"
   - Display overseerId and callback URL clearly (not as code block, but styled text)
   - Include instruction about signing with DPoP JWT

4. **Poll for Challenge Status:**
   - Poll GET /v1/agents/claim/status/:challengeId every 2 seconds
   - Status states: pending, completed, rejected, expired
   - When status === "completed", redirect to /malice/:agentId/payment/:challengeId

5. **Error Handling:**
   - Display error messages for failed initiation
   - Handle expired challenges gracefully

Reference SubscriptionSuccess.tsx and SubscriptionCancelled.tsx for styling patterns.
  </action>
  <verify>npm run build passes, no TypeScript errors</verify>
  <done>ShadowClaim.tsx renders, shows "Please wait" loading, initiates shadow claim, displays human-friendly instructions, polls for status, redirects on completion</done>
</task>

<task type="auto">
  <name>Create ShadowClaimPayment page component</name>
  <files>frontend/src/pages/ShadowClaimPayment.tsx</files>
  <action>
Create ShadowClaimPayment.tsx component for the payment step:

1. **Component Structure:**
   - Use useParams to get agentId and paymentChallengeId
   - Use useState for: paymentStatus, loading, error

2. **On Mount - Check Payment Status:**
   - Poll GET /v1/agents/claim/status/:paymentChallengeId
   - If already completed (from webhook processing), show success state
   - Note: Backend keeps challenge info in KV for ~1 minute after completion for polling

3. **Display Payment Options:**
   - Show one-time payment option for shadow subscription
   - DO NOT display "BASIC" tier name
   - Display price (e.g., "$19 one-time") and capabilities:
     - "Your agent will get: X agents, Y clients, Z OAuth registrations per billing period"
   - Use actual values from subscription tier or backend response

4. **"Pay" Button:**
   - Label button exactly "pay" (lowercase)
   - Opens Paddle checkout

5. **Paddle Checkout Integration:**
   - Use Paddle.js to open checkout
   - Pass custom_data with: { is_shadow_claim: true, agent_id: agentId, shadow_overseer_id: shadowOverseerId }
   - On checkout success, poll for payment completion status

6. **Payment Success:**
   - Show "Payment successful!" message
   - Show "Redirecting to home..." after 3 seconds
   - Redirect to / (home page)

7. **Payment Failure:**
   - Show "Payment failed" message
   - Provide "Try Again" button to restart flow

Reference SubscriptionManagement.tsx for Paddle.js usage patterns.
  </action>
  <verify>npm run build passes, no TypeScript errors</verify>
  <done>ShadowClaimPayment.tsx shows price and capabilities (not "BASIC"), "pay" button opens Paddle, handles success/failure, redirects to home</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete shadow claim frontend flow</what-built>
  <how-to-verify>
    1. Visit http://localhost:5173/malice/test-agent-123 (or any valid agent ID)
    2. Should see loading state initially
    3. After backend responds, should see instructions to relay to agent
    4. Challenge completion would require agent action (backend flow)
    5. After challenge complete, should redirect to payment page
    6. Payment page should show one-time payment option
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Build: npm run build passes
2. Routes: /malice/:agentId and /malice/:agentId/payment/:challengeId accessible
3. TypeScript: No type errors in new components
4. Backend integration: Components make correct API calls to /v1/agents/malice/*
</verification>

<success_criteria>
- User can visit /malice/:agentId and initiate shadow claim
- User sees human-readable instructions to relay to their agent
- Frontend polls for challenge completion
- After challenge complete, payment page displays
- Payment page shows one-time payment option (without showing "BASIC" tier name)
- After successful payment, user redirected to home page
</success_criteria>

<output>
After completion, create `.planning/phases/22-shadow-claim-in-frontend/22-01-SUMMARY.md`
</output>
