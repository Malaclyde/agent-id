---
phase: 35-agent-demo-oauth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - demo/agent/agent-demo.py
autonomous: true
must_haves:
  truths:
    - "User can register an OAuth client with name and redirect URI"
    - "User can generate new keypair with --generate flag"
    - "User can provide explicit keys with --private-key and --public-key flags"
    - "Client keys are stored in .env using CLIENT_<client-id>_* namespace"
  artifacts:
    - path: "demo/agent/agent-demo.py"
      provides: "register-client subcommand with key provision options"
      contains: "def cmd_register_client"
  key_links:
    - from: "cmd_register_client"
      to: "POST /v1/clients/register/agent"
      via: "make_request with Bearer auth"
      pattern: "clients/register/agent"
    - from: "cmd_register_client"
      to: ".env file"
      via: "set_key with CLIENT_* namespace"
      pattern: "CLIENT_.*_PUBLIC_KEY"
---

<objective>
Add `register-client` subcommand to agent-demo.py with three key provision options.

Purpose: Enable agents to register OAuth clients for authorization flows (AOAUTH-01).
Output: Working `register-client` CLI subcommand that saves client keys to .env.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-agent-demo-oauth/35-CONTEXT.md
@.planning/phases/35-agent-demo-oauth/35-RESEARCH.md
@demo/agent/agent-demo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add register-client subcommand with key provision options</name>
  <files>demo/agent/agent-demo.py</files>
  <action>
Add the `register-client` subcommand to agent-demo.py following these specifications:

**CLI Arguments:**
- `--name` (required): Client name
- `--redirect-uri` (required): Single redirect URI for the client
- `--scope` (optional): Space-separated scopes, defaults to "id name description subscription"
- Key provision options (mutually exclusive):
  - `--generate`: Generate new Ed25519 keypair
  - `--private-key <key> --public-key <key>`: User provides explicit keys
  - No key flags: NOT ALLOWED for new registration (keys must be generated or provided)

**Implementation Details:**

1. Add `register-client` subparser to argparse (around line 1252, after rotate-keys):
```python
# register-client command
parser_register_client = subparsers.add_parser(
    "register-client",
    help="Register an OAuth client for the authenticated agent",
)
parser_register_client.add_argument("--name", required=True, help="Client name")
parser_register_client.add_argument("--redirect-uri", required=True, help="Redirect URI")
parser_register_client.add_argument("--scope", help="Space-separated scopes")
parser_register_client.add_argument("--generate", action="store_true", help="Generate new keypair")
parser_register_client.add_argument("--private-key", help="Base64url-encoded private key")
parser_register_client.add_argument("--public-key", help="Base64url-encoded public key")
```

2. Add `cmd_register_client` function (around line 1067, before cmd_config):
```python
def cmd_register_client(args) -> int:
    """Register a new OAuth client for the authenticated agent."""
    config = load_config()

    # Validate required config
    if not config.get("backend_url"):
        print("No backend_url configured.", file=sys.stderr)
        return 1

    if not config.get("session_id"):
        print("No active session. Run 'python agent-demo.py login' first.", file=sys.stderr)
        return 1

    # Handle key provision options
    if args.generate:
        # Option 1: Generate new keypair
        private_b64url, public_b64url = generate_keypair()
    elif args.private_key and args.public_key:
        # Option 3: User provides keys explicitly
        private_b64url = args.private_key
        public_b64url = args.public_key
        is_valid, msg = validate_keys_match(private_b64url, public_b64url)
        if not is_valid:
            print(f"Error: Invalid keys - {msg}", file=sys.stderr)
            return 1
    else:
        # No key flags - not allowed for new registration
        print("Error: Either --generate or both --private-key and --public-key required.", file=sys.stderr)
        return 1

    # Build request body
    body = {
        "name": args.name,
        "redirect_uris": [args.redirect_uri],
        "public_key": public_b64url,
    }
    if args.scope:
        body["scope"] = args.scope

    # Call registration API
    backend_url = config["backend_url"]
    session_id = config["session_id"]
    url = f"{backend_url}/v1/clients/register/agent"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {session_id}",
    }
    encoded_body = json.dumps(body).encode("utf-8")

    response = make_request(url, headers, data=encoded_body, method="POST")
    result = json.loads(response)

    # Extract client_id from response
    client_id = result.get("client", {}).get("id")
    if not client_id:
        print("Error: No client_id in response", file=sys.stderr)
        return 1

    # Save keys under CLIENT_<client-id>_* namespace in .env
    set_key(ENV_FILE, f"CLIENT_{client_id}_PUBLIC_KEY", public_b64url)
    set_key(ENV_FILE, f"CLIENT_{client_id}_PRIVATE_KEY", private_b64url)
    set_key(ENV_FILE, f"CLIENT_{client_id}_ID", client_id)

    print(f"Client registered successfully!")
    print(f"Client ID: {client_id}")
    print_output(response)
    return 0
```

3. Add handler to command_handlers dict (around line 1267):
```python
"register-client": cmd_register_client,
```

**Key Patterns to Follow:**
- Use existing `make_request()` for fail-fast HTTP calls
- Use existing `print_output()` for raw JSON output
- Use existing `generate_keypair()` and `validate_keys_match()` for key handling
- Use `set_key()` from python-dotenv (already imported)
- Follow the dual-auth pattern from `cmd_claim` for future DPoP fallback if needed

**DO NOT:**
- Do not use client name as namespace (use client ID per CONTEXT.md)
- Do not add list-clients or key rotation (out of scope)
- Do not add confirmation prompts (fail-fast pattern)
  </action>
  <verify>
    # Verify syntax
    python -m py_compile demo/agent/agent-demo.py

    # Verify CLI help
    python demo/agent/agent-demo.py register-client --help

    # Verify arguments are present
    python demo/agent/agent-demo.py register-client --help | grep -E "(--name|--redirect-uri|--generate|--private-key|--public-key)"
  </verify>
  <done>
    - `python agent-demo.py register-client --help` shows all required arguments
    - Subcommand compiles without errors
    - Ready for integration testing with backend
  </done>
</task>

</tasks>

<verification>
Run `python demo/agent/agent-demo.py --help` and verify `register-client` appears in available commands.
Run `python demo/agent/agent-demo.py register-client --help` and verify all flags are documented.
</verification>

<success_criteria>
- AOAUTH-01 partial: User can register OAuth client with key generation or provision options.
- CLI help shows register-client with --name, --redirect-uri, --generate, --private-key, --public-key flags.
- Code follows existing patterns: make_request, print_output, generate_keypair, validate_keys_match.
</success_criteria>

<output>
After completion, create `.planning/phases/35-agent-demo-oauth/35-01-SUMMARY.md`
</output>
