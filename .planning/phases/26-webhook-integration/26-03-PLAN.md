---
phase: 26-webhook-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [backend/src/routes/agents.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When processing a renewal, existing shadow overseer ID is reused"
    - "When processing first-time claim, new shadow overseer ID is generated"
  artifacts:
    - path: "backend/src/routes/agents.ts"
      provides: "Shadow claim initiation endpoint"
      contains: "shadowOverseerId"
  key_links:
    - from: "activeOversight check"
      to: "shadowOverseerId assignment"
      via: "conditional reuse"
      pattern: "activeOversight.*overseer_id"
---

<objective>
Fix shadow overseer ID reuse for renewals in the `/malice/:agentId` endpoint.

Purpose: When a shadow overseer renews their claim, the same shadow overseer ID should be reused (not regenerated) for consistency and proper tracking.

Output: Fixed conditional logic that reuses existing shadow overseer ID for renewals.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# UAT Gap (Test 6: Shadow Overseer Reuse)
@.planning/phases/26-webhook-integration/26-UAT.md

# Current code location
@backend/src/routes/agents.ts (lines 786-807)
</context>

<tasks>

<task type="auto">
  <name>Fix shadow overseer ID reuse logic</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    In `backend/src/routes/agents.ts`, modify lines 795-796 to conditionally reuse the existing shadow overseer ID:

    **Current code (lines 795-796):**
    ```javascript
    // Generate cryptographically signed shadow overseer ID
    const shadowOverseerId = await generateShadowOverseerId(c.env);
    ```

    **Replace with:**
    ```javascript
    // Reuse existing shadow overseer ID for renewal, or generate new one for first-time claim
    let shadowOverseerId: string;
    if (activeOversight) {
      // Reuse existing shadow overseer ID for renewal
      // (We already verified it's a shadow overseer at lines 788-791)
      shadowOverseerId = activeOversight.overseer_id;
    } else {
      // Generate new shadow overseer ID for first-time claim
      shadowOverseerId = await generateShadowOverseerId(c.env);
    }
    ```

    **Why this works:** Lines 787-792 already reject non-shadow overseers with 409. If `activeOversight` exists at line 795, it IS guaranteed to be a shadow overseer.
  </action>
  <verify>
    1. TypeScript compiles: `cd backend && npx tsc --noEmit`
    2. Search confirms fix: `grep -A5 "let shadowOverseerId" backend/src/routes/agents.ts | head -10`
  </verify>
  <done>
    - TypeScript compiles without errors
    - Code shows conditional logic: reuse `activeOversight.overseer_id` if exists, otherwise generate new ID
    - Variable declaration changed from `const` to `let` to allow conditional assignment
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. Code review shows proper conditional reuse logic
3. Variable `shadowOverseerId` correctly assigned in both branches
</verification>

<success_criteria>
- Shadow overseer ID is reused for renewals (when `activeOversight` exists)
- New shadow overseer ID is generated for first-time claims (when `activeOversight` is null)
- TypeScript compiles without errors
- No runtime errors in existing flows
</success_criteria>

<output>
After completion, create `.planning/phases/26-webhook-integration/26-03-SUMMARY.md`
</output>
