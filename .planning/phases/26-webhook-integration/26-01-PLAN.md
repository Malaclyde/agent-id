---
phase: 26-webhook-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: ["backend/src/services/shadowClaimService.ts"]
autonomous: true
must_haves:
  truths:
    - "Duplicate webhooks are ignored silently without errors"
    - "Late payments on already-claimed agents are safely skipped with a 200 OK"
  artifacts:
    - path: "backend/src/services/shadowClaimService.ts"
      provides: "Core webhook processing logic and idempotency checks"
  key_links:
    - from: "backend/src/services/shadowClaimService.ts"
      to: "KV Store"
      via: "challenge status check"
---

<objective>
Implement core webhook logic and idempotency handling for shadow claim payments.

Purpose: Prevent duplicate processing of the same transaction and correctly handle edge cases where a challenge expires but the user pays anyway.
Output: A reusable service function that safely validates the challenge state before allowing DB modifications.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/src/services/shadowClaimService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement KV Idempotency Check</name>
  <files>backend/src/services/shadowClaimService.ts</files>
  <action>Create the `processShadowClaimWebhook` function (or equivalent). Extract the custom data (challenge ID, agent ID) from the Paddle payload. Look up the challenge in the KV store. **CRITICAL**: If the challenge status is already `completed`, silently return early with a success indicator (to send a 200 OK to Paddle and acknowledge receipt without duplicating work).</action>
  <verify>Function logic correctly aborts and returns success when KV status indicates prior completion.</verify>
  <done>Duplicate events for the same completed challenge are safely ignored.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Expired Challenge Logic</name>
  <files>backend/src/services/shadowClaimService.ts</files>
  <action>Add logic for late payments (arriving after TTL). If the challenge TTL has expired, query the database to see if the agent is already claimed (e.g., by a real overseer or another shadow overseer). **CRITICAL**: If the agent IS claimed, skip activation, log a clear warning (audit detail: "Late payment received for already claimed agent {id}"), and return early with success (since refunds are a v2.1 feature).</action>
  <verify>Logic review confirms DB check for existing claim and early return on late payments for claimed agents.</verify>
  <done>Late payments on claimed agents are safely skipped with a warning log and 200 OK.</done>
</task>

</tasks>

<verification>
Review `shadowClaimService.ts` to ensure idempotency and expired challenge checks strictly return early before reaching the core activation logic.
</verification>

<success_criteria>
Service function correctly handles both duplicate events and late payment edge cases without failing or making incorrect database updates.
</success_criteria>

<output>
After completion, create `.planning/phases/26-webhook-integration/26-01-SUMMARY.md`
</output>
