---
phase: 26-webhook-integration
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified: ["backend/src/services/shadowClaimService.ts", "backend/src/routes/webhooks.ts"]
autonomous: true
must_haves:
  truths:
    - "Only one active oversight relationship exists per agent"
    - "Shadow overseer is successfully created or reused"
    - "Webhook endpoint correctly routes transaction.completed events"
  artifacts:
    - path: "backend/src/routes/webhooks.ts"
      provides: "Paddle webhook listener"
  key_links:
    - from: "backend/src/routes/webhooks.ts"
      to: "backend/src/services/shadowClaimService.ts"
      via: "event routing"
---

<objective>
Execute the database operations for a valid shadow claim and expose the webhook route.

Purpose: Transfer oversight to the shadow overseer upon successful payment and provide an endpoint for Paddle to hit.
Output: Fully functional database update logic and an active webhook endpoint.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/src/services/shadowClaimService.ts
@backend/src/routes/webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB Operations & Oversight Deactivation</name>
  <files>backend/src/services/shadowClaimService.ts</files>
  <action>Extend `processShadowClaimWebhook` to handle the successful claim path. **CRITICAL**: Ensure only one active oversight exists by updating older ones' `active` flag to `false` (do NOT hard-delete). Create or reuse the shadow overseer, insert the new active oversight relationship, and add an audit log (e.g., "Shadow oversight activated for agent {id}"). Finally, update the KV challenge status to `completed`.</action>
  <verify>Database operations correctly enforce single active oversight and update the KV status.</verify>
  <done>Oversight is correctly transferred to the shadow overseer and KV is marked completed.</done>
</task>

<task type="auto">
  <name>Task 2: Webhook Route Integration</name>
  <files>backend/src/routes/webhooks.ts</files>
  <action>Integrate the `processShadowClaimWebhook` handler into the webhook router. Listen for Paddle `transaction.completed` events. Ensure proper signature validation using standard practices or `@paddle/paddle-node` if applicable on Edge. Call the service function with the extracted payload and always return a 200 OK on successful processing or handled edge cases.</action>
  <verify>Route correctly maps `transaction.completed` to the service function and returns 200 OK.</verify>
  <done>Webhook endpoint successfully receives and routes Paddle events to the processing logic.</done>
</task>

</tasks>

<verification>
Review `webhooks.ts` to ensure `transaction.completed` is registered, signature validation is in place, and `shadowClaimService.ts` correctly manages the oversight state.
</verification>

<success_criteria>
Valid paddle `transaction.completed` events result in a single active shadow oversight relationship and a 200 OK response.
</success_criteria>

<output>
After completion, create `.planning/phases/26-webhook-integration/26-02-SUMMARY.md`
</output>
