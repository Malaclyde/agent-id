---
phase: 36-client-demo-core
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - demo/client/client-demo.py
autonomous: true
must_haves:
  truths:
    - "User can load configuration from .env file with CLIENT_* namespace"
    - "User can save configuration to .env file"
    - "User can generate PKCE verifier/challenge pair with S256 method"
  artifacts:
    - path: "demo/client/client-demo.py"
      provides: "Config management and PKCE"
      contains: "def load_config"
      contains: "def generate_pkce_pair"
  key_links:
    - from: "load_config()"
      to: ".env file"
      via: "python-dotenv load_dotenv"
      pattern: "load_dotenv\\(env_file\\)"
    - from: "generate_pkce_pair()"
      to: "hashlib.sha256"
      via: "S256 challenge derivation"
      pattern: "hashlib\\.sha256"
---

<objective>
Create configuration management with CLIENT_* namespace and PKCE verifier/challenge generation.

Purpose: Enable .env-based configuration for client credentials and provide PKCE generation for OAuth flows.
Output: Working config load/save, PKCE generation with S256 method
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-client-demo-core/36-CONTEXT.md
@.planning/phases/36-client-demo-core/36-RESEARCH.md
@demo/agent/agent-demo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create configuration management with CLIENT_* namespace</name>
  <files>demo/client/client-demo.py</files>
  <action>
Add configuration management to client-demo.py with CLIENT_* namespace:

1. Add constants:
   - `ENV_FILE = ".env"`
   - `ENV_KEYS` dict mapping internal keys to env var names:
     ```
     "backend_url": "BACKEND_URL",
     "client_id": "CLIENT_ID",
     "private_key": "CLIENT_PRIVATE_KEY",
     "public_key": "CLIENT_PUBLIC_KEY",
     "client_url": "CLIENT_URL",
     "client_port": "CLIENT_PORT",
     ```

2. Add `load_config(env_file: str = ENV_FILE) -> dict`:
   - Use `load_dotenv(env_file)` to load .env
   - Return dict with keys: backend_url, client_id, private_key, public_key, client_url, client_port
   - For client_url, default to "localhost" if not set
   - For client_port, default to "8790" if not set
   - All other values are None if not set

3. Add `save_config(config: dict, env_file: str = ENV_FILE) -> None`:
   - Iterate over config items
   - Use `set_key(env_file, env_var, value)` for each non-None value
   - Map internal keys to env var names via ENV_KEYS

4. Add `validate_config(config: dict) -> tuple[bool, str]`:
   - Check backend_url is set
   - Check client_id is set
   - Check private_key and public_key are both set (or neither)
   - If both keys present, validate they match using `validate_keys_match`
   - Return (True, "OK") or (False, error_message)

5. Import: `from dotenv import load_dotenv, set_key`
</action>
  <verify>python3 -c "from client_demo import load_config, save_config, validate_config; c = load_config(); print(f'Config loaded: {list(c.keys())}')" </verify>
  <done>load_config, save_config, validate_config functions work with CLIENT_* namespace and proper defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create PKCE verifier/challenge generation</name>
  <files>demo/client/client-demo.py</files>
  <action>
Add PKCE generation function to client-demo.py:

1. Import: `import secrets`, `import hashlib`

2. Add `generate_pkce_pair() -> tuple[str, str]`:
   - Generate 32 cryptographically random bytes using `secrets.token_bytes(32)`
   - Base64url encode WITHOUT padding to create code_verifier
   - SHA256 hash the verifier (as UTF-8 bytes)
   - Base64url encode the hash WITHOUT padding to create code_challenge
   - Return tuple of (code_verifier, code_challenge)

3. Follow RFC 7636 exactly:
   - code_verifier: 43-128 chars (32 bytes â†’ ~43 chars base64url)
   - code_challenge: BASE64URL(SHA256(code_verifier))
   - Always strip '=' padding

Per CONTEXT.md: Output to stdout only, NO automatic .env storage.

CRITICAL: Use base64.urlsafe_b64encode, NOT base64.b64encode.
CRITICAL: Strip '=' padding with .rstrip('=') after decoding to string.
</action>
  <verify>python3 -c "from client_demo import generate_pkce_pair; v, c = generate_pkce_pair(); print(f'verifier: {v[:20]}... ({len(v)} chars)'); print(f'challenge: {c[:20]}... ({len(c)} chars)'); assert 43 <= len(v) <= 128, 'Invalid verifier length'"</verify>
  <done>generate_pkce_pair produces valid PKCE verifier/challenge with S256 method</done>
</task>

</tasks>

<verification>
1. Test config loading from non-existent .env (should return defaults)
2. Test config loading from existing .env with CLIENT_* values
3. Test PKCE pair generation produces valid S256 challenge
4. Verify PKCE verifier length is in valid range (43-128 chars)
</verification>

<success_criteria>
- Configuration loads from .env with CLIENT_* namespace
- Default values applied: CLIENT_URL=localhost, CLIENT_PORT=8790
- PKCE generation produces valid S256 verifier/challenge pairs
- Config validation checks keys match if both present
</success_criteria>

<output>
After completion, create `.planning/phases/36-client-demo-core/36-02-SUMMARY.md`
</output>
