---
phase: 36-client-demo-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - demo/client/client-demo.py
  - demo/client/requirements.txt
autonomous: true
must_haves:
  truths:
    - "User can import and use base64url encoding/decoding functions"
    - "User can generate Ed25519 keypairs with base64url encoding"
    - "User can validate that public key derives from private key"
  artifacts:
    - path: "demo/client/client-demo.py"
      provides: "Core crypto utilities"
      min_lines: 100
      contains: "def base64url_encode"
    - path: "demo/client/requirements.txt"
      provides: "Python dependencies"
      contains: "pynacl"
  key_links:
    - from: "generate_keypair()"
      to: "base64url_encode()"
      via: "direct call"
      pattern: "base64url_encode\\(bytes\\(private_key\\)\\)"
---

<objective>
Create core crypto utilities and Ed25519 key management for client-demo.py.

Purpose: Establish the foundational cryptographic functions that all other subcommands will depend on.
Output: Working base64url utilities, Ed25519 key generation/validation, requirements.txt
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-client-demo-core/36-CONTEXT.md
@.planning/phases/36-client-demo-core/36-RESEARCH.md
@demo/agent/agent-demo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create base64url encoding/decoding utilities</name>
  <files>demo/client/client-demo.py, demo/client/requirements.txt</files>
  <action>
Create demo/client/client-demo.py with initial structure and base64url utilities:

1. Create demo/client/requirements.txt with:
   - pynacl>=1.5.0
   - python-dotenv>=1.0.0

2. Create demo/client/client-demo.py with module docstring describing:
   - CLI interface for OAuth client operations
   - PKCE generation, key management, token exchange

3. Add base64url utilities (copy pattern from agent-demo.py):
   - `base64url_encode(data: bytes) -> str` - Encode bytes to base64url WITHOUT padding (strip trailing '=')
   - `base64url_decode(data: str) -> bytes` - Decode base64url to bytes, adding padding if needed
   - `base64url_encode_json(obj: dict) -> str` - JSON-encode dict with no whitespace, then base64url encode

4. Import required modules: base64, json

DO NOT use base64.b64encode (wrong alphabet). Use base64.urlsafe_b64encode.
DO NOT include padding in output (strip '=' characters).
</action>
  <verify>python3 -c "from client_demo import base64url_encode, base64url_decode; data=b'test'; encoded=base64url_encode(data); decoded=base64url_decode(encoded); assert data==decoded, 'Roundtrip failed'"</verify>
  <done>base64url_encode, base64url_decode, base64url_encode_json functions work correctly with proper padding handling</done>
</task>

<task type="auto">
  <name>Task 2: Create Ed25519 key generation, loading, and validation</name>
  <files>demo/client/client-demo.py</files>
  <action>
Add Ed25519 key management functions to client-demo.py:

1. Import: `from nacl.signing import SigningKey, VerifyKey`

2. Add `generate_keypair() -> tuple[str, str]`:
   - Generate new Ed25519 keypair using `SigningKey.generate()`
   - Return tuple of (private_key_b64url, public_key_b64url)
   - Both encoded with base64url_encode without padding

3. Add `load_private_key(private_b64url: str) -> SigningKey`:
   - Decode base64url to bytes
   - Validate 32-byte length, raise ValueError if wrong
   - Return SigningKey instance

4. Add `load_public_key(public_b64url: str) -> VerifyKey`:
   - Decode base64url to bytes
   - Validate 32-byte length, raise ValueError if wrong
   - Return VerifyKey instance

5. Add `validate_keys_match(private_b64url: str, public_b64url: str) -> tuple[bool, str]`:
   - Load private key
   - Derive public key from private key
   - Compare with provided public key
   - Return (True, "OK") if match, (False, error_message) otherwise

Follow the exact patterns from agent-demo.py for consistency.
</action>
  <verify>python3 -c "from client_demo import generate_keypair, validate_keys_match; priv, pub = generate_keypair(); valid, msg = validate_keys_match(priv, pub); assert valid, f'Key validation failed: {msg}'"</verify>
  <done>generate_keypair, load_private_key, load_public_key, validate_keys_match functions work correctly with proper Ed25519 key handling</done>
</task>

</tasks>

<verification>
1. Run `python3 demo/client/client-demo.py --help` - should show usage without errors
2. Import and test all utility functions in Python REPL
3. Verify key generation produces valid 32-byte keys
4. Verify key validation catches mismatched keys
</verification>

<success_criteria>
- demo/client/client-demo.py exists with base64url utilities
- demo/client/requirements.txt exists with pynacl and python-dotenv
- Ed25519 key functions generate, load, and validate keys correctly
- All functions follow patterns from agent-demo.py for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/36-client-demo-core/36-01-SUMMARY.md`
</output>
