---
phase: 31-end-to-end-test-implementation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/playwright.config.ts
  - test/e2e/setup/global.setup.ts
  - backend/src/routes/test-utils.ts
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Test infrastructure cleanly sets up and tears down an ephemeral backend environment."
    - "Webhook simulation can directly inject payloads into the test backend without external network tunneling."
    - "E2E tests run deterministically without flaky failures."
  artifacts:
    - path: "test/e2e/playwright.config.ts"
      provides: "webServer configuration with correct cwd"
    - path: "test/e2e/setup/global.setup.ts"
      provides: "D1 database schema migrations execution"
    - path: "backend/src/routes/test-utils.ts"
      provides: "POST /simulate-webhook endpoint implementation"
  key_links:
    - from: "test/e2e/setup/global.setup.ts"
      to: "package.json scripts"
      via: "execSync npm run db:migrate:test"
    - from: "backend/src/routes/test-utils.ts"
      to: "backend/src/services/webhook-handler.ts"
      via: "handlePaymentSuccess, handleSubscriptionCancellation, etc."
---

<objective>
Fix Playwright E2E infrastructure by correcting webServer startup directories, ensuring database migrations run before tests, and implementing the missing test webhook simulation endpoint.

Purpose: Close verification gaps that are blocking the E2E tests from running properly. The missing cwd causes server startup to fail, missing migrations cause 'no such table' DB errors, and missing the simulate endpoint breaks webhook verification.
Output: A functional test runner that starts correctly, migrates the local ephemeral DB, and can handle test-injected webhooks.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix playwright webServer config context</name>
  <files>test/e2e/playwright.config.ts</files>
  <action>
    Add `cwd: join(__dirname, '../../')` to both `webServer` blocks inside `playwright.config.ts`.
    This ensures that `npm run dev:backend` and `npm run dev:frontend` execute in the project root instead of the `test/e2e` directory, preventing "Missing script" or configuration lookup failures.
    Gap reason: Playwright configuration misses 'cwd' resulting in webServers failing to start.
  </action>
  <verify>Check that both webServer objects contain `cwd: join(__dirname, '../../')` (or similar correct path traversal to the root).</verify>
  <done>Playwright runner will start dev servers from the project root directory.</done>
</task>

<task type="auto">
  <name>Task 2: Fix global setup D1 migrations</name>
  <files>test/e2e/setup/global.setup.ts</files>
  <action>
    Update `globalSetup` to execute D1 migrations after the `.wrangler-state` directory cleanup.
    Add `execSync('npm run db:migrate:test', { cwd: rootDir, stdio: 'inherit' });` where `rootDir` is the project root (e.g. `process.cwd()`).
    Gap reason: Global setup clears an arbitrary directory instead of running migrations, leading to SQL errors ('no such table: overseers').
  </action>
  <verify>Check that global.setup.ts contains the execSync for migrations after state cleanup.</verify>
  <done>E2E tests will run against a properly populated D1 database schema.</done>
</task>

<task type="auto">
  <name>Task 3: Implement POST /simulate-webhook endpoint</name>
  <files>backend/src/routes/test-utils.ts</files>
  <action>
    Implement the missing `testUtils.post('/simulate-webhook', async (c) => { ... })` route.
    1. Parse JSON body to extract `eventType = payload.event_type || payload.type` and `data = payload.data`.
    2. Switch on `eventType` and dispatch to the correct imported handler:
       - `transaction.completed` -> `processShadowClaimWebhook(c.env, data)` OR `handlePaymentSuccess(data, c.env.DB, c.env)` based on structure or just call both if safe. (Note: use `processShadowClaimWebhook(c.env, data)` if `custom_data.is_shadow_claim` is true, otherwise `handlePaymentSuccess(data, c.env.DB, c.env)`).
       - `subscription.canceled` -> `handleSubscriptionCancellation(data, c.env.DB, c.env)`
       - `subscription.updated` -> `handleTierUpdate(data, c.env.DB, c.env)`
       - `subscription.paused` -> `handleSubscriptionPaused(data, c.env.DB, c.env)`
       - `subscription.resumed` -> `handleSubscriptionResumed(data, c.env.DB, c.env)`
       - `subscription.past_due` -> `handleSubscriptionPastDue(data, c.env.DB, c.env)`
       - `customer.created` -> `handleCustomerCreated(data, c.env.DB, c.env)`
    3. If the payload doesn't have a `.data` wrapper, just pass `payload` itself depending on what the simulation sends. `fixtures/paddle.ts` usually sends the full Paddle payload directly. Review the payload structure passed to ensure the handler receives what it expects.
    4. Return `{ success: true }` or `{ error: ... }`.
    Gap reason: E2E tests use 'simulateWebhook' which fetches '/v1/test-utils/simulate-webhook', but this route is never implemented.
  </action>
  <verify>Check that POST /simulate-webhook route exists and routes events to imported handlers.</verify>
  <done>Tests can successfully inject simulated webhooks to the backend test route.</done>
</task>

</tasks>

<verification>
1. Run `npx playwright test test/e2e/multi-actor.spec.ts` (or any single test) and verify that the `webServer` blocks start successfully and the database schema error does not appear.
2. Verify that POST `/v1/test-utils/simulate-webhook` works by mocking a request.
</verification>

<success_criteria>
The Playwright environment and database are successfully initialized without errors, and the backend handles test-injected webhooks natively.
</success_criteria>

<output>
After completion, create `.planning/phases/31-end-to-end-test-implementation/31-04-SUMMARY.md`
</output>
