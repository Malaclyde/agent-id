---
phase: 31-end-to-end-test-implementation
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - test/e2e/multi-actor.spec.ts
  - test/e2e/fixtures/contexts.ts
  - test/e2e/registration-flow.spec.ts
  - test/e2e/oauth-flow.spec.ts
autonomous: true
must_haves:
  truths:
    - "Developer can run tests that use separate browser contexts for Overseer and Agent"
    - "Tests correctly wait for elements instead of using arbitrary timeouts"
    - "Agent can complete an OAuth flow with a client provisioned by an Overseer"
  artifacts:
    - path: "test/e2e/multi-actor.spec.ts"
      provides: "Overseer and Agent interaction tests"
      contains: "browser.newContext()"
    - path: "test/e2e/fixtures/contexts.ts"
      provides: "Playwright test fixtures for auth"
  key_links:
    - from: "test/e2e/multi-actor.spec.ts"
      to: "test/e2e/fixtures/contexts.ts"
      via: "test fixture import"
      pattern: "import.*contexts"
---

<objective>
Implement multi-actor E2E tests for cross-role workflows and clean up existing flakey tests.

Purpose: Validate that an Overseer can provision clients that an Agent can subsequently use in the same test block without shared session state issues.
Output: Refactored registration E2E tests and a robust `multi-actor.spec.ts` using Playwright context isolation.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@test/e2e/registration-flow.spec.ts
@test/e2e/oauth-flow.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Registration Flow to Remove Anti-Patterns</name>
  <files>test/e2e/registration-flow.spec.ts</files>
  <action>
    Refactor `registration-flow.spec.ts` to remove all instances of `waitForTimeout()`, `.catch(() => false)`, and custom `waitForElement` helpers. 
    Use Playwright's native `await expect(page.getByRole('button')).toBeVisible()` and robust locators (e.g. `page.getByLabel`, `page.getByRole`).
    If needed, extract the login helper to a dedicated file `test/e2e/fixtures/contexts.ts` to share with other tests.
  </action>
  <verify>Playwright test runs deterministically without arbitrary delays, executing `npm run test:e2e registration` successfully.</verify>
  <done>Registration E2E test passes cleanly using strict assertions</done>
</task>

<task type="auto">
  <name>Task 2: Implement Multi-Actor OAuth Flow</name>
  <files>test/e2e/multi-actor.spec.ts, test/e2e/oauth-flow.spec.ts, test/e2e/fixtures/contexts.ts</files>
  <action>
    Delete or repurpose `oauth-flow.spec.ts` into a new `multi-actor.spec.ts`.
    In `test/e2e/fixtures/contexts.ts`, create helper functions or Playwright fixtures that use `browser.newContext()` to return an isolated page.
    In the test `multi-actor.spec.ts`, create two distinct contexts: `overseerContext` and `agentContext`.
    Step 1: Overseer page logs in, navigates to dashboard, creates a new OAuth client.
    Step 2: Overseer extracts the generated client ID from the UI.
    Step 3: Agent page navigates to the OAuth authorization URL with the newly created client ID.
    Step 4: Agent logs in, approves the authorization, and gets redirected back with an auth code.
    Use strict `await expect(...)` assertions at each step.
  </action>
  <verify>`npm run test:e2e multi-actor` executes the full flow and passes with distinct user sessions.</verify>
  <done>System supports complex multi-user interactions tested in a single test block</done>
</task>

</tasks>

<verification>
Run the multi-actor tests verifying Overseer context and Agent context do not leak session cookies and successfully interact.
</verification>

<success_criteria>
- The registration flow runs without `waitForTimeout`.
- The multi-actor flow effectively proves that Overseer-provisioned data is immediately usable by Agents.
</success_criteria>

<output>
After completion, create `.planning/phases/31-end-to-end-test-implementation/31-02-SUMMARY.md`
</output>
