---
phase: 31-end-to-end-test-implementation
plan: 03
type: execute
wave: 3
depends_on: ["31-01"]
files_modified:
  - test/e2e/subscription-flow.spec.ts
  - test/e2e/shadow-claim.spec.ts
  - test/e2e/fixtures/paddle.ts
autonomous: true
must_haves:
  truths:
    - "Developer can test real Paddle sandbox checkout flows via cross-origin iframes"
    - "Subscription tests verify asynchronous webhook outcomes using expect.poll()"
    - "Agent can complete a shadow claim payment flow"
  artifacts:
    - path: "test/e2e/subscription-flow.spec.ts"
      provides: "Subscription checkout tests"
      contains: "frameLocator"
    - path: "test/e2e/shadow-claim.spec.ts"
      provides: "Shadow claim tests"
  key_links:
    - from: "test/e2e/subscription-flow.spec.ts"
      to: "backend/src/routes/test-utils.ts"
      via: "webhook injection"
      pattern: "/v1/test/inject-webhook"
---

<objective>
Implement end-to-end tests validating third-party Paddle Checkouts and asynchronous webhooks.

Purpose: Test the critical path for user payments by securely filling out sandbox card information in a cross-origin iframe and mocking the resulting webhook to verify the system correctly processes asynchronous outcomes.
Output: Refactored `subscription-flow.spec.ts` handling real checkouts, and a new `shadow-claim.spec.ts` for one-time payments.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@test/e2e/subscription-flow.spec.ts
@backend/src/routes/test-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Paddle Sandbox Checkout & Polling</name>
  <files>test/e2e/subscription-flow.spec.ts, test/e2e/fixtures/paddle.ts</files>
  <action>
    Create a helper `test/e2e/fixtures/paddle.ts` that exports `injectTestWebhook(payload)`. It should `POST /v1/test/inject-webhook`.
    Refactor `subscription-flow.spec.ts` to remove the `.skip` conditional and `waitForTimeout` calls.
    Navigate to the subscription page, click the upgrade button, and pierce the iframe using Playwright's native iframe support:
    `const checkoutFrame = page.frameLocator('iframe[title*="Paddle"]')` or similar.
    Wait for and fill out the sandbox test card `4242 4242 ...` and submit.
    Once the UI indicates success, construct a mock `subscription.created` webhook payload (matching Paddle's expected structure) and call `injectTestWebhook`.
    Finally, use `expect.poll` repeatedly fetching `/v1/overseers/me` (or checking the UI) until the subscription status flips to `active`.
  </action>
  <verify>Test navigates the external iframe, submits test payment, injects webhook, and successfully polls for state change.</verify>
  <done>Real third-party checkout integration verified automatically without flaky networking tunnels</done>
</task>

<task type="auto">
  <name>Task 2: Implement Shadow Claim Workflow Test</name>
  <files>test/e2e/shadow-claim.spec.ts</files>
  <action>
    Create a new test file `shadow-claim.spec.ts` covering the one-time payment shadow claim flow.
    Setup: Register a regular Client locally using a test script/helper (unclaimed state).
    Flow: Agent attempts an OAuth flow with this unregistered Client ID and gets redirected to the shadow claim payment UI.
    Action: Agent clicks 'Claim Now', Playwright targets the Paddle iframe via `frameLocator`, fills the sandbox card, and submits.
    After payment success screen, inject a `transaction.completed` webhook via `injectTestWebhook`.
    Assert: Use `expect.poll` to wait for the UI to display the ownership transfer success message.
  </action>
  <verify>`npm run test:e2e shadow-claim` successfully performs an unauthorized OAuth, completes checkout, and claims the client.</verify>
  <done>One-time payment and ownership transfer flows verified end-to-end</done>
</task>

</tasks>

<verification>
Run `npm run test:e2e` to verify both the `subscription-flow.spec.ts` and `shadow-claim.spec.ts` run sequentially or concurrently and pass their webhook polling assertions.
</verification>

<success_criteria>
- Developer successfully uses `frameLocator` for Paddle checkout.
- Subscription tests pass through a complete sandbox checkout.
- Asynchronous webhooks correctly trigger application state changes, verified via `expect.poll`.
</success_criteria>

<output>
After completion, create `.planning/phases/31-end-to-end-test-implementation/31-03-SUMMARY.md`
</output>
