---
phase: 31-end-to-end-test-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/playwright.config.ts
  - backend/src/index.ts
  - backend/src/routes/test-utils.ts
  - test/e2e/setup/global.setup.ts
  - package.json
autonomous: true
must_haves:
  truths:
    - "Playwright automatically starts frontend and backend servers when running E2E tests"
    - "Developer can reset the test database between test runs"
    - "Developer can simulate Paddle webhooks locally without an external tunnel"
  artifacts:
    - path: "test/e2e/playwright.config.ts"
      provides: "Web server configuration"
      contains: "webServer"
    - path: "backend/src/routes/test-utils.ts"
      provides: "Test API endpoints"
      exports: ["/reset-db", "/inject-webhook"]
    - path: "test/e2e/setup/global.setup.ts"
      provides: "Database reset before suite"
  key_links:
    - from: "test/e2e/playwright.config.ts"
      to: "test/e2e/setup/global.setup.ts"
      via: "globalSetup property"
      pattern: "globalSetup.*global\\.setup\\.ts"
---

<objective>
Configure Playwright infrastructure for autonomous full-stack end-to-end testing without external network dependencies for webhooks.

Purpose: Enable tests to automatically spin up isolated instances of the frontend and backend, reset state before each suite runs, and simulate external webhook callbacks reliably.
Output: An updated Playwright configuration with webServers and new test-only backend endpoints.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@test/e2e/playwright.config.ts
@backend/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Test Endpoints to Backend</name>
  <files>backend/src/routes/test-utils.ts, backend/src/index.ts</files>
  <action>
    Create a new Hono router in `backend/src/routes/test-utils.ts`. It should export a router with two POST routes:
    1. `/reset-db` (executes raw SQL to `DELETE FROM clients; DELETE FROM shadow_claims; DELETE FROM subscriptions; DELETE FROM agents; DELETE FROM overseers;` using `c.env.DB.exec` and returns a success JSON).
    2. `/inject-webhook` (receives a Paddle webhook JSON payload from `c.req.json()` and directly imports/calls the appropriate handlers from `backend/src/routes/webhooks.ts` such as `handlePaymentSuccess`, `handleTierUpdate`, etc. based on `event_type`, completely bypassing Paddle signature checks).
    In `backend/src/index.ts`, import `test-utils` and mount it:
    `if (app.env?.ENVIRONMENT === 'development' || process.env.NODE_ENV === 'test') { app.route('/v1/test', testUtils); }`
    (Note: Check `c.env.ENVIRONMENT` within a middleware or directly register the route but protect it by checking `c.env.ENVIRONMENT` inside the handler).
  </action>
  <verify>Backend exposes `/v1/test/reset-db` which successfully clears tables, and `/v1/test/inject-webhook` which can mock webhook delivery.</verify>
  <done>Utility endpoints allow Playwright to control test state and external events</done>
</task>

<task type="auto">
  <name>Task 2: Configure Playwright WebServers and Setup</name>
  <files>test/e2e/playwright.config.ts, test/e2e/setup/global.setup.ts, package.json</files>
  <action>
    Update `test/e2e/playwright.config.ts` to include a `webServer` array starting the backend (`command: "cd ../../backend && npm run dev"`, port: 8787) and frontend (`command: "cd ../../frontend && npm run dev"`, port: 3000) with `reuseExistingServer: !process.env.CI`.
    Set `globalSetup: './setup/global.setup.ts'` in the config.
    Create `test/e2e/setup/global.setup.ts` which uses a basic `fetch('http://localhost:8787/v1/test/reset-db', { method: 'POST' })` to clear DB before E2E tests begin.
    Add a new script to root `package.json`: `"test:e2e": "cd test/e2e && npm run test"`.
  </action>
  <verify>`npm run test:e2e` starts both servers automatically and executes global setup successfully.</verify>
  <done>Playwright can orchestrate its own full-stack environment</done>
</task>

</tasks>

<verification>
Run `npm run test:e2e` from the project root and ensure the Playwright runner starts, correctly executing `global.setup.ts` and reaching out to the `/v1/test/reset-db` endpoint successfully.
</verification>

<success_criteria>
- Backend provides test utilities that can truncate DB state and mock webhooks.
- Playwright manages the lifecycles of both frontend and backend automatically.
- E2E testing doesn't require manual server startup.
</success_criteria>

<output>
After completion, create `.planning/phases/31-end-to-end-test-implementation/31-01-SUMMARY.md`
</output>
