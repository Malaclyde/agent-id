---
phase: 13-frontend-oauth-usage-bugfix
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/workers/api/subscriptions/usage.ts
  - src/workers/api/subscriptions/index.ts
  - src/shared/paddle-types.ts
  - frontend/src/api/client.ts
  - frontend/src/pages/SubscriptionManagement.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "/v1/subscriptions/usage returns oauth_count in the usage object"
    - "OAuth usage display shows actual count instead of '0/unlimited'"
    - "Frontend SubscriptionManagement page displays correct OAuth usage"
  artifacts:
    - path: "src/workers/api/subscriptions/usage.ts"
      provides: "OAuth count function and usage endpoint"
      exports: ["getOauthUsageCount", "GET /v1/subscriptions/usage"]
    - path: "src/workers/api/subscriptions/index.ts"
      provides: "Route registration for usage endpoint"
    - path: "frontend/src/pages/SubscriptionManagement.tsx"
      provides: "OAuth usage display"
  key_links:
    - from: "src/workers/api/subscriptions/usage.ts"
      to: "d1 database"
      via: "SQL query to count OAuth requests"
      pattern: "SELECT.*oauth_requests"
    - from: "frontend/src/pages/SubscriptionManagement.tsx"
      to: "/v1/subscriptions/usage"
      via: "api.getSubscriptionUsage()"
---

<objective>
Fix the missing oauth_count in /v1/subscriptions/usage endpoint so the frontend correctly displays OAuth usage instead of showing "0/unlimited".
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

## Phase 13 Requirements (from ROADMAP.md)

**FIX-OAUTH-01:** Add function to count total OAuth requests across all agents for an overseer
**FIX-OAUTH-02:** Update /v1/subscriptions/usage endpoint to return oauth_count
**FIX-OAUTH-03:** Update TypeScript types if needed
**FIX-OAUTH-04:** Verify frontend displays OAuth usage correctly

## Success Criteria

1. /v1/subscriptions/usage returns oauth_count in the usage object
2. OAuth usage display shows actual count (e.g., "5/10" or "5/unlimited") instead of "0/unlimited"
3. Frontend SubscriptionManagement page displays correct OAuth usage for the subscription tier
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research current implementation</name>
  <files>
    - src/workers/api/subscriptions/usage.ts
    - src/workers/api/subscriptions/index.ts
    - frontend/src/pages/SubscriptionManagement.tsx
    - src/shared/paddle-types.ts
  </files>
  <action>
    Read the current implementation files to understand:
    1. How /v1/subscriptions/usage endpoint currently works
    2. What it returns (check if oauth_count is missing)
    3. How the frontend displays OAuth usage
    4. What TypeScript types are used

    Search for "oauth" in the codebase to find relevant tables and functions.
  </action>
  <verify>Read and understand the current implementation</verify>
  <done>Understand current oauth_count state and what needs to be added</done>
</task>

<task type="auto">
  <name>Task 2: Add getOauthUsageCount function and update usage endpoint</name>
  <files>
    - src/workers/api/subscriptions/usage.ts
  </files>
  <action>
    1. Add getOauthUsageCount(overseerId) function that queries the database to count total OAuth requests across all agents owned by the overseer
    2. Update the GET /v1/subscriptions/usage handler to include oauth_count in the response
    3. The endpoint should return: { agents_count, clients_count, oauth_count, subscription }

    Look for the oauth_requests or similar table in the database schema.
  </action>
  <verify>Endpoint returns oauth_count in response</verify>
  <done>/v1/subscriptions/usage returns oauth_count field</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript types if needed</name>
  <files>
    - src/shared/paddle-types.ts
  </files>
  <action>
    Check if SubscriptionUsage type in paddle-types.ts needs to include oauth_count field. If so, add it.
  </action>
  <verify>Type definition includes oauth_count</verify>
  <done>Types are updated to include oauth_count</done>
</task>

<task type="auto">
  <name>Task 4: Verify frontend displays OAuth usage correctly</name>
  <files>
    - frontend/src/pages/SubscriptionManagement.tsx
    - frontend/src/api/client.ts
  </files>
  <action>
    1. Check the frontend API client to ensure it fetches from /v1/subscriptions/usage
    2. Check SubscriptionManagement.tsx to see how OAuth usage is displayed
    3. Verify the frontend properly renders oauth_count from the usage response
    4. If the frontend shows "0/unlimited" or hardcoded value, update it to use the actual oauth_count
  </action>
  <verify>Frontend shows actual OAuth count</verify>
  <done>SubscriptionManagement page displays correct OAuth usage (e.g., "5/10" not "0/unlimited")</done>
</task>

</tasks>

<verification>
1. Call GET /v1/subscriptions/usage and verify oauth_count is in response
2. Check frontend displays actual count from API, not hardcoded value
</verification>

<success_criteria>
- [ ] /v1/subscriptions/usage returns oauth_count in the usage object
- [ ] OAuth usage display shows actual count instead of "0/unlimited"
- [ ] Frontend SubscriptionManagement page displays correct OAuth usage
</success_criteria>

<output>
After completion, create `.planning/phases/13-frontend-oauth-usage-bugfix/13-01-SUMMARY.md`
</output>
