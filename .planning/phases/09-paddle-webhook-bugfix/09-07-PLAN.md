---
phase: 09-paddle-webhook-bugfix
plan: 07
type: execute
wave: 3
depends_on: [09-01, 09-02, 09-03, 09-04, 09-05, 09-06]
files_modified: [backend/src/redacted/webhook-security.ts, backend/src/routes/webhooks.ts]
autonomous: true

must_haves:
  truths:
    - "Paddle webhooks return 200 OK, not 401"
    - "Webhook endpoint processes events correctly"
    - "customer.created events link Paddle customer to overseer"
  artifacts:
    - path: "backend/src/routes/webhooks.ts"
      provides: "Working webhook endpoint"
      returns_200: true
      not_returns_401: true
    - path: "backend/src/redacted/webhook-security.ts"
      provides: "Working signature verification"
      verification_works: true
  key_links:
    - from: "Paddle dashboard"
      to: "backend/src/routes/webhooks.ts"
      via: "POST /v1/webhooks/paddle"
      webhook_receives_200: true
---

<objective>
Fix the 401 authentication error that prevents all Paddle webhooks from being processed.

Purpose: This is an ABSOLUTE PRIORITY - the /v1/webhooks/paddle endpoint returns 401 for ALL valid Paddle requests. This causes the entire subscription system to fail because:
- No payment events are processed
- No customer records are created
- Subscriptions never activate
- No subscription information exists in the database

The user has tested with real Paddle webhooks (via Hookdeck) and confirmed:
- Valid paddle-signature header is present: `ts=1771082749;h1=e3d188f...`
- But the endpoint returns 401 with "Invalid signature"

This plan validates if the issue still persists after previous signature fixes, and if so, identifies and fixes the root cause.

Output: Working webhook endpoint that accepts valid Paddle webhooks and returns 200 OK.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/09-paddle-webhook-bugfix/09-RESEARCH.md

@backend/src/routes/webhooks.ts
@backend/src/redacted/webhook-security.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate if 401 issue still persists</name>
  <files>backend/src/redacted/webhook-security.ts</files>
  <action>
    Before making any changes, verify the current state:

    1. Check if the signature delimiter bug (`.` → `:`) was fixed in 09-01:
       - Run: `grep -n "dataToSign" backend/src/redacted/webhook-security.ts`
       - Expected: `const dataToSign = \`${timestamp}:${payload}\``
       - If it shows `.` instead of `:`, the fix from 09-01 hasn't been applied yet

    2. Test webhook endpoint locally or with a test request:
       - Send a test Paddle webhook to /v1/webhooks/paddle
       - Verify response is 200 OK, not 401

    3. If 401 still occurs after confirming delimiter is fixed, investigate further:
       - Check if PADDLE_WEBHOOK_SECRET is being read correctly
       - Check if the raw body is being used (not parsed/re-serialized)
       - Check if there are any transformations happening to the payload

    Document the findings: Does the issue still persist after the signature delimiter fix?
  </action>
  <verify>
    Run `grep -n "dataToSign.*:" backend/src/redacted/webhook-security.ts` to confirm colon is used. Test webhook endpoint with valid Paddle request - should return 200, not 401.
  </verify>
  <done>
    Documented whether the 401 issue persists after signature delimiter fix.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix root cause if issue persists</name>
  <files>backend/src/redacted/webhook-security.ts, backend/src/routes/webhooks.ts</files>
  <action>
    If Task 1 confirms the issue still exists after confirming the delimiter fix, investigate and fix:

    Common causes for 401 despite correct signature:
    1. **Secret not loaded**: Check `c.env.PADDLE_WEBHOOK_SECRET` is defined
       - Add debug logging to confirm secret is present (then remove after fix)

    2. **Body transformation**: Verify raw body is used
       - The code uses `await c.req.text()` which should be correct
       - Check no JSON parsing happens before signature verification

    3. **Timestamp tolerance**: Check if timestamp validation is too strict
       - Current code allows 5 minutes (300 seconds)
       - Verify this matches Paddle's recommendation

    4. **Encoding issues**: Check if payload encoding matches what Paddle sends
       - Verify UTF-8 encoding is used consistently

    5. **Hookdeck transformation**: If using Hookdeck, verify they don't modify the body
       - Check x-hookdeck-signature header vs paddle-signature

    Fix whatever is causing the 401. Add specific debug logging to identify the exact failure point.
  </action>
  <verify>
    After fix, test webhook endpoint with valid Paddle request - should return 200 OK with `{success: true, received: true}`. Verify customer.created events are processed and link to overseers.
  </verify>
  <done>
    Webhook endpoint returns 200 OK for valid Paddle requests. Customer.created events are processed correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end flow works</name>
  <files>backend/src/services/webhook-handler.ts</files>
  <action>
    After the 401 fix is confirmed working, verify the complete flow:

    1. Send a customer.created webhook
    2. Verify the customer is linked to the correct overseer (by email)
    3. Check database to confirm paddle_customer_id was updated

    This ensures not only that authentication works, but that the webhook processing actually succeeds.
  </action>
  <verify>
    Send test webhook, verify response is 200. Query database to confirm customer was linked. Check logs for successful processing.
  </verify>
  <done>
    End-to-end webhook flow works: authentication passes → event processed → data updated in database.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. POST /v1/webhooks/paddle returns 200 OK (not 401) for valid Paddle requests
2. customer.created events are processed and link Paddle customer to overseer
3. Database shows paddle_customer_id updated for matching overseer
4. No authentication errors in logs
5. All previous webhook fixes still work (signature, event names, etc.)
</verification>

<success_criteria>
- Webhook endpoint returns 200 OK for valid Paddle webhooks
- 401 error is resolved
- Customer.created events process correctly
- Subscription system becomes functional (webhooks can be received)
</success_criteria>

<output>
After completion, create `.planning/phases/09-paddle-webhook-bugfix/09-07-SUMMARY.md`
</output>
