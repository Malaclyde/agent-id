---
phase: 09-paddle-webhook-bugfix
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [backend/src/routes/webhooks.ts]
autonomous: true

must_haves:
  truths:
    - "Shadow claims use real Paddle event types"
    - "Fake 'payment.shadow_claim_succeeded' event removed"
    - "Shadow claims can be processed via transaction.completed"
  artifacts:
    - path: "backend/src/routes/webhooks.ts"
      provides: "Real Paddle event handling for shadow claims"
      not_contains: "payment.shadow_claim_succeeded"
  key_links:
    - from: "backend/src/routes/webhooks.ts"
      to: "backend/src/services/webhook-handler.ts"
      via: "handleShadowClaimPayment call"
      pattern: "handleShadowClaimPayment"
---

<objective>
Remove the fake Paddle event and implement real shadow claim handling using valid Paddle event types.

Purpose: This is Priority 3 - the code currently handles `payment.shadow_claim_succeeded` which is NOT a real Paddle webhook event type. This means shadow claim payments will never be processed correctly, breaking the shadow claim feature entirely. Paddle provides real events like `transaction.completed` and `subscription.created` that should be used instead.

Output: Webhook handler that uses real Paddle event types for shadow claims, checking custom_data to identify shadow claim transactions.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/09-paddle-webhook-bugfix/09-RESEARCH.md

@backend/src/routes/webhooks.ts
@backend/src/services/webhook-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove fake event and add shadow claim handling to transaction.completed</name>
  <files>backend/src/routes/webhooks.ts</files>
  <action>
    1. Remove lines 138-141 (the fake `payment.shadow_claim_succeeded` case):
    ```typescript
    case 'payment.shadow_claim_succeeded':
      // Custom event for shadow claims
      await handleShadowClaimPayment(eventData, c.env.DB, c.env);
      break;
    ```
    
    2. Modify the existing `payment.succeeded` case (line 117) to check for shadow claims:
    
    Current code at lines 117-120:
    ```typescript
    case 'payment.succeeded':
    case 'subscription.activated':
      await handlePaymentSuccess(eventData, c.env.DB, c.env);
      break;
    ```
    
    Replace with:
    ```typescript
    case 'payment.succeeded':
      // Check if this is a shadow claim via custom_data
      if (eventData.custom_data?.is_shadow_claim) {
        await handleShadowClaimPayment(eventData, c.env.DB, c.env);
      } else {
        await handlePaymentSuccess(eventData, c.env.DB, c.env);
      }
      break;
    case 'subscription.activated':
      await handlePaymentSuccess(eventData, c.env.DB, c.env);
      break;
    ```
    
    This allows shadow claims to be processed through the real `payment.succeeded` event by checking the `is_shadow_claim` flag in custom_data. The `handleShadowClaimPayment` function will be called with the correct payload structure.
  </action>
  <verify>
    Run `grep -n "payment.shadow_claim_succeeded" backend/src/routes/webhooks.ts` to confirm the fake event is removed. Run `grep -A 5 "case 'payment.succeeded':" backend/src/routes/webhooks.ts` to verify the shadow claim check is present. Run `npm test -- backend/test/unit/webhook-handler.test.ts` to ensure tests pass.
  </verify>
  <done>
    The fake `payment.shadow_claim_succeeded` event handler is removed. Shadow claims are now processed via the real `payment.succeeded` event by checking `eventData.custom_data?.is_shadow_claim`.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. No occurrences of `payment.shadow_claim_succeeded` in webhooks.ts
2. The `payment.succeeded` case checks for `is_shadow_claim` in custom_data
3. The `subscription.activated` case remains unchanged
4. Shadow claims can be processed via handleShadowClaimPayment function
5. Unit tests pass
</verification>

<success_criteria>
- Fake Paddle event removed
- Shadow claims use real `payment.succeeded` event
- Custom data check identifies shadow claims
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-paddle-webhook-bugfix/09-03-SUMMARY.md`
</output>
