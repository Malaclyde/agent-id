---
phase: 09-paddle-webhook-bugfix
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [backend/src/redacted/webhook-security.ts, backend/src/routes/webhooks.ts]
autonomous: true

must_haves:
  truths:
    - "Debug logging removed from production code"
    - "TODO comment about paddle middleware removed"
    - "Code quality improved without changing functionality"
  artifacts:
    - path: "backend/src/redacted/webhook-security.ts"
      provides: "Clean security code without debug logs"
      not_contains: "console.log('Paddle signature format'"
    - path: "backend/src/routes/webhooks.ts"
      provides: "Clean handler code without misleading TODOs"
      not_contains: "TODO: use paddle middleware"
  key_links:
    - from: "backend/src/redacted/webhook-security.ts"
      to: "backend/src/routes/webhooks.ts"
      via: "Clean verification code"
      pattern: "verifyPaddleSignature"
---

<objective>
Remove debug logging and misleading TODO comments to improve code quality.

Purpose: This is Priority 6 & 7 - lines 333-337 of webhook-security.ts contain debug logging that may leak sensitive information in production. Additionally, line 29 of webhooks.ts has a TODO comment suggesting "use paddle middleware" which is misleading because Paddle's SDK doesn't provide middleware and manual verification is the official approach. This plan removes these issues.

Output: Cleaned code with debug logging removed and misleading TODOs replaced with clarifying comments.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/09-paddle-webhook-bugfix/09-RESEARCH.md

@backend/src/redacted/webhook-security.ts
@backend/src/routes/webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove debug logging from webhook-security.ts</name>
  <files>backend/src/redacted/webhook-security.ts</files>
  <action>
    Remove lines 333-337 which contain debug logging:
    
    Current code at lines 333-337:
    ```typescript
    // Debug logging to help identify which format Paddle is sending
    console.log('Paddle signature format:', {
      hasH1: !!h1Part,
      hasV1: !!v1Part,
      timestamp: timestamp?.substring(0, 10)
    });
    ```
    
    Remove these lines entirely. The signature verification code already supports both h1= and v1= formats (verified in code at lines 320-324), so this debug logging is unnecessary and may leak timing information or signature format details to production logs.
    
    Do NOT remove any other code. The timestamp validation, signature computation, and constant-time comparison must remain unchanged.
  </action>
  <verify>
    Run `grep -n "Paddle signature format" backend/src/redacted/webhook-security.ts` to confirm the debug logging is removed. Run `npm test -- backend/test/unit/webhook-security.test.ts` to ensure signature verification tests still pass.
  </verify>
  <done>
    Debug logging removed from webhook-security.ts. Signature verification continues to support both h1= and v1= formats without leaking information to logs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove misleading TODO comment in webhooks.ts</name>
  <files>backend/src/routes/webhooks.ts</files>
  <action>
    Remove or replace the misleading TODO comment at line 29:
    
    Current code at lines 28-29:
    ```typescript
    async function validateWebhook(c: any, next: any) {
      try {
        // Get headers
        // TODO: use paddle middleware
    ```
    
    Replace with:
    ```typescript
    async function validateWebhook(c: any, next: any) {
      try {
        // Get headers
        // Manual signature verification is used because Paddle's SDK doesn't provide middleware
        // Reference: https://developer.paddle.com/webhooks/signature-verification
    ```
    
    This clarifies that manual verification is the official Paddle approach, not a missing feature. The original TODO was misleading because it suggested using Paddle middleware which doesn't exist.
  </action>
  <verify>
    Run `grep -n "TODO: use paddle middleware" backend/src/routes/webhooks.ts` to confirm the TODO is removed. Run `grep -n "Manual signature verification" backend/src/routes/webhooks.ts` to confirm the clarifying comment is present.
  </verify>
  <done>
    Misleading TODO comment removed and replaced with clarifying comment explaining that manual verification is Paddle's official approach.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. No debug logging remains in webhook-security.ts (especially "Paddle signature format")
2. No TODO comment about paddle middleware remains
3. Clarifying comment explains manual verification is official Paddle approach
4. Signature verification still works (tests pass)
5. No functionality was changed
</verification>

<success_criteria>
- Debug logging removed
- Misleading TODO removed
- Clarifying comment added
- No functionality changed
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-paddle-webhook-bugfix/09-06-SUMMARY.md`
</output>
