---
phase: 09-paddle-webhook-bugfix
plan: 04
type: execute
wave: 2
depends_on: [09-01]
files_modified: [backend/src/redacted/webhook-security.ts, backend/src/routes/webhooks.ts]
autonomous: true

must_haves:
  truths:
    - "Replay attacks are prevented via event ID deduplication"
    - "Same webhook processed only once within 24 hours"
    - "Duplicate webhooks return success without re-processing"
  artifacts:
    - path: "backend/src/redacted/webhook-security.ts"
      provides: "Event ID deduplication functions"
      exports: ["isEventProcessed", "markEventProcessed"]
    - path: "backend/src/routes/webhooks.ts"
      provides: "Replay protection in webhook handler"
      contains: "isEventProcessed"
  key_links:
    - from: "backend/src/routes/webhooks.ts"
      to: "backend/src/redacted/webhook-security.ts"
      via: "isEventProcessed and markEventProcessed calls"
      pattern: "isEventProcessed.*markEventProcessed"
---

<objective>
Implement event ID deduplication to prevent replay attacks on Paddle webhooks.

Purpose: This is Priority 4 - currently no replay protection exists. Attackers can replay valid webhooks within the 5-minute timestamp window, triggering handlers multiple times. Paddle recommends using `event_id` for deduplication (not nonce). The `checkPaddleNonce()` function exists but is never called. This plan implements the recommended approach using event_id deduplication.

Output: Event deduplication functions in webhook-security.ts and integration in webhooks.ts to prevent replay attacks.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/ROADMAP.md
@.planning/phases/09-paddle-webhook-bugfix/09-RESEARCH.md

@backend/src/redacted/webhook-security.ts
@backend/src/routes/webhooks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event ID deduplication functions to webhook-security.ts</name>
  <files>backend/src/redacted/webhook-security.ts</files>
  <action>
    Add the following two functions at the end of the file (after the existing checkPaddleNonce function):
    
    ```typescript
    /**
     * Check if a Paddle webhook event has already been processed
     * 
     * Uses event_id for deduplication per Paddle's recommendation.
     * This prevents replay attacks where the same webhook is sent multiple times.
     * 
     * @param env - Environment with RATE_LIMITS KV namespace
     * @param eventId - Paddle event_id from webhook payload
     * @returns true if event was already processed, false otherwise
     * 
     * @example
     * if (await isEventProcessed(env, data.event_id)) {
     *   return c.json({ success: true, received: true });
     * }
     */
    export async function isEventProcessed(
      env: { RATE_LIMITS: KVNamespace },
      eventId: string
    ): Promise<boolean> {
      const key = `paddle:event:${eventId}`;
      const existing = await env.RATE_LIMITS.get(key);
      return existing !== null;
    }
    
    /**
     * Mark a Paddle webhook event as processed
     * 
     * Stores event_id in KV for 24 hours to prevent replay attacks.
     * Paddle retries for up to 3 days, but 24 hours is sufficient for
     * most replay scenarios while keeping storage minimal.
     * 
     * @param env - Environment with RATE_LIMITS KV namespace
     * @param eventId - Paddle event_id from webhook payload
     * 
     * @example
     * await markEventProcessed(env, data.event_id);
     */
    export async function markEventProcessed(
      env: { RATE_LIMITS: KVNamespace },
      eventId: string
    ): Promise<void> {
      const key = `paddle:event:${eventId}`;
      // Store for 24 hours (86400 seconds)
      await env.RATE_LIMITS.put(key, '1', { expirationTtl: 86400 });
    }
    ```
    
    These functions implement Paddle's recommended approach for replay protection using event_id deduplication. The 24-hour TTL is sufficient because Paddle's retry window is much shorter.
  </action>
  <verify>
    Run `grep -n "export async function isEventProcessed" backend/src/redacted/webhook-security.ts` to confirm the function exists. Run `grep -n "export async function markEventProcessed" backend/src/redacted/webhook-security.ts` to confirm the second function exists.
  </verify>
  <done>
    Two new functions (isEventProcessed and markEventProcessed) exist in webhook-security.ts and are exported for use in webhooks.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate event deduplication in webhooks.ts</name>
  <files>backend/src/routes/webhooks.ts</files>
  <action>
    1. Add the new imports at the top of the file (after existing imports):
    ```typescript
    import {
      verifyPaddleSignature,
      checkRateLimit,
      isEventProcessed,
      markEventProcessed
    } from '../redacted/webhook-security';
    ```
    
    2. Add deduplication check in the POST /webhooks/paddle handler (after line 99, before the switch statement):
    
    Current code at lines 89-108:
    ```typescript
    webhooks.post('/paddle', validateWebhook, async (c) => {
      try {
      const payload = c.get('validatedPayload');
      if (!payload) {
        return c.json({
          success: false,
          error: 'Validated payload not found'
        }, 500);
      }
    
      const data = JSON.parse(payload);
    
      // Paddle webhook format:
      // {
      //   "event_id": "evt_xxx",
      //   "event_type": "payment.succeeded" | "subscription.activated" | etc,
      //   "data": { ... }
      // }
    
      const eventType = data.event_type;
      const eventData = data.data;
    
      // Route to appropriate handler based on event type
      switch (eventType) {
    ```
    
    Replace with:
    ```typescript
    webhooks.post('/paddle', validateWebhook, async (c) => {
      try {
      const payload = c.get('validatedPayload');
      if (!payload) {
        return c.json({
          success: false,
          error: 'Validated payload not found'
        }, 500);
      }
    
      const data = JSON.parse(payload);
    
      // Paddle webhook format:
      // {
      //   "event_id": "evt_xxx",
      //   "event_type": "payment.succeeded" | "subscription.activated" | etc,
      //   "data": { ... }
      // }
    
      // Check for duplicate event (Paddle recommendation for replay protection)
      if (await isEventProcessed(c.env, data.event_id)) {
        return c.json({
          success: true,
          received: true,
          duplicate: true
        });
      }
    
      const eventType = data.event_type;
      const eventData = data.data;
    
      // Route to appropriate handler based on event type
      switch (eventType) {
    ```
    
    3. Add markEventProcessed call at the end of the handler (before the return statement at line 153):
    
    Current code at lines 152-156:
    ```typescript
    return c.json({
      success: true,
      received: true
    });
    ```
    
    Replace with:
    ```typescript
    // Mark event as processed to prevent replay
    await markEventProcessed(c.env, data.event_id);
    
    return c.json({
      success: true,
      received: true
    });
    ```
    
    This implements the full replay protection flow: check before processing, mark after processing.
  </action>
  <verify>
    Run `grep -n "isEventProcessed" backend/src/routes/webhooks.ts` to confirm the check is present. Run `grep -n "markEventProcessed" backend/src/routes/webhooks.ts` to confirm the marking is present. Run `npm test -- backend/test/unit/webhook-handler.test.ts` to ensure tests pass.
  </verify>
  <done>
    Webhook handler checks for duplicate events using isEventProcessed before processing, and marks events as processed using markEventProcessed after successful handling. Replay attacks are prevented.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. isEventProcessed and markEventProcessed functions exist in webhook-security.ts
2. Both functions are imported in webhooks.ts
3. isEventProcessed check exists before the switch statement
4. markEventProcessed call exists before the return statement
5. Duplicate events return success with duplicate: true flag
6. Unit tests pass
</verification>

<success_criteria>
- Event ID deduplication implemented
- Replay attacks prevented
- Paddle's recommended approach used
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-paddle-webhook-bugfix/09-04-SUMMARY.md`
</output>
