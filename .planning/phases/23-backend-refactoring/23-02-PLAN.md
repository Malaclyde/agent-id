---
phase: 23-backend-refactoring
plan: 02
type: execute
wave: 1
depends_on: [23-01]
files_modified:
  - backend/src/routes/agents.ts
  - backend/src/utils/helpers.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - Challenge expires_at is correctly set to 60 minutes after creation time
    - No debug console.log statements in production code
    - Shadow claim challenges expire correctly after 60 minutes
  artifacts:
    - path: backend/src/routes/agents.ts
      provides: Clean production code without debug statements
      min_lines: 1
    - path: backend/src/utils/helpers.ts
      provides: Correctly functioning getExpirationTime
      min_lines: 1
  key_links:
    - from: POST /v1/agents/malice/:agentId
      to: getExpirationTime(60)
      via: Function call
      pattern: Returns ISO string 60 minutes in future
---

<objective>
Fix the getExpirationTime bug causing challenge expiration to equal creation time, and remove debug console.log statements from production code.

Purpose: Ensure shadow claim challenges correctly expire after 60 minutes as specified, and clean up debugging code that was left in production.
Output: Fixed helpers.ts and cleaned agents.ts with working expiration times.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-refactoring/23-UAT.md
@.planning/phases/23-backend-refactoring/23-01-SUMMARY.md

@backend/src/routes/agents.ts
@backend/src/utils/helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix getExpirationTime function</name>
  <files>backend/src/utils/helpers.ts</files>
  <action>
    Investigate and fix the getExpirationTime function (lines 13-17) which is returning incorrect expiration times:

    Current code:
    ```typescript
    export function getExpirationTime(minutes: number): string {
      const date = new Date();
      date.setMinutes(date.getMinutes() + minutes);
      return date.toISOString();
    }
    ```

    The issue: The function looks correct but may have issues with:
    1. Date mutation across calls (if the same Date object is being reused)
    2. Timezone or DST issues
    3. setMinutes affecting other date components

    Fix options to try:
    Option A (Recommended): Create a new Date from timestamp to avoid mutation issues
    ```typescript
    export function getExpirationTime(minutes: number): string {
      const now = Date.now();
      const expirationTime = now + minutes * 60 * 1000;
      return new Date(expirationTime).toISOString();
    }
    ```

    Option B: Use setTime for clarity
    ```typescript
    export function getExpirationTime(minutes: number): string {
      const date = new Date();
      date.setTime(date.getTime() + minutes * 60 * 1000);
      return date.toISOString();
    }
    ```

    Verify the fix by checking that the returned ISO string is exactly [minutes] minutes in the future.
  </action>
  <verify>
    - TypeScript compiles: cd backend && npx tsc --noEmit
    - Unit tests pass: Check if helpers.test.ts has getExpirationTime tests
    - Manual verification: Create a test that calls getExpirationTime(60) and verifies it's ~60 minutes ahead
  </verify>
  <done>
    getExpirationTime returns correct ISO string with proper future timestamp
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove debug console.log statements</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Remove all debug console.log statements marked with TODO comments from agents.ts:

    1. Line 743: `console.log(claimData) // TODO delete`
       - Remove this line - it was for debugging the shadow claim challenge creation

    2. Line 626: `console.log(challengeData) // TODO: DELETE`
       - Remove this line - it was for debugging the status endpoint

    Search for any other TODO comments related to debugging:
    - Look for patterns like "TODO", "FIXME", "DEBUG", "console.log"
    - Remove all debugging code that shouldn't be in production

    Do NOT remove legitimate TODOs that indicate planned features or improvements.
  </action>
  <verify>
    - Search confirms no "TODO delete", "TODO: DELETE", or debug console.log patterns remain
    - TypeScript compiles without errors
    - No functional changes to endpoint behavior (only log removal)
  </verify>
  <done>
    All debug console.log statements removed from agents.ts
  </done>
</task>

</tasks>

<verification>
1. getExpirationTime(60) returns a timestamp exactly 60 minutes in the future
2. getExpirationTime(5) returns a timestamp exactly 5 minutes in the future  
3. No console.log statements with TODO comments remain in agents.ts
4. TypeScript compilation succeeds
5. Existing tests pass
</verification>

<success_criteria>
- getExpirationTime correctly calculates future timestamps
- Shadow claim challenges have expires_at set to 60 minutes in the future
- Debug console.log statements removed from production code
- Backend compiles without errors
</success_criteria>

<output>
After completion, update `.planning/phases/23-backend-refactoring/23-UAT.md` with verification results
</output>
