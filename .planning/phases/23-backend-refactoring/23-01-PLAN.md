---
phase: 23-backend-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/agents.ts
autonomous: true

must_haves:
  truths:
    - Shadow claim initiation creates claim challenges (prefix 'claim:') not payment challenges
    - Claim challenge includes isShadow: true, shadow_overseer_id, agent_id, status: 'initiated'
    - Shadow claim challenges have 60-minute TTL (3600 seconds)
    - Status endpoint returns: initiated, awaiting-payment, completed, expired
    - Legacy payment challenge endpoints removed entirely
    - Regular claim flow unchanged (5-minute TTL, no isShadow flag)
  artifacts:
    - path: backend/src/routes/agents.ts
      provides: Refactored shadow claim endpoints using claim challenges
      min_lines: 100
  key_links:
    - from: POST /v1/agents/malice/:agentId
      to: CHALLENGES KV (claim: prefix)
      via: storeChallenge helper with TTL 3600
      pattern: isShadow: true, status: 'initiated'
    - from: GET /v1/agents/malice/status/:challengeId
      to: CHALLENGES KV
      via: getChallenge helper
      pattern: Returns status field from challenge data
---

<objective>
Refactor shadow claim backend to use unified claim challenge system with isShadow flag, replacing the separate payment challenge system.

Purpose: Align implementation with specification for consistent architecture; shadow claims now flow through the same challenge system as regular claims, differentiated by the isShadow flag and longer TTL.
Output: Refactored endpoints in agents.ts using claim challenges (not payment challenges), with proper state management and legacy code removal.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-backend-refactoring/23-CONTEXT.md
@docs/v1/requirements/agent/shadow-claim.md

@backend/src/routes/agents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor POST /v1/agents/malice/:agentId to use claim challenges</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Refactor the shadow claim initiation endpoint (lines 687-736) to create claim challenges instead of payment challenges:

    1. Keep the endpoint at POST /malice/:agentId (Hono route prefix adds /api/agents)
    2. Replace payment challenge creation with claim challenge creation
    3. Use storeChallenge with 'claim' prefix (not 'payment'):
       await storeChallenge(c.env.CHALLENGES, 'claim', challengeId, claimData, 3600);
    4. Store challenge data structure:
       {
         challenge_id: string,
         agent_id: string,
         overseer_id: string,  // This IS the shadow_overseer_id
         isShadow: true,
         status: 'initiated',
         expires_at: string  // ISO 8601, 60 minutes from now
       }
    5. Generate shadow_overseer_id using generateShadowOverseerId(c.env) (already imported)
    6. Set expirationTtl to 3600 seconds (60 minutes for shadow claims)
    7. Return response:
       {
         success: true,
         challenge_id: challengeId,  // NOT payment_challenge_id
         shadow_overseer_id: shadowOverseerId,
         expires_at: expiresAt,
         message: 'Challenge created. Agent must confirm before payment.'
       }
    8. Remove payment_url from response (no longer needed at this stage)

    Important: Do NOT change the agent ownership check logic - keep existing logic that checks if agent already has real overseer.
  </action>
  <verify>
    - TypeScript compiles without errors: cd backend && npx tsc --noEmit
    - Verify storeChallenge is called with 'claim' prefix and TTL 3600
    - Verify response includes challenge_id (not payment_challenge_id)
  </verify>
  <done>
    POST /v1/agents/malice/:agentId creates claim challenges with isShadow: true, status: 'initiated', and 60-minute TTL
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GET /v1/agents/malice/status/:challengeId for claim challenges</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Update the shadow claim status endpoint (lines 619-655) to query claim challenges:

    1. Change parameter from :paymentChallengeId to :challengeId
    2. Change from getChallenge with 'payment' prefix to 'claim' prefix:
       const challengeData = await getChallenge(c.env.CHALLENGES, 'claim', challengeId);
    3. Implement status determination logic:
       - If challenge not found in KV → return { status: 'expired' }
       - If challengeData.expires_at < new Date() → return { status: 'expired' }
       - If challengeData.status === 'initiated' → return { status: 'initiated', ... }
       - If challengeData.status === 'awaiting-payment' → return { status: 'awaiting-payment', ... }
       - If challengeData.status === 'completed' → return { status: 'completed', ... }
    4. For 'completed' status verification:
       - Query database for active oversight: getActiveOversight(c.env.DB, challengeData.agent_id)
       - If active oversight exists with matching overseer_id → completed
       - Otherwise, trust the challenge status field
    5. Return consistent response structure for all states:
       {
         status: 'initiated' | 'awaiting-payment' | 'completed' | 'expired',
         agent_id: string,
         shadow_overseer_id: string,  // challengeData.overseer_id
         expires_at: string
       }

    Remove the old logic that looked up payment challenges by 'payment' prefix.
  </action>
  <verify>
    - TypeScript compiles without errors
    - Endpoint returns 'expired' for non-existent challenges
    - Endpoint returns correct status for each challenge state
    - Response includes agent_id, shadow_overseer_id, and expires_at
  </verify>
  <done>
    Status endpoint correctly returns all four states (initiated, awaiting-payment, completed, expired) by querying claim challenges
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove legacy payment challenge endpoints</name>
  <files>backend/src/routes/agents.ts</files>
  <action>
    Completely remove the legacy payment challenge endpoints as per locked decision:

    1. Remove GET /malice/:agentId/payment/:paymentChallengeId (lines 743-809)
       - This endpoint returns HTML payment page
       - No longer needed with new agent-confirmation-first flow
       - Delete entirely (not deprecated - breaking change accepted per CONTEXT.md)

    2. Remove POST /malice/:agentId/complete (lines 816-870)
       - This was the manual payment completion endpoint
       - No longer needed with webhook flow
       - Delete entirely (not deprecated)

    3. Remove any helper functions only used by these endpoints

    4. Update any comments referencing payment challenges

    5. Check for any other references to 'payment' prefix challenges in the file and remove/update them

    This is an intentional breaking change per the locked decision: "existing in-flight shadow claims will fail, acceptable risk per deployment plan"
  </action>
  <verify>
    - TypeScript compiles without errors
    - No references to 'payment:' prefix remain in agents.ts
    - No GET /malice/*/payment/* route remains
    - No POST /malice/*/complete route remains
    - File size reduced by removed code
  </verify>
  <done>
    Legacy payment challenge endpoints completely removed from agents.ts
  </done>
</task>

</tasks>

<verification>
1. POST /v1/agents/malice/:agentId creates claim challenges with:
   - 'claim:' prefix in KV
   - isShadow: true flag
   - status: 'initiated'
   - overseer_id set to shadow_overseer_id
   - 60-minute TTL (3600 seconds)

2. GET /v1/agents/malice/status/:challengeId:
   - Queries 'claim:' prefix challenges
   - Returns all four states: initiated, awaiting-payment, completed, expired
   - Returns correct challenge data (agent_id, shadow_overseer_id, expires_at)

3. Legacy endpoints removed:
   - No GET /malice/:agentId/payment/:paymentChallengeId
   - No POST /malice/:agentId/complete
   - No 'payment:' prefix usage

4. Regular claim flow unchanged:
   - POST /claim/initiate still uses 5-minute TTL
   - No isShadow flag on regular claims
   - No changes to claim completion logic (yet - that's Phase 24)

5. TypeScript compilation succeeds
</verification>

<success_criteria>
- Shadow claim initiation uses claim challenges (prefix 'claim:') not payment challenges
- Challenge data includes isShadow: true, shadow_overseer_id, status: 'initiated'
- Shadow claim challenges have 60-minute TTL
- Status endpoint returns all four states correctly
- Legacy payment challenge system completely removed
- Backend compiles without TypeScript errors
- Regular claim flow unaffected (5-minute TTL, no isShadow flag)
</success_criteria>

<output>
After completion, create `.planning/phases/23-backend-refactoring/23-01-SUMMARY.md`
</output>
