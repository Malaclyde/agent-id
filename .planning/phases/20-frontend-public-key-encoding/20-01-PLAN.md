---
phase: 20-frontend-public-key-encoding
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/api/client.ts
  - frontend/src/pages/RegisteredClients.tsx
  - backend/src/services/oauth-client.ts
autonomous: true

must_haves:
  truths:
    - "Frontend converts raw public key to base64url before sending to backend"
    - "Backend validation error message includes hint about expected format"
    - "User can see correct placeholder text indicating base64url format"
  artifacts:
    - path: "frontend/src/api/client.ts"
      provides: "API methods with base64url conversion"
      contains: "formatPublicKey.*public_key"
    - path: "frontend/src/pages/RegisteredClients.tsx"
      provides: "UI placeholder text"
      contains: "Base64url-encoded"
  key_links:
    - from: "frontend/src/api/client.ts"
      to: "/v1/clients/register"
      via: "registerOAuthClient method"
      pattern: "registerOAuthClient.*formatPublicKey"
    - from: "frontend/src/api/client.ts"
      to: "/v1/clients/{id}/key"
      via: "updateOAuthClientKey method"
      pattern: "updateOAuthClientKey.*formatPublicKey"
---

<objective>
Fix OAuth client registration to properly handle public key encoding - frontend converts raw public key to base64url before sending to backend
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md

# Understanding current implementation:

## Backend already validates base64url:
- `backend/src/utils/helpers.ts`: `validateEd25519PublicKey()` expects base64url-encoded 32-byte key
- `backend/src/services/oauth-client.ts`: Returns "Invalid Ed25519 public key format" on validation failure

## Frontend has formatPublicKey but doesn't use it:
- `frontend/src/api/client.ts` line 319: `formatPublicKey()` method exists (converts base64 to base64url)
- Currently NOT called in `registerOAuthClient()` or `updateOAuthClientKey()`

## What needs fixing:
1. Call `formatPublicKey()` before sending public_key in API methods
2. Update UI placeholder text
3. Update backend error message to include format hint

## Locked decisions (from CONTEXT):
- Use existing `formatPublicKey()` method
- Update placeholder from "Base64-encoded" to "Base64url-encoded Ed25519 public key"
- Backend error: "Invalid Ed25519 public key format. Expected base64url-encoded key."
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add base64url conversion to registerOAuthClient</name>
  <files>frontend/src/api/client.ts</files>
  <action>
In the `registerOAuthClient` method (around line 191), modify the data object to convert public_key to base64url format:

```typescript
async registerOAuthClient(ownerType: 'agent' | 'overseer', data: {
  name: string;
  redirect_uris: string[];
  token_endpoint_auth_method?: string;
  application_type?: string;
  scope?: string;
  public_key?: string;
}) {
  // Convert public_key to base64url format if provided
  const processedData = {
    ...data,
    ...(data.public_key && { public_key: this.formatPublicKey(data.public_key) })
  };
  
  return this.request<{
    success: boolean;
    client: { id: string; name: string; redirect_uris: string[]; scope: string | null };
    message: string;
  }>(`/v1/clients/register/${ownerType}`, { method: 'POST', body: JSON.stringify(processedData) });
}
```

The existing `formatPublicKey()` method (line 319) converts base64 to base64url by:
- Replacing `+` with `-`
- Replacing `/` with `_`
- Removing padding `=`
  </action>
  <verify>
Grep for "formatPublicKey.*public_key" pattern in client.ts to confirm conversion is applied
  </verify>
  <done>
registerOAuthClient sends base64url-encoded public_key to backend
</done>
</task>

<task type="auto">
  <name>Task 2: Add base64url conversion to updateOAuthClientKey</name>
  <files>frontend/src/api/client.ts</files>
  <action>
In the `updateOAuthClientKey` method (around line 213), modify to convert publicKey to base64url format:

```typescript
async updateOAuthClientKey(clientId: string, publicKey: string) {
  return this.request<{
    success: boolean;
    message: string;
    client: { id: string; name: string; updated_at: string };
  }>(`/v1/clients/${clientId}/key`, { 
    method: 'PUT', 
    body: JSON.stringify({ public_key: this.formatPublicKey(publicKey) }) 
  });
}
```
  </action>
  <verify>
Grep for "updateOAuthClientKey.*formatPublicKey" pattern in client.ts
  </verify>
  <done>
updateOAuthClientKey sends base64url-encoded public_key to backend
</done>
</task>

<task type="auto">
  <name>Task 3: Update placeholder text in RegisteredClients</name>
  <files>frontend/src/pages/RegisteredClients.tsx</files>
  <action>
Update the input placeholder text from "Base64-encoded Ed25519 public key" to "Base64url-encoded Ed25519 public key" on line 212:

Change:
```typescript
placeholder="Base64-encoded Ed25519 public key"
```

To:
```typescript
placeholder="Base64url-encoded Ed25519 public key"
```
  </action>
  <verify>
Grep for "Base64url-encoded Ed25519 public key" in RegisteredClients.tsx
  </verify>
  <done>
UI placeholder text correctly indicates base64url format
</done>
</task>

<task type="auto">
  <name>Task 4: Update backend error message with format hint</name>
  <files>backend/src/services/oauth-client.ts</files>
  <action>
Update the error message in validateClientMetadata function (line 54-55) to include the expected format hint:

Change:
```typescript
if (!validateEd25519PublicKey(input.public_key)) {
  return { valid: false, error: 'Invalid Ed25519 public key format' };
}
```

To:
```typescript
if (!validateEd25519PublicKey(input.public_key)) {
  return { valid: false, error: 'Invalid Ed25519 public key format. Expected base64url-encoded key.' };
}
```

This matches the error message specified in the user's decisions.
  </action>
<verify>
Grep for "Expected base64url-encoded key" in oauth-client.ts
  </verify>
  <done>
Backend returns clear error message about expected base64url format
</done>
</task>

</tasks>

<verification>
All four tasks complete when:
1. registerOAuthClient converts public_key using formatPublicKey() before sending
2. updateOAuthClientKey converts publicKey using formatPublicKey() before sending
3. RegisteredClients.tsx placeholder shows "Base64url-encoded"
4. Backend error message includes "Expected base64url-encoded key."
</verification>

<success_criteria>
- Frontend sends base64url-encoded public keys (not raw base64)
- Backend validation passes for correctly formatted keys
- Backend returns clear error message when validation fails
- UI placeholder guides users to use correct format
</success_criteria>

<output>
After completion, create `.planning/phases/20-frontend-public-key-encoding/20-01-SUMMARY.md`
</output>
