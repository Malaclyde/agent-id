---
phase: 05-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/paddle-api.ts
  - backend/test/paddle-api.test.ts
autonomous: true

must_haves:
  truths:
    - listCustomers function uses correct Paddle API parameter format email_text[0]
    - Paddle API no longer returns 400 Bad Request with field validation errors
    - Customer list filtering by email works correctly
  artifacts:
    - path: backend/src/services/paddle-api.ts
      provides: Fixed listCustomers function with correct API parameters
      contains: "email_text[0]"
  key_links:
    - from: backend/src/services/paddle-api.ts
      to: https://developer.paddle.com/api-reference/customers/list-customers
      via: "URLSearchParams with email_text[0]"
      pattern: "params.append\\('email_text\\[0\\]'"
</key_links>
---

<objective>
Fix Paddle API listCustomers parameter to use correct email_text[0] format.

Purpose: listCustomers uses 'email' parameter but Paddle API expects 'email_text[0]' for email filtering, causing 400 Bad Request with field validation errors.

Output: Customer list filtering works with Paddle API.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bug-fixes/05-RESEARCH.md

@backend/src/services/paddle-api.ts
@backend/test/paddle-api.test.ts
</context>

<tasks>

<task type="auto">
  <name>Fix listCustomers parameter format in paddle-api.ts</name>
  <files>backend/src/services/paddle-api.ts</files>
  <action>
  In the listCustomers function (around line 319-333), change the parameter format from 'email' to 'email_text[0]':

  BEFORE:
  ```typescript
  export async function listCustomers(
    env: Env,
    email?: string
  ): Promise<{ data: PaddleCustomer[]; meta: any }> {
    const params = new URLSearchParams();
    if (email) {
      params.append('email', email);
    }

    const query = params.toString() ? `?${params.toString()}` : '';
    return paddleRequest<{ data: PaddleCustomer[]; meta: any }>(
      env,
      `/customers${query}`
    );
  }
  ```

  AFTER:
  ```typescript
  export async function listCustomers(
    env: Env,
    email?: string
  ): Promise<{ data: PaddleCustomer[]; meta: any }> {
    const params = new URLSearchParams();
    if (email) {
      params.append('email_text[0]', email);
    }

    const query = params.toString() ? `?${params.toString()}` : '';
    return paddleRequest<{ data: PaddleCustomer[]; meta: any }>(
      env,
      `/customers${query}`
    );
  }
  ```

  This matches Paddle API's expected parameter format for email filtering.
  </action>
  <verify>
  cd backend && npm test -- test/paddle-api.test.ts 2>&1 | grep -A 2 "should list customers with email filter"
  </verify>
  <done>
  "should list customers with email filter" test passes without 400 error
  </done>
</task>

<task type="auto">
  <name>Verify all Paddle API customer tests pass</name>
  <files>backend/test/paddle-api.test.ts</files>
  <action>
  Run all Paddle API tests to verify the fix resolves all 3 failing customer list tests:

  Tests to verify:
  - "should list customers with email filter"
  - "should list customers with custom_data filter"
  - "should handle complete customer lifecycle"

  All tests should pass without Paddle API 400 errors.

  This is a verification task - no code changes, just run tests and confirm success.
  </action>
  <verify>
  cd backend && npm test -- test/paddle-api.test.ts 2>&1 | grep -E "(Test Files|Tests|FAIL.*customers)"
  </verify>
  <done>
  All 3 customer list tests pass, no FAIL output containing "customers"
  </done>
</task>

</tasks>

<verification>
Run Paddle API tests to verify fix:
cd backend && npm test -- test/paddle-api.test.ts 2>&1 | grep -E "(Test Files|Tests)"
Expected: No FAIL results, all tests pass
</verification>

<success_criteria>
listCustomers uses email_text[0] parameter format
All 3 Paddle API customer list tests pass:
- should list customers with email filter
- should list customers with custom_data filter
- should handle complete customer lifecycle
No 400 Bad Request errors from Paddle API
</success_criteria>

<output>
After completion, create `.planning/phases/05-bug-fixes/05-02-SUMMARY.md`
</output>
