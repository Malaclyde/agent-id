---
phase: 05-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/__tests__/oauth-enforcement.test.ts
  - backend/src/services/__tests__/claim-unclaim.test.ts
  - backend/src/services/__tests__/limits.test.ts
autonomous: true

must_haves:
  truths:
    - All 18 D1/Drizzle mock tests pass without "Cannot read properties of undefined" errors
    - Tests properly mock createDB function to return chainable Drizzle query builder
    - vi.mocked() calls properly type mock functions
  artifacts:
    - path: backend/src/services/__tests__/oauth-enforcement.test.ts
      provides: OAuth enforcement tests with proper Drizzle mocks
      contains: "createMockDrizzleDB"
    - path: backend/src/services/__tests__/claim-unclaim.test.ts
      provides: Claim/unclaim tests with proper Drizzle mocks
      contains: "createMockDrizzleDB"
    - path: backend/src/services/__tests__/limits.test.ts
      provides: Client limits tests with proper Drizzle mocks
      contains: "createMockDrizzleDB"
  key_links:
    - from: backend/src/services/__tests__/oauth-enforcement.test.ts
      to: backend/src/db/index.ts
      via: "vi.mock('../../db', () => ({ createDB: vi.fn() }))"
      pattern: "createMockDrizzleDB"
    - from: backend/src/services/__tests__/claim-unclaim.test.ts
      to: backend/src/db/index.ts
      via: "vi.mock('../../db', () => ({ createDB: vi.fn() }))"
      pattern: "createMockDrizzleDB"
    - from: backend/src/services/__tests__/limits.test.ts
      to: backend/src/db/index.ts
      via: "vi.mock('../../db', () => ({ createDB: vi.fn() }))"
      pattern: "createMockDrizzleDB"
---

<objective>
Fix D1/Drizzle mock infrastructure in service tests to resolve 18 failing tests.

Purpose: Tests in src/services/__tests__/ mock createDB but don't properly mock the chainable Drizzle query builder, causing "Cannot read properties of undefined (reading 'select')" errors. Fix by creating proper mock objects.

Output: All 18 service tests passing with correct mock implementation.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bug-fixes/05-RESEARCH.md

@backend/test/unit/ownership.test.ts (reference for correct mock pattern)
@backend/src/db/index.ts (createDB function signature)
@backend/src/services/__tests__/oauth-enforcement.test.ts
@backend/src/services/__tests__/claim-unclaim.test.ts
@backend/src/services/__tests__/limits.test.ts
</context>

<tasks>

<task type="auto">
  <name>Create createMockDrizzleDB helper in oauth-enforcement.test.ts</name>
  <files>backend/src/services/__tests__/oauth-enforcement.test.ts</files>
  <action>
  Add createMockDrizzleDB helper function after the imports section (before describe block) following the pattern from ownership.test.ts:

  ```typescript
  const createMockDrizzleDB = (initialResults: any[] = []) => {
    const chainable = {
      insert: vi.fn(() => chainable),
      values: vi.fn(() => chainable),
      returning: vi.fn(() => Promise.resolve([])),
      select: vi.fn(() => ({ ...chainable })),
      from: vi.fn(() => chainable),
      where: vi.fn(() => chainable),
      limit: vi.fn(() => chainable),
      update: vi.fn(() => chainable),
      set: vi.fn(() => chainable),
      execute: vi.fn(() => Promise.resolve(initialResults)),
      then: async (resolve: any) => resolve(initialResults),
      getQuery: () => ({ sql: '', params: [] }),
    };

    return {
      ...chainable,
      select: () => ({ ...chainable }),
      delete: () => chainable,
    };
  };
  ```

  Update the mock to use this helper:
  ```typescript
  vi.mock('../../db', () => ({
    createDB: vi.fn(() => createMockDrizzleDB()),
  }));
  ```

  Do NOT change test logic, only fix the mock setup.
  </action>
  <verify>
  cd backend && npm test -- src/services/__tests__/oauth-enforcement.test.ts 2>&1 | grep -E "(PASS|FAIL|Tests)" | tail -3
  </verify>
  <done>
  oauth-enforcement.test.ts: All tests pass with "6 passed" in output
  </done>
</task>

<task type="auto">
  <name>Fix claim-unclaim.test.ts mock setup</name>
  <files>backend/src/services/__tests__/claim-unclaim.test.ts</files>
  <action>
  This test has TWO issues:

  1. Add createMockDrizzleDB helper (same as task 1) after imports
  2. Update vi.mock('../../db') to use the helper (same as task 1)
  3. Fix vi.mocked() calls - the test imports countAgentsByOverseer from '../ownership' but doesn't mock it properly

  For the vi.mocked() issue, update the mock setup to:
  ```typescript
  vi.mock('../ownership', async () => {
    const mod = await vi.importActual<typeof import('../ownership')>('../ownership');
    return {
      ...mod,
      countAgentsByOverseer: vi.fn(),
    };
  });
  ```

  This ensures countAgentsByOverseer is properly mocked with vi.mocked().mockResolvedValue() support.

  Do NOT change test logic, only fix the mock setup.
  </action>
  <verify>
  cd backend && npm test -- src/services/__tests__/claim-unclaim.test.ts 2>&1 | grep -E "(PASS|FAIL|Tests)" | tail -3
  </verify>
  <done>
  claim-unclaim.test.ts: All tests pass with "8 passed" in output
  </done>
</task>

<task type="auto">
  <name>Fix limits.test.ts mock setup</name>
  <files>backend/src/services/__tests__/limits.test.ts</files>
  <action>
  This test has TWO issues:

  1. Add createMockDrizzleDB helper (same as task 1) after imports
  2. Update vi.mock('../client-limits') to properly mock countClientsByOverseer:

  ```typescript
  vi.mock('../client-limits', async () => {
    const mod = await vi.importActual<typeof import('../client-limits')>('../client-limits');
    return {
      ...mod,
      countClientsByOverseer: vi.fn(),
    };
  });
  ```

  This ensures countClientsByOverseer is properly mocked with vi.mocked().mockResolvedValue() support.

  Also ensure that when tests call functions that use Drizzle, the mockDB is converted through createDB mock.

  Do NOT change test logic, only fix the mock setup.
  </action>
  <verify>
  cd backend && npm test -- src/services/__tests__/limits.test.ts 2>&1 | grep -E "(PASS|FAIL|Tests)" | tail -3
  </verify>
  <done>
  limits.test.ts: All tests pass with "6 passed" in output
  </done>
</task>

</tasks>

<verification>
Run all three test files to verify fixes:
cd backend && npm test -- src/services/__tests__/ 2>&1 | grep -E "(Test Files|Tests)"
Expected: "Test Files  3 passed | Tests  20 passed" (or similar showing all pass)
</verification>

<success_criteria>
All 18 D1/Drizzle mock tests now pass without errors:
- oauth-enforcement.test.ts: 6 tests pass
- claim-unclaim.test.ts: 6 tests pass
- limits.test.ts: 5 tests pass
No "Cannot read properties of undefined" errors
No "vi.mocked(...).mockResolvedValue is not a function" errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-bug-fixes/05-01-SUMMARY.md`
</output>
