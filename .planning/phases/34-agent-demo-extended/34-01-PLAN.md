---
phase: 34-agent-demo-extended
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - demo/agent/agent-demo.py
autonomous: true

must_haves:
  truths:
    - User can query OAuth history via the CLI
    - User can query overseer info via the CLI
    - Queries output raw, pretty-printed JSON data without pagination
    - API errors fail fast and output raw unadulterated JSON response bodies
  artifacts:
    - path: demo/agent/agent-demo.py
      provides: query subcommand and fail-fast HTTP wrapper
      contains: make_request
  key_links:
    - from: demo/agent/agent-demo.py
      to: /v1/agents/me/oauth-history
      via: make_request HTTP call
      pattern: make_request.*oauth-history
---

<objective>
Implement the core HTTP wrapper and query subcommands for the Agent CLI to output raw JSON history and overseer information.

Purpose: Establishing a unified fail-fast HTTP wrapper pattern to handle all new network-bound operations (AQUERY-01, AQUERY-02) and standardizing output format to raw JSON.
Output: Working `query` subcommand that handles both `history` and `overseers` targets.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@demo/agent/agent-demo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fail-fast HTTP wrapper</name>
  <files>demo/agent/agent-demo.py</files>
  <action>
    Add a unified `make_request(url, headers, data=None, method=None)` function that uses `urllib.request.urlopen` to execute HTTP calls and aggressively catches `urllib.error.HTTPError`. When caught, it MUST forcefully print the unadulterated response body string (using `e.read().decode('utf-8')`) to `sys.stderr` and immediately exit via `sys.exit(1)`. DO NOT log friendly summary strings for API errors. Also add a `print_output(response_string)` utility function that parses the response into a python dict and dumps it using `json.dumps(obj, indent=2)` without pagination or truncation.
  </action>
  <verify>grep "def make_request" demo/agent/agent-demo.py && grep "def print_output" demo/agent/agent-demo.py</verify>
  <done>HTTP wrapper correctly triggers sys.exit(1) and prints raw body on HTTPError.</done>
</task>

<task type="auto">
  <name>Task 2: Implement query subcommand</name>
  <files>demo/agent/agent-demo.py</files>
  <action>
    Add `cmd_query(args)` and register it via argparse as `query`. It must take a positional argument `target` with choices `["history", "overseers"]`.
    - If `target == "history"`, use `make_request` to GET `/v1/agents/me/oauth-history`.
    - If `target == "overseers"`, use `make_request` to GET `/v1/agents/me/overseer`.
    Both endpoints require the active session token (Bearer token). Use the existing `load_config` to read the session_id and `backend_url`. Fail if no session. Use `print_output` to dump the response to the user.
  </action>
  <verify>python demo/agent/agent-demo.py query -h</verify>
  <done>The query command accepts history and overseers targets and issues correct API calls using the fail-fast HTTP wrapper.</done>
</task>

</tasks>

<verification>
Run `python demo/agent/agent-demo.py query history` and verify it reports "No active session" when logged out, or attempts the request.
</verification>

<success_criteria>
User can successfully execute the query subcommand to fetch OAuth history and overseers, which is printed as raw JSON.
</success_criteria>

<output>
After completion, create `.planning/phases/34-agent-demo-extended/34-01-SUMMARY.md`
</output>
