---
phase: 34-agent-demo-extended
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - demo/agent/agent-demo.py
autonomous: true

must_haves:
  truths:
    - "User can complete a claim challenge using session auth when session_id exists"
    - "User can complete a claim challenge using DPoP auth when no session_id exists"
    - "User can revoke their current overseer relationship without confirmation prompts"
    - "API errors output raw JSON response body to stderr and exit 1"
  artifacts:
    - path: demo/agent/agent-demo.py
      provides: "claim and revoke-overseer subcommands"
      contains: "cmd_claim"
    - path: demo/agent/agent-demo.py
      provides: "revoke-overseer subcommand"
      contains: "cmd_revoke_overseer"
  key_links:
    - from: demo/agent/agent-demo.py
      to: /v1/agents/claim/complete/:challengeId
      via: make_request HTTP call
      pattern: "make_request.*claim/complete"
    - from: demo/agent/agent-demo.py
      to: /v1/agents/revoke-overseer
      via: make_request HTTP call
      pattern: "make_request.*revoke-overseer"
---

<objective>
Implement the `claim` and `revoke-overseer` CLI subcommands so agents can complete claim challenges and revoke overseer relationships.

Purpose: Enables agents to accept oversight claims (ACLAIM-01) and unilaterally revoke their current overseer (ACLAIM-02) via the CLI, completing the oversight lifecycle from the agent's perspective.
Output: Two new subcommands (`claim`, `revoke-overseer`) wired into the existing argparse CLI.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-agent-demo-extended/34-CONTEXT.md
@.planning/phases/34-agent-demo-extended/34-RESEARCH.md
@.planning/phases/34-agent-demo-extended/34-01-SUMMARY.md
@demo/agent/agent-demo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement claim subcommand with dual auth support</name>
  <files>demo/agent/agent-demo.py</files>
  <action>
    Add a `cmd_claim(args)` function and register it as the `claim` subcommand via argparse.

    **Argparse setup:**
    - Subcommand name: `claim`
    - Flag `--challenge-id` (required=True, help="The claim challenge ID to complete")
    - Flag `--overseer-id` (required=True, help="The overseer ID initiating the claim")

    **cmd_claim logic:**
    1. Load config via `load_config()`. Require `backend_url`. Require either `session_id` OR (`private_key` + `public_key`) — fail with message if neither is available.
    2. Build the URL: `{backend_url}/v1/agents/claim/complete/{args.challenge_id}`
    3. Build the JSON body: `{"overseer_id": args.overseer_id}` — encode as `json.dumps(body).encode('utf-8')`.
    4. Build headers dict:
       - Always include `"Content-Type": "application/json"`.
       - If `session_id` exists in config: add `"Authorization": f"Bearer {session_id}"` (session auth path).
       - If NO `session_id` but `private_key` exists: load the private key via `load_private_key()`, create a DPoP proof via `create_dpop_proof(private_key, "POST", url)`, and add `"DPoP": dpop_proof` header (DPoP auth path).
    5. Call `make_request(url, headers, data=encoded_body, method="POST")`.
    6. Call `print_output(response)` to dump the raw JSON result.
    7. Return 0 on success.

    **Important:** Do NOT add any confirmation prompts. Do NOT catch exceptions from `make_request` — it already handles errors by printing to stderr and calling sys.exit(1). Do NOT wrap in try/except for HTTP errors.

    Add `"claim": cmd_claim` to the `command_handlers` dict in `main()`.
  </action>
  <verify>python demo/agent/agent-demo.py claim -h</verify>
  <done>The claim subcommand accepts --challenge-id and --overseer-id flags, authenticates via session or DPoP, POSTs to /v1/agents/claim/complete/{challenge_id}, and outputs raw JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Implement revoke-overseer subcommand</name>
  <files>demo/agent/agent-demo.py</files>
  <action>
    Add a `cmd_revoke_overseer(args)` function and register it as the `revoke-overseer` subcommand via argparse.

    **Argparse setup:**
    - Subcommand name: `revoke-overseer`
    - No additional flags needed (uses session auth from .env config)

    **cmd_revoke_overseer logic:**
    1. Load config via `load_config()`. Require `backend_url` and `session_id` — fail with descriptive error message if either is missing. The backend endpoint `/v1/agents/revoke-overseer` requires session-based auth (not DPoP), so `session_id` is mandatory.
    2. Build the URL: `{backend_url}/v1/agents/revoke-overseer`
    3. Build headers: `{"Authorization": f"Bearer {session_id}"}`.
    4. Call `make_request(url, headers, method="POST")` — no body needed.
    5. Call `print_output(response)` to dump the raw JSON result.
    6. Return 0 on success.

    **Critical:** Do NOT add any `input()` or `[y/N]` confirmation prompt before executing the revocation. This is a destructive action and per CONTEXT.md Decision #4, it must execute immediately without prompting. Do NOT catch exceptions from `make_request`.

    Add `"revoke-overseer": cmd_revoke_overseer` to the `command_handlers` dict in `main()`.
  </action>
  <verify>python demo/agent/agent-demo.py revoke-overseer -h</verify>
  <done>The revoke-overseer subcommand authenticates via session, POSTs to /v1/agents/revoke-overseer with no confirmation prompt, and outputs raw JSON.</done>
</task>

</tasks>

<verification>
1. Run `python demo/agent/agent-demo.py claim -h` — must show --challenge-id and --overseer-id as required flags.
2. Run `python demo/agent/agent-demo.py revoke-overseer -h` — must show help text with no additional required flags.
3. Run `python demo/agent/agent-demo.py claim --challenge-id test --overseer-id test` without a valid backend — must print raw error JSON to stderr and exit 1 (fail-fast behavior from make_request).
4. Verify NO `input()` calls exist in either cmd_claim or cmd_revoke_overseer.
</verification>

<success_criteria>
- The `claim` subcommand works with both session auth (Bearer) and DPoP auth, selecting automatically based on config state.
- The `revoke-overseer` subcommand fires immediately with no confirmation prompt.
- Both subcommands use `make_request` for HTTP calls and `print_output` for response display.
- API errors produce raw JSON on stderr + exit code 1.
</success_criteria>

<output>
After completion, create `.planning/phases/34-agent-demo-extended/34-02-SUMMARY.md`
</output>
