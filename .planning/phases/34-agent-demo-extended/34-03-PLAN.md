---
phase: 34-agent-demo-extended
plan: 03
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - demo/agent/agent-demo.py
autonomous: true

must_haves:
  truths:
    - "User can rotate agent keys via a single CLI command"
    - "Key rotation uses dual-signature verification (old key DPoP + new key signature)"
    - "On success, .env is auto-overwritten with new keys and .env.bak backup is created"
    - "The new session_id returned by the backend is saved to .env"
    - "API errors output raw JSON response body to stderr and exit 1"
  artifacts:
    - path: demo/agent/agent-demo.py
      provides: "rotate-keys subcommand with full 2-step rotation"
      contains: "cmd_rotate_keys"
    - path: demo/agent/agent-demo.py
      provides: ".env backup via shutil.copy2"
      contains: "shutil.copy2"
  key_links:
    - from: demo/agent/agent-demo.py
      to: /v1/agents/rotate-key/initiate
      via: make_request HTTP call
      pattern: "make_request.*rotate-key/initiate"
    - from: demo/agent/agent-demo.py
      to: /v1/agents/rotate-key/complete
      via: make_request HTTP call with DPoP header
      pattern: "make_request.*rotate-key/complete"
---

<objective>
Implement the `rotate-keys` CLI subcommand that performs dual-signature key rotation: generating a new keypair, initiating rotation with the backend, signing the challenge with the new key, and completing rotation with a DPoP proof from the old key.

Purpose: Enables agents to rotate their Ed25519 keypairs with cryptographic proof of possession of both old and new keys (AAUTH-05), with automatic .env backup and update.
Output: Working `rotate-keys` subcommand that performs the full initiate→complete rotation flow and persists new keys to .env.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-agent-demo-extended/34-CONTEXT.md
@.planning/phases/34-agent-demo-extended/34-RESEARCH.md
@.planning/phases/34-agent-demo-extended/34-01-SUMMARY.md
@demo/agent/agent-demo.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement rotate-keys subcommand with dual-signature flow</name>
  <files>demo/agent/agent-demo.py</files>
  <action>
    Add `import shutil` at the top of the file (near the existing imports).

    Add a `cmd_rotate_keys(args)` function and register it as the `rotate-keys` subcommand via argparse.

    **Argparse setup:**
    - Subcommand name: `rotate-keys`
    - No additional flags needed (uses config from .env)

    **cmd_rotate_keys logic — full 2-step flow:**

    **Step 1: Load and validate config.**
    Load config via `load_config()`. Require `backend_url`, `session_id`, `private_key`, and `public_key`. Fail with descriptive error if any are missing. Load the CURRENT private key via `load_private_key(config["private_key"])`.

    **Step 2: Generate new keypair.**
    Call `generate_keypair()` to get `(new_private_b64url, new_public_b64url)`. Load the NEW private key via `load_private_key(new_private_b64url)`.

    **Step 3: Initiate rotation.**
    - URL: `{backend_url}/v1/agents/rotate-key/initiate`
    - Headers: `{"Content-Type": "application/json", "Authorization": f"Bearer {session_id}"}`
    - Body: `json.dumps({"new_public_key": new_public_b64url}).encode("utf-8")`
    - Call `make_request(url, headers, data=body, method="POST")`.
    - Parse the response string with `json.loads()` to extract `challenge_id`, `challenge_data`, and `expires_at`.

    **Step 4: Sign challenge_data with NEW key.**
    - The `challenge_data` returned by the backend is a canonicalized JSON string.
    - Sign it with the NEW private key: `new_private_key.sign(challenge_data.encode("utf-8"))`.
    - Base64url-encode the 64-byte signature: `base64url_encode(signed.signature)`.

    **Step 5: Complete rotation.**
    - URL: `{backend_url}/v1/agents/rotate-key/complete/{challenge_id}`
    - Headers: `{"Content-Type": "application/json", "DPoP": dpop_proof}` — the DPoP proof must be signed with the CURRENT (old) private key via `create_dpop_proof(old_private_key, "POST", url)`. Do NOT include Authorization Bearer header here — the backend authenticates this request via DPoP verification against the agent's current public key.
    - Body: `json.dumps({"signature": signature_b64url}).encode("utf-8")` — the signature is from the NEW key.
    - Call `make_request(url, headers, data=body, method="POST")`.
    - Parse the response to extract the new `session_id`.

    **Step 6: Backup and update .env.**
    - Call `shutil.copy2(ENV_FILE, f"{ENV_FILE}.bak")` to create/overwrite the backup. Use the `ENV_FILE` constant (value `.env`) already defined in the script.
    - Update config with new keys and session: `config["private_key"] = new_private_b64url`, `config["public_key"] = new_public_b64url`, `config["session_id"] = new_session_id`.
    - Call `save_config(config)` to persist to .env.
    - Print confirmation: the new public key (truncated for display) and that backup was created at `.env.bak`.

    **Step 7: Print the complete response.**
    Use `print_output()` on the complete-rotation response string to dump the raw JSON.

    **Important:** Do NOT wrap `make_request` calls in try/except — it handles errors internally via sys.exit(1). Do NOT add confirmation prompts. The entire operation is non-interactive per CONTEXT.md Decision #2.

    Add `"rotate-keys": cmd_rotate_keys` to the `command_handlers` dict in `main()`.
  </action>
  <verify>python demo/agent/agent-demo.py rotate-keys -h</verify>
  <done>The rotate-keys subcommand generates a new keypair, performs the 2-step initiate/complete flow with dual-signature verification (DPoP with old key + body signature with new key), backs up .env to .env.bak via shutil.copy2, and saves new keys + session to .env.</done>
</task>

<task type="auto">
  <name>Task 2: Verify shutil import and .env backup mechanism</name>
  <files>demo/agent/agent-demo.py</files>
  <action>
    Verify the implementation from Task 1 by checking:

    1. `import shutil` is present near the top of the file with other stdlib imports.
    2. `shutil.copy2` is called with `ENV_FILE` as source (not a hardcoded `.env` string — use the constant).
    3. The backup destination is `f"{ENV_FILE}.bak"` (which resolves to `.env.bak`).
    4. The backup happens BEFORE `save_config()` is called (order matters — if save_config fails, we still have the backup).
    5. No `input()` calls exist anywhere in `cmd_rotate_keys`.
    6. The `command_handlers` dict in `main()` includes `"rotate-keys": cmd_rotate_keys`.
    7. The DPoP proof in the complete step uses the OLD private key (not the new one).
    8. The body signature in the complete step uses the NEW private key (not the old one).

    If any of these checks fail, fix the implementation to match the specification. Run `python -c "import demo.agent; print('import OK')"` or equivalent syntax check to verify no import errors.
  </action>
  <verify>grep -n "shutil.copy2" demo/agent/agent-demo.py && grep -n "import shutil" demo/agent/agent-demo.py && grep -n "rotate-keys" demo/agent/agent-demo.py</verify>
  <done>shutil is imported, .env.bak backup uses shutil.copy2 with ENV_FILE constant, backup occurs before save_config, dual-signature uses correct keys (old for DPoP, new for body signature), and rotate-keys is registered in command_handlers.</done>
</task>

</tasks>

<verification>
1. Run `python demo/agent/agent-demo.py rotate-keys -h` — must show help text with no required flags.
2. Run `python demo/agent/agent-demo.py -h` — must list rotate-keys as an available subcommand.
3. Grep for `shutil.copy2` — must be present in the rotate-keys handler.
4. Grep for `input(` — must NOT appear in cmd_rotate_keys function.
5. Verify DPoP proof in complete step uses old_private_key and body signature uses new_private_key (code inspection).
</verification>

<success_criteria>
- The `rotate-keys` subcommand performs the full 2-step initiate/complete rotation.
- Dual-signature verification: DPoP header signed with old key, body signature signed with new key.
- .env.bak backup created via shutil.copy2 before .env is updated.
- New keys and session_id auto-saved to .env without prompting.
- API errors produce raw JSON on stderr + exit code 1 via make_request.
</success_criteria>

<output>
After completion, create `.planning/phases/34-agent-demo-extended/34-03-SUMMARY.md`
</output>
