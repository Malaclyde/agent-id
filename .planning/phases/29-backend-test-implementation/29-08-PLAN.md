---
phase: 29-backend-test-implementation
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/test/unit/webhook-handler.test.ts
  - backend/test/unit/paddle.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All unit tests pass without mock configuration errors"
    - "Webhook handler tests have complete mock coverage"
    - "Error message assertions match actual implementation messages"
  artifacts:
    - path: "backend/test/unit/webhook-handler.test.ts"
      provides: "Webhook handler unit tests"
      contains: "getSubscriptionByCustomer mock"
    - path: "backend/test/unit/paddle.test.ts"
      provides: "Paddle service unit tests"
      contains: "correct mock implementations"
  key_links:
    - from: "test/unit/webhook-handler.test.ts"
      to: "src/services/paddle"
      via: "vi.mock"
      pattern: "getSubscriptionByCustomer"
---

<objective>
Fix failing unit tests by updating mock configurations and error message assertions.

Purpose: 64 tests fail due to mock configuration issues (missing `getSubscriptionByCustomer` export) and incorrect error message expectations. These tests use the 'forks' pool mocks and should work regardless of pool configuration.

Output: All unit tests pass with proper mock coverage and correct assertions.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Failing test files
@backend/test/unit/webhook-handler.test.ts
@backend/test/unit/paddle.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix webhook-handler.test.ts Mock Configuration</name>
  <files>backend/test/unit/webhook-handler.test.ts</files>
  <action>
Fix the mock for `src/services/paddle` to include the missing `getSubscriptionByCustomer` export.

The error shows: "No 'getSubscriptionByCustomer' export is defined on the '../../src/services/paddle' mock"

Find the vi.mock call for `../../src/services/paddle` and add the missing export:
```typescript
vi.mock('../../src/services/paddle', () => ({
  getSubscriptionTier: vi.fn(),
  getSubscriptionByCustomer: vi.fn().mockResolvedValue({
    id: 'sub_123',
    status: 'active',
    // ... other subscription fields
  }),
  // ... other existing mocks
}));
```

Also fix the error message assertions:
- Expected: "Overseer not found for subscription"
- Actual: "Overseer not found for customer"

Update the test expectations to match the actual error message, or if the message is wrong in implementation, note it for later fix.
</action>
  <verify>
Run `npm test -- --run test/unit/webhook-handler.test.ts` and verify all tests pass.
</verify>
  <done>
All webhook-handler.test.ts tests pass. Mock includes `getSubscriptionByCustomer` and error assertions match actual messages.
</done>
</task>

<task type="auto">
  <name>Task 2: Fix paddle.test.ts Issues</name>
  <files>backend/test/unit/paddle.test.ts</files>
  <action>
Fix the failing tests in paddle.test.ts:
1. Test at line 396: `expect(result).toBe(true)` - investigate why the result is not true
2. Check if mocks are properly configured for `isSubscriptionActive` function
3. Ensure the mock returns correct values for subscription status checks

Run the specific failing test to understand the actual vs expected behavior:
```bash
npm test -- --run test/unit/paddle.test.ts
```

Fix the mock configuration or test expectations as needed.
</action>
  <verify>
Run `npm test -- --run test/unit/paddle.test.ts` and verify all tests pass.
</verify>
  <done>
All paddle.test.ts tests pass. Subscription status checks return correct values.
</done>
</task>

<task type="auto">
  <name>Task 3: Run Full Test Suite and Verify</name>
  <files>backend/test/unit/*.test.ts</files>
  <action>
Run the complete test suite to identify any remaining failures:
```bash
npm test -- --run
```

For any remaining failures:
1. Check if they are mock-related (add missing exports)
2. Check if they are assertion-related (update expectations)
3. Document any that require code changes vs test changes

All fixes should be test-side unless the test reveals an actual bug in the implementation.
</action>
  <verify>
`npm test -- --run` shows all unit tests passing. Document any tests that cannot be fixed without code changes.
</verify>
  <done>
Full test suite passes. Any unfixable tests (requiring code changes) are documented.
</done>
</task>

</tasks>

<verification>
1. Run `npm test -- --run test/unit/webhook-handler.test.ts` - all pass
2. Run `npm test -- --run test/unit/paddle.test.ts` - all pass
3. Run `npm test -- --run` - check for remaining failures
4. Total test pass rate should be significantly improved
</verification>

<success_criteria>
1. All webhook-handler.test.ts tests pass (no mock errors)
2. All paddle.test.ts tests pass
3. Unit test pass rate improves from 369/433 to 433/433 (or documented exceptions)
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-08-SUMMARY.md`
</output>
