---
phase: 29-backend-test-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/vitest.config.ts
  - backend/test/helpers/db.ts
  - backend/test/helpers/kv.ts
autonomous: true
must_haves:
  truths:
    - "Test environment runs on Cloudflare Workers pool rather than NodeJS"
    - "Ephemeral D1 database can load migrations and be cleared between tests"
    - "KV Namespace mock provides fast in-memory key-value operations"
  artifacts:
    - path: "backend/vitest.config.ts"
      provides: "Vitest config using @cloudflare/vitest-pool-workers"
    - path: "backend/test/helpers/db.ts"
      provides: "D1 setup and teardown helpers"
    - path: "backend/test/helpers/kv.ts"
      provides: "Map-based KV mock"
  key_links:
    - from: "backend/test/helpers/db.ts"
      to: "backend/migrations/*.sql"
      via: "import.meta.glob"
      pattern: "import.meta.glob"
---

<objective>
Migrate backend test infrastructure to use Cloudflare vitest-pool-workers and create foundational data isolation helpers.

Purpose: Achieve exact Web Crypto API parity and test against real ephemeral D1 databases instead of mocked NodeJS globals, satisfying BETEST-02.
Output: Configured Vitest setup with DB and KV helpers ready for integration tests.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-CONTEXT.md
@.planning/phases/29-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Downgrade Vitest & Add Pool Workers</name>
  <files>
    backend/package.json
    backend/vitest.config.ts
  </files>
  <action>
    Modify `backend/package.json`:
    - Downgrade `"vitest"`, `"@vitest/coverage-v8"`, and `"@vitest/ui"` to `^3.2.0` (v4 is unsupported by pool workers).
    - Add `"@cloudflare/vitest-pool-workers": "^0.6.0"` to `devDependencies`.
    - Do NOT run `npm install` manually in this task (Vitest setup task will handle it).

    Modify `backend/vitest.config.ts`:
    - Change `environment: 'node'` to `pool: '@cloudflare/vitest-pool-workers/config'`.
    - Remove the `environment` field.
    - Change `include: ['**/*.test.ts']` to `include: ['test/api/**/*.test.ts']` so existing deeply mocked tests are ignored during migration.
  </action>
  <verify>
    cd backend && npm install && npx vitest --version
  </verify>
  <done>
    Vitest is successfully downgraded and installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Ephemeral D1 Database Helper</name>
  <files>
    backend/test/helpers/db.ts
  </files>
  <action>
    Create `backend/test/helpers/db.ts`:
    - Export `setupTestDB()`: Load migrations using `import.meta.glob('../../migrations/*.sql', { query: '?raw', import: 'default', eager: true })`. Strip comments (`/--.*/g`), split by `;`, and execute via `env.DB.batch()`.
    - Export `teardownTestDB()`: Clear database state by iterating over `sqlite_schema` where `type='table'` and name does not start with `sqlite_`, `_cf_`, or `d1_`, and executing `DELETE FROM <tablename>`.
    - Import `env` from `cloudflare:test`.
  </action>
  <verify>
    ls backend/test/helpers/db.ts
  </verify>
  <done>
    Database setup and teardown helpers accurately simulate D1 state resets.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement In-Memory KV Namespace Mock</name>
  <files>
    backend/test/helpers/kv.ts
  </files>
  <action>
    Create `backend/test/helpers/kv.ts`:
    - Implement a `MockKVNamespace` class or object implementing `KVNamespace` methods: `get`, `put`, `delete`.
    - Use a standard JavaScript `Map<string, string>` as the underlying store to prioritize speed over full persistence fidelity.
    - Export an instance of this mock to be passed to `app.fetch()` inside tests.
  </action>
  <verify>
    ls backend/test/helpers/kv.ts
  </verify>
  <done>
    In-memory KV mock exists and provides simple key-value methods.
  </done>
</task>

</tasks>

<verification>
Check that `npm install` in the backend resolves without peer dependency conflicts.
</verification>

<success_criteria>
Vitest is configured for Cloudflare pool workers and foundational D1/KV helpers exist.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-01-SUMMARY.md`
</output>