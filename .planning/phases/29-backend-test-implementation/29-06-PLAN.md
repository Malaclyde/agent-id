---
phase: 29-backend-test-implementation
plan: 06
type: execute
wave: 3
depends_on: ["29-02"]
files_modified:
  - backend/test/api/oauth.test.ts
autonomous: true
must_haves:
  truths:
    - "Authorization codes can be securely generated for valid OAuth clients"
    - "Tokens can be successfully exchanged securely using authorization codes"
    - "DPoP signatures accurately restrict and bind OAuth tokens"
  artifacts:
    - path: "backend/test/api/oauth.test.ts"
      provides: "Tests for OAuth authorization and token endpoints"
  key_links:
    - from: "backend/test/api/oauth.test.ts"
      to: "backend/test/helpers/kv.ts"
      via: "Mocking KVNamespace for authorization codes"
      pattern: "env.CHALLENGES"
---

<objective>
Write comprehensive OAuth API integration tests to verify the core identity provider logic involving DPoP and code exchange.

Purpose: Validate standard OAuth token flow (`/authorize`, `/token`) through `app.fetch()`, including KV storage of codes and DPoP signature generation, fully satisfying BETEST-03.
Output: One functional integration test file (`oauth.test.ts`) that verifies the full multi-actor OAuth flow without network requests.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-CONTEXT.md
@.planning/phases/29-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write OAuth Integration Tests</name>
  <files>
    backend/test/api/oauth.test.ts
  </files>
  <action>
    Create `backend/test/api/oauth.test.ts`:
    - Implement `beforeAll(setupTestDB)` and `afterEach(teardownTestDB)`.
    - Construct the Map-based KV Namespace mock from `backend/test/helpers/kv.ts` for testing short-lived OAuth authorization codes.
    - Test `GET /v1/oauth/authorize`: Provide valid `client_id`, `redirect_uri`, `response_type=code`. Verify `302 Redirect` with the `code` attached to the URL.
    - Validate that the KV mock (`env.CHALLENGES` or equivalent namespace) correctly stored the code payload.
    - Test `POST /v1/oauth/token`: Exchange the previously generated code via DPoP. Generate the Ed25519 keypair and DPoP signature using `crypto.ts`. Provide `client_id`, `client_secret` (if confidential), `grant_type=authorization_code`, and `code`.
    - Verify `200 OK` returning an `access_token` and `refresh_token`.
  </action>
  <verify>
    npm run test -- --run test/api/oauth.test.ts
  </verify>
  <done>
    Full OAuth flow (authorize -> token) is validated via the integration suite.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final Integration Suite Execution</name>
  <files>
    backend/package.json
  </files>
  <action>
    Modify `backend/package.json` scripts if necessary to ensure `npm test` runs correctly on the new directory (`vitest run test/api`).
    Run `npm run test -- --run test/api` across the entire new suite to ensure all `app.fetch()` routes, ephemeral DB instances, dynamic keys, and KV mocks run concurrently without collision.
  </action>
  <verify>
    cd backend && npm test
  </verify>
  <done>
    Entire integration suite runs reliably in the Cloudflare Worker pool environment.
  </done>
</task>

</tasks>

<verification>
Check that the newly authored integration tests succeed natively without network overhead and satisfy the roadmap success criteria.
</verification>

<success_criteria>
OAuth flow is fully tested natively and the entire test migration is verifiably executing against the real runtime simulation.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-06-SUMMARY.md`
</output>