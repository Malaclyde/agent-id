---
phase: 29-backend-test-implementation
plan: 05
type: execute
wave: 3
depends_on: ["29-02"]
files_modified:
  - backend/test/api/clients.test.ts
  - backend/test/api/subscriptions.test.ts
autonomous: true
must_haves:
  truths:
    - "OAuth Clients can be registered and fetched by authenticated Overseers"
    - "Subscription statuses and tiers correctly restrict or permit Client actions"
    - "Ephemeral database safely mocks related Tier and Plan records"
  artifacts:
    - path: "backend/test/api/clients.test.ts"
      provides: "Tests for Client API routes"
    - path: "backend/test/api/subscriptions.test.ts"
      provides: "Tests for Subscription API routes"
  key_links:
    - from: "backend/test/api/subscriptions.test.ts"
      to: "backend/test/helpers/builder.ts"
      via: "Injects Overseer with active subscription tier"
      pattern: "withSubscription"
---

<objective>
Write comprehensive integration tests for OAuth Clients and Subscriptions to verify limits, tiers, and creation endpoints.

Purpose: Achieve BETEST-03 by validating Client management and Subscription state visibility via `app.fetch()`.
Output: Two functional integration test files (`clients.test.ts`, `subscriptions.test.ts`).
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-CONTEXT.md
@.planning/phases/29-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Clients API Tests</name>
  <files>
    backend/test/api/clients.test.ts
  </files>
  <action>
    Create `backend/test/api/clients.test.ts`:
    - Utilize Data Builder to bootstrap a logged-in Overseer.
    - Test `POST /v1/clients`: Create an OAuth client (provide `name`, `redirectUris`). Assert `201 Created` and verify `env.DB` insertion.
    - Test `GET /v1/clients`: Assert the newly created client is returned in the list.
    - Test `GET /v1/clients/:id`: Fetch client details and assert accurate serialization (including standard fields and client secrets if applicable).
    - Ensure endpoints gracefully reject requests if the Overseer hits client-limit bounds (mock active vs. free tiers using the Data Builder).
  </action>
  <verify>
    npm run test -- --run test/api/clients.test.ts
  </verify>
  <done>
    Client CRUD flows accurately adhere to permissions, limit constraints, and D1 operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Subscriptions API Tests</name>
  <files>
    backend/test/api/subscriptions.test.ts
  </files>
  <action>
    Create `backend/test/api/subscriptions.test.ts`:
    - Setup D1 mock (`setupTestDB` in `beforeAll`, `teardownTestDB` in `afterEach`).
    - Test `GET /v1/subscriptions/me` (or similarly routed active subscription endpoint): Use Data Builder to insert an active `tier_id` associated with a mock Overseer. Call endpoint with Overseer JWT, assert the active tier, limits, and statuses match the `env.DB` state.
    - Test updating or reading expired subscription details via API endpoints, ensuring correct fallback tiers (e.g., 'free') are dynamically inferred if the user is past-due.
  </action>
  <verify>
    npm run test -- --run test/api/subscriptions.test.ts
  </verify>
  <done>
    Subscription logic correctly aggregates and retrieves database state via app.fetch().
  </done>
</task>

</tasks>

<verification>
Check that the Subscriptions and Clients endpoints run smoothly and independently via their integration tests.
</verification>

<success_criteria>
OAuth Clients and Subscription API endpoints are extensively verified against mock D1 models.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-05-SUMMARY.md`
</output>