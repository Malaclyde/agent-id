---
phase: 29-backend-test-implementation
plan: 12
type: execute
wave: 2
depends_on: ["29-11"]
files_modified: ["backend/test/integration/paddle-api.test.ts", "backend/test/unit/claim-scenarios.test.ts"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Paddle API mocks are correctly applied in the Workers pool"
    - "Claiming logic regressions are resolved"
  artifacts:
    - path: "backend/test/integration/paddle-api.test.ts"
      provides: "Working Paddle API mocks"
    - path: "backend/test/unit/claim-scenarios.test.ts"
      provides: "Verified claiming logic tests"
  key_links:
    - from: "backend/test/integration/paddle-api.test.ts"
      to: "backend/src/services/paddle-api.ts"
      via: "vi.mock"
      pattern: "vi\\.mock.*paddle-api"
    - from: "backend/test/unit/claim-scenarios.test.ts"
      to: "backend/src/services/ownership.ts"
      via: "import"
      pattern: "import.*services/ownership"
---

<objective>
Fix Paddle API mocking issues in the Workers pool environment and resolve regressions in the claiming logic test suite.

Purpose: Restore 100% pass rate for critical integration and unit tests.
Output: Fixed paddle-api.test.ts and claim-scenarios.test.ts.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/test/integration/paddle-api.test.ts
@backend/test/unit/claim-scenarios.test.ts
@.planning/phases/29-backend-test-implementation/29-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Paddle API Mocks for Workers Pool</name>
  <files>backend/test/integration/paddle-api.test.ts</files>
  <action>
    Fix `vi.mock` for `paddle-api` in backend/test/integration/paddle-api.test.ts.
    - In @cloudflare/vitest-pool-workers, `vi.mock` must be used at the top level and might require `vi.hoist` or specific module resolution.
    - Alternatively, move the mocks into a `__mocks__` directory or use `vi.spyOn` if applicable.
    - Ensure the mocks are active within the Worker context where the code is actually running.
    - Reference: https://developers.cloudflare.com/workers/testing/vitest/mocking/
  </action>
  <verify>Run `npx vitest test/integration/paddle-api.test.ts` and verify 100% pass rate (23/23).</verify>
  <done>paddle-api.test.ts passes completely with mocks correctly applied.</done>
</task>

<task type="auto">
  <name>Task 2: Resolve Claiming Logic Regressions</name>
  <files>backend/test/unit/claim-scenarios.test.ts</files>
  <action>
    Identify and fix the 2 failing tests in backend/test/unit/claim-scenarios.test.ts.
    - Analyze the failures to determine if they are due to outdated test mocks or actual regressions in `backend/src/services/ownership.ts` or related services.
    - The verification report mentions "regression in claiming logic".
    - Align the test expectations with the current implementation of ownership transfer and shadow claims.
  </action>
  <verify>Run `npx vitest test/unit/claim-scenarios.test.ts` and verify 100% pass rate (14/14).</verify>
  <done>claim-scenarios.test.ts passes completely with fixed logic.</done>
</task>

</tasks>

<verification>
Run the full backend test suite: `npm test`.
</verification>

<success_criteria>
1. `paddle-api.test.ts` has a 100% pass rate.
2. `claim-scenarios.test.ts` has a 100% pass rate.
3. Total backend test suite pass rate reaches 100%.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-12-SUMMARY.md`
</output>
