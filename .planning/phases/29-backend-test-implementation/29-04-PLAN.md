---
phase: 29-backend-test-implementation
plan: 04
type: execute
wave: 3
depends_on: ["29-02"]
files_modified:
  - backend/test/api/overseers.test.ts
  - backend/test/api/agents.test.ts
autonomous: true
must_haves:
  truths:
    - "Overseers can be registered, authenticated, and managed via app.fetch()"
    - "Agents can be created, authorized, and linked to Overseers"
    - "Data isolation ensures Agents from different tests do not collide"
  artifacts:
    - path: "backend/test/api/overseers.test.ts"
      provides: "Tests for Overseer API routes"
    - path: "backend/test/api/agents.test.ts"
      provides: "Tests for Agent API routes"
  key_links:
    - from: "backend/test/api/agents.test.ts"
      to: "backend/test/helpers/crypto.ts"
      via: "DPoP signature generator for API auth"
      pattern: "generateTestDPoP"
---

<objective>
Write comprehensive integration tests for Overseer and Agent entities to verify creation, relationship mapping, and authorization flows.

Purpose: Validate core user and agent logic across API endpoints using dynamic cryptographic keys and the ephemeral database mock to satisfy BETEST-01 and BETEST-03.
Output: Two functional integration test files (`overseers.test.ts`, `agents.test.ts`) covering all CRUD and auth behaviors for these entities.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-CONTEXT.md
@.planning/phases/29-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Overseers API Tests</name>
  <files>
    backend/test/api/overseers.test.ts
  </files>
  <action>
    Create `backend/test/api/overseers.test.ts`:
    - Setup D1 mock (`setupTestDB` in `beforeAll`, `teardownTestDB` in `afterEach`).
    - Test `POST /v1/overseers/register`: Provide valid email/password, assert `201 Created` and direct mock query verifies insertion in `env.DB`.
    - Test `POST /v1/overseers/login`: Use the Data Builder API to insert an overseer, log in using `app.fetch()`, verify a valid JWT is returned in the response (either cookie or JSON body based on codebase rules).
    - Test protected `GET /v1/overseers/me`: Verify it requires auth headers, mock valid JWT insertion using `hono/jwt` or app secret.
  </action>
  <verify>
    npm run test -- --run test/api/overseers.test.ts
  </verify>
  <done>
    Overseer registration, authentication, and retrieval flows successfully execute.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Agents API Tests</name>
  <files>
    backend/test/api/agents.test.ts
  </files>
  <action>
    Create `backend/test/api/agents.test.ts`:
    - Utilize Data Builder to bootstrap a logged-in Overseer.
    - Test `POST /v1/agents`: Use `generateTestKeyPair()` to generate an Ed25519 key. Provide the base64url public key in the payload. Expect `201 Created`.
    - Test `GET /v1/agents`: Request as the overseer, ensure the newly created Agent is returned.
    - Test `GET /v1/agents/:id`: Utilize `generateTestDPoP` to securely sign the request headers. Ensure `DPoP` and `Authorization` headers allow the agent to fetch its own details.
    - Assert `401 Unauthorized` when providing an invalid or forged DPoP signature.
  </action>
  <verify>
    npm run test -- --run test/api/agents.test.ts
  </verify>
  <done>
    Agent creation, cryptographic linking, and authenticated fetching is verified.
  </done>
</task>

</tasks>

<verification>
Check that the dynamic keys from `crypto.ts` accurately mimic valid Client/Agent requests across both files.
</verification>

<success_criteria>
Overseers and Agents are reliably tested against an isolated ephemeral database with real cryptographic enforcement.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-04-SUMMARY.md`
</output>