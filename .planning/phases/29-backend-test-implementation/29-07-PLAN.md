---
phase: 29-backend-test-implementation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/vitest.config.ts
  - backend/test/helpers/db.ts
  - backend/test/helpers/builder.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Test environment runs on Cloudflare Workers pool with Web Crypto API parity"
    - "Ephemeral D1 database can load migrations and be cleared between tests"
    - "Test data can be fluently inserted into D1 database via Builder API"
    - "Tests use real cloudflare:test module for D1/KV bindings"
  artifacts:
    - path: "backend/vitest.config.ts"
      provides: "Vitest configuration with Cloudflare Workers pool"
      contains: "pool: '@cloudflare/vitest-pool-workers'"
    - path: "backend/test/helpers/db.ts"
      provides: "Database setup/teardown for ephemeral D1"
      exports: ["setupTestDB", "teardownTestDB"]
    - path: "backend/test/helpers/builder.ts"
      provides: "Fluent test data builder"
      exports: ["TestDataBuilder"]
  key_links:
    - from: "backend/vitest.config.ts"
      to: "@cloudflare/vitest-pool-workers"
      via: "pool configuration"
      pattern: "pool.*vitest-pool-workers"
    - from: "backend/test/helpers/db.ts"
      to: "cloudflare:test"
      via: "import { env } from 'cloudflare:test'"
      pattern: "from ['\"]cloudflare:test['\"]"
---

<objective>
Fix vitest pool configuration to use Cloudflare Workers pool, enabling the ephemeral D1/KV infrastructure.

Purpose: The pool was changed to 'forks' as a workaround for an error. This broke the ability to use the `cloudflare:test` module, rendering the db.ts and builder.ts helpers unusable. This plan investigates and fixes the root cause.

Output: Working Cloudflare Workers pool configuration with functional db.ts and builder.ts helpers.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-backend-test-implementation/29-RESEARCH.md
@.planning/phases/29-backend-test-implementation/29-CONTEXT.md

# Existing helpers that need the correct pool
@backend/test/helpers/db.ts
@backend/test/helpers/builder.ts

# Current broken configuration
@backend/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate and Fix Vitest Pool Configuration</name>
  <files>backend/vitest.config.ts</files>
  <action>
Investigate the "must export a function as default export" error that caused the pool change from `@cloudflare/vitest-pool-workers` to `forks`.

Research the correct configuration for `@cloudflare/vitest-pool-workers`:
1. Check the @cloudflare/vitest-pool-workers documentation for vitest 3.2.x compatibility
2. The config must use `pool: '@cloudflare/vitest-pool-workers'` (not the `/config` import)
3. Add proper `poolOptions.workers` configuration if required
4. The wrangler.toml defines D1 and KV bindings that need to be referenced

Update vitest.config.ts to:
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    pool: '@cloudflare/vitest-pool-workers',
    poolOptions: {
      workers: {
        wrangler: {
          configPath: './wrangler.toml',
        },
      },
    },
    include: ['test/api/**/*.test.ts', 'test/unit/**/*.test.ts', 'test/integration/**/*.test.ts'],
    exclude: ['node_modules', 'dist'],
  },
});
```

Remove the coverage config temporarily if it causes issues with workers pool (can be re-added later).
</action>
  <verify>
Run `npm test -- --run` and verify:
1. No "must export a function as default export" error
2. Tests execute using Cloudflare Workers pool
3. The `cloudflare:test` module import works
</verify>
  <done>
vitest.config.ts uses `pool: '@cloudflare/vitest-pool-workers'` and tests run without pool-related errors. The cloudflare:test module is accessible.
</done>
</task>

<task type="auto">
  <name>Task 2: Verify Ephemeral D1 Helpers Work</name>
  <files>backend/test/helpers/db.ts, backend/test/helpers/builder.ts</files>
  <action>
Create a simple verification test that:
1. Imports `setupTestDB` and `teardownTestDB` from db.ts
2. Imports `TestDataBuilder` from builder.ts
3. Uses them in a test to confirm they work with the correct pool

Create a test file `backend/test/infrastructure/pool-verification.test.ts`:
```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { setupTestDB, teardownTestDB } from '../helpers/db';
import { TestDataBuilder } from '../helpers/builder';

describe('Cloudflare Workers Pool Verification', () => {
  beforeEach(async () => {
    await setupTestDB();
  });

  afterEach(async () => {
    await teardownTestDB();
  });

  it('should have access to cloudflare:test env', async () => {
    const { env } = await import('cloudflare:test');
    expect(env.DB).toBeDefined();
    expect(env.CHALLENGES).toBeDefined();
  });

  it('should create overseer via TestDataBuilder', async () => {
    const builder = new TestDataBuilder();
    const { overseerIds } = await builder
      .withOverseer('test-ov-1', 'test@example.com', 'password123')
      .build();
    
    expect(overseerIds).toHaveLength(1);
    expect(overseerIds[0]).toBe('test-ov-1');
  });
});
```

Run the test and ensure it passes.
</action>
  <verify>
`npm test -- --run test/infrastructure/pool-verification.test.ts` passes all tests.
</verify>
  <done>
Verification tests pass, confirming that cloudflare:test module works and D1/KV helpers are functional with the correct pool.
</done>
</task>

</tasks>

<verification>
1. Run `npm test -- --run` - no pool configuration errors
2. Verification tests in test/infrastructure/pool-verification.test.ts pass
3. Confirm `pool: '@cloudflare/vitest-pool-workers'` is active in vitest.config.ts
4. Confirm imports from `cloudflare:test` module work without errors
</verification>

<success_criteria>
1. vitest.config.ts uses Cloudflare Workers pool (`@cloudflare/vitest-pool-workers`)
2. `cloudflare:test` module imports work in tests
3. `setupTestDB()` and `teardownTestDB()` execute successfully
4. `TestDataBuilder` can insert data into ephemeral D1
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-07-SUMMARY.md`
</output>
