---
phase: 29-backend-test-implementation
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - backend/test/helpers/crypto.ts
  - backend/test/helpers/builder.ts
autonomous: true
must_haves:
  truths:
    - "Dynamic Ed25519 keypairs can be generated per test case"
    - "DPoP signatures can be constructed for API requests to pass Auth validation"
    - "Test data can be fluently inserted into D1 database via Builder API"
  artifacts:
    - path: "backend/test/helpers/crypto.ts"
      provides: "Ed25519 and DPoP generators"
    - path: "backend/test/helpers/builder.ts"
      provides: "Fluent Database Data Builder"
  key_links:
    - from: "backend/test/helpers/builder.ts"
      to: "backend/test/helpers/crypto.ts"
      via: "Agent generation uses dynamic keys"
      pattern: "generateTestKeyPair"
---

<objective>
Implement cryptographic and data builder utilities to enable isolated and complex test scenarios.

Purpose: Achieve BETEST-01 by providing tools for dynamic Ed25519 keypair and DPoP signature generation, ensuring test autonomy and security validation fidelity. Provide a fast data builder API to bootstrap complex Agent/Overseer relationships natively in tests.
Output: Exported helper modules (`crypto.ts`, `builder.ts`) ready for integration tests.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-CONTEXT.md
@.planning/phases/29-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Cryptographic Helper</name>
  <files>
    backend/test/helpers/crypto.ts
  </files>
  <action>
    Create `backend/test/helpers/crypto.ts`:
    - Export `generateTestKeyPair()`: Utilize `@noble/ed25519` to return an object with a random 32-byte `privateKey` and its derived `publicKey`. Format the public key using URL-safe base64 encoding without padding.
    - Export `generateTestDPoP(method: string, url: string, keypair: { privateKey: Uint8Array, publicKey: string })`: Return a signed DPoP token string mimicking a valid client token. Use `jose` or raw Web Crypto depending on codebase conventions (ensure it creates a valid JWT with `htm`, `htu`, `jti`, `iat`, and `jwk` in the header signed with `EdDSA`).
  </action>
  <verify>
    ls backend/test/helpers/crypto.ts
  </verify>
  <done>
    Helper correctly generates test keypairs and DPoP signatures dynamically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Data Builder Helper</name>
  <files>
    backend/test/helpers/builder.ts
  </files>
  <action>
    Create `backend/test/helpers/builder.ts`:
    - Export a `TestDataBuilder` class handling `env.DB` mutations.
    - Add fluent builder methods like `withOverseer(overseerId, email, password)`, `withAgent(agentId, name, public_key, overseer_id)`, `withSubscription(overseerId, status, tier)`.
    - Ensure methods execute actual `INSERT INTO` or Drizzle operations against the ephemeral `env.DB` imported from `cloudflare:test`.
    - Use sensible test defaults (e.g. UUIDs if not specified) and handle constraints.
  </action>
  <verify>
    ls backend/test/helpers/builder.ts
  </verify>
  <done>
    Data builder allows simple programmatic injection of mock data into D1.
  </done>
</task>

</tasks>

<verification>
Check that both helper files compile cleanly and correctly reference external dependencies.
</verification>

<success_criteria>
Cryptographic utilities and Data builder logic are securely implemented and ready for API tests.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-02-SUMMARY.md`
</output>