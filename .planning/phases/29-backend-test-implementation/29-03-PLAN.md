---
phase: 29-backend-test-implementation
plan: 03
type: execute
wave: 3
depends_on: ["29-02"]
files_modified:
  - backend/test/api/core.test.ts
  - backend/test/api/webhooks.test.ts
autonomous: true
must_haves:
  truths:
    - "Base API endpoints (/health) are reachable via app.fetch()"
    - "Webhook API processes Paddle payloads and correctly updates database state"
    - "Test environment supports simulated timers and fast-forwarding"
  artifacts:
    - path: "backend/test/api/core.test.ts"
      provides: "Tests for /health and base endpoints"
    - path: "backend/test/api/webhooks.test.ts"
      provides: "Tests for Paddle webhooks and async delays"
  key_links:
    - from: "backend/test/api/webhooks.test.ts"
      to: "backend/src/index.ts"
      via: "app.fetch(request, { ...env, PADDLE_WEBHOOK_SECRET })"
      pattern: "app.fetch"
    - from: "backend/test/api/webhooks.test.ts"
      to: "backend/test/helpers/db.ts"
      via: "setupTestDB/teardownTestDB"
      pattern: "setupTestDB"
---

<objective>
Write foundational core API and webhook integration tests to verify basic application health and external async integrations using the ephemeral mock database.

Purpose: Achieve BETEST-03 by validating `app.fetch()` functionality across base routes and testing Paddle webhooks directly via simulated events (timer fast-forwarding and signature validation).
Output: Two functional integration test files (`core.test.ts`, `webhooks.test.ts`) that pass without network overhead.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-CONTEXT.md
@.planning/phases/29-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write Core API Tests</name>
  <files>
    backend/test/api/core.test.ts
  </files>
  <action>
    Create `backend/test/api/core.test.ts`:
    - Import `app` from `backend/src/index.ts`.
    - Import `setupTestDB` and `teardownTestDB` from `backend/test/helpers/db.ts`. Use `beforeAll` and `afterEach`.
    - Write a `describe` block testing `GET /health` and `GET /`.
    - Verify `app.fetch(new Request('http://localhost/health'), env)` returns `200 OK` and a valid JSON structure.
    - Check that the base `/` endpoint accurately lists available resources.
  </action>
  <verify>
    npm run test -- --run test/api/core.test.ts
  </verify>
  <done>
    Core health checks successfully interact with the app via app.fetch().
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Webhook API Tests</name>
  <files>
    backend/test/api/webhooks.test.ts
  </files>
  <action>
    Create `backend/test/api/webhooks.test.ts`:
    - Utilize `vi.useFakeTimers()` for testing webhook retries or simulated delays if applicable.
    - Create a valid Paddle webhook event payload (e.g. `subscription.created` or `subscription.updated`).
    - Use a test secret (`test-secret`) and securely generate the Paddle-Signature header (`ts=123,h1=sha256_hmac`).
    - Dispatch the payload via `app.fetch(request, { ...env, PADDLE_WEBHOOK_SECRET: 'test-secret' })`.
    - Assert the route returns `200 OK`.
    - Retrieve data directly from `env.DB` to verify the subscription tier/status was genuinely updated.
  </action>
  <verify>
    npm run test -- --run test/api/webhooks.test.ts
  </verify>
  <done>
    Paddle webhook processing and resulting state updates are successfully verified.
  </done>
</task>

</tasks>

<verification>
Check that both integration tests run locally without errors and are fully self-contained.
</verification>

<success_criteria>
Core routing logic and webhook integrations are verified against the ephemeral database.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-03-SUMMARY.md`
</output>