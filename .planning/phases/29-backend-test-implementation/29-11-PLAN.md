---
phase: 29-backend-test-implementation
plan: 11
type: execute
wave: 1
depends_on: ["29-10"]
files_modified: ["backend/vitest.config.ts", "backend/test/unit/agent-expanded.test.ts"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Full test suite execution is stable and reliable"
    - "Ghost tests for removed features are eliminated"
  artifacts:
    - path: "backend/vitest.config.ts"
      provides: "Optimized test configuration"
    - path: "backend/test/unit/agent-expanded.test.ts"
      provides: "Cleaned up unit tests"
---

<objective>
Stabilize the backend test suite execution and remove "Ghost Tests" that reference features removed in Phase 21.

Purpose: Ensure the test suite is reliable and provides an accurate signal of application health without false negatives from outdated code.
Output: Optimized vitest.config.ts and cleaned up agent-expanded.test.ts.
</objective>

<execution_context>
./.opencode/get-shit-done/workflows/execute-plan.md
./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/vitest.config.ts
@backend/test/unit/agent-expanded.test.ts
@.planning/phases/29-backend-test-implementation/29-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Optimize Vitest Config for Stability</name>
  <files>backend/vitest.config.ts</files>
  <action>
    Update backend/vitest.config.ts to improve stability in the Cloudflare Workers pool.
    - Increase `hookTimeout` and `testTimeout` to 30s to account for workerd startup fluctuations.
    - Set `poolOptions.workers.singleWorker: false` (or true if contention is the issue) to balance isolation vs resource usage.
    - Add `isolate: true` if not already default.
    - Add `sequence: { shuffle: true }` to identify any hidden dependencies between tests.
  </action>
  <verify>Run `npm test` in backend multiple times to ensure no ERR_RUNTIME_FAILURE occurs.</verify>
  <done>Full suite runs to completion consistently without environment-related failures.</done>
</task>

<task type="auto">
  <name>Task 2: Cleanup Ghost Tests in agent-expanded.test.ts</name>
  <files>backend/test/unit/agent-expanded.test.ts</files>
  <action>
    Identify and remove or update tests in backend/test/unit/agent-expanded.test.ts that reference features removed in Phase 21.
    - The verification report indicates 18/25 tests fail due to "Ghost Tests".
    - Check for functions like `incrementOAuthCount`, `incrementOAuthCountWithLimitCheck`, `canAgentPerformOAuth` which might have been changed or removed.
    - Compare with current `backend/src/services/agent.ts` to ensure only existing functions are tested.
  </action>
  <verify>Run `npx vitest test/unit/agent-expanded.test.ts` and verify 100% pass rate.</verify>
  <done>agent-expanded.test.ts passes completely with only relevant tests remaining.</done>
</task>

</tasks>

<verification>
Run the full backend test suite: `npm test`.
</verification>

<success_criteria>
1. `npm test` completes without `ERR_RUNTIME_FAILURE`.
2. `agent-expanded.test.ts` has a 100% pass rate.
</success_criteria>

<output>
After completion, create `.planning/phases/29-backend-test-implementation/29-11-SUMMARY.md`
</output>
