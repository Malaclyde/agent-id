---
phase: 18-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/agent.ts
autonomous: true

must_haves:
  truths:
    - "Unclaimed agents (FREE tier) can perform OAuth up to 10 times per billing period"
    - "FREE tier OAuth limit is enforced correctly (allows up to 10, blocks at 10+)"
  artifacts:
    - path: "backend/src/services/agent.ts"
      provides: "OAuth permission check for FREE tier agents"
      contains: "canAgentPerformOAuth"
      min_lines: 20
  key_links:
    - from: "backend/src/routes/oauth.ts"
      to: "backend/src/services/agent.ts"
      via: "canAgentPerformOAuth function call"
      pattern: "canAgentPerformOAuth"
---

<objective>
Fix unclaimed agents being blocked from OAuth registration despite having 10-call limit.

Purpose: FREE tier agents (unclaimed agents with no overseer) should be allowed up to 10 OAuth registration calls per billing period, but currently they're blocked immediately. The canAgentPerformOAuth() function incorrectly returns false for FREE tier without checking the limit.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-fixes/18-CONTEXT.md

# Reference the existing test that defines expected behavior
@backend/src/services/__tests__/oauth-enforcement.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix canAgentPerformOAuth to allow FREE tier with limit check</name>
  <files>backend/src/services/agent.ts</files>
  <action>
    In the canAgentPerformOAuth function (around line 208-225), remove the early return for FREE tier that blocks OAuth before checking the limit.

    Current broken code (line 212-213):
    ```typescript
    const subscription = await getEntitySubscription(db, 'agent', agentId, env);
    if (!subscription || subscription.is_free_tier) return false;
    ```

    Replace with:
    ```typescript
    const subscription = await getEntitySubscription(db, 'agent', agentId, env);
    if (!subscription) return false;
    // FREE tier agents can perform OAuth up to the limit (default: 10 per billing period)
    // The limit check below handles both FREE and paid tiers
    ```

    The rest of the function already handles the limit check correctly:
    - Line 215-216: Unlimited for paid tiers (-1)
    - Line 218-221: Check if new billing period
    - Line 223-224: Check count against limit

    This change allows FREE tier agents to proceed to the limit check instead of being blocked immediately.
  </action>
  <verify>
    Run: cd backend && npx vitest run src/services/__tests__/oauth-enforcement.test.ts -t "canAgentPerformOAuth"
    Check: Tests "should allow OAuth for FREE tier under limit" and "should block OAuth for FREE tier at limit" should pass
  </verify>
  <done>
    FREE tier agents can OAuth up to 10 times per billing period
  </done>
</task>

</tasks>

<verification>
1. Verify canAgentPerformOAuth no longer returns false for is_free_tier
2. Run the existing tests: cd backend && npx vitest run src/services/__tests__/oauth-enforcement.test.ts
3. Test "should allow OAuth for FREE tier under limit" passes (returns true when count < 10)
4. Test "should block OAuth for FREE tier at limit" passes (returns false when count >= 10)
</verification>

<success_criteria>
- Unclaimed agents (FREE tier) can perform OAuth registration calls
- Limit of 10 OAuth calls per billing period is enforced for FREE tier
- Existing tests for FREE tier OAuth behavior pass
</success_criteria>

<output>
After completion, create `.planning/phases/18-fixes/18-02-SUMMARY.md`
</output>
