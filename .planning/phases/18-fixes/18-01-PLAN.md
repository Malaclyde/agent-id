---
phase: 18-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/subscriptions.ts
autonomous: true

must_haves:
  truths:
    - "Subscription pane loads without SQL errors for overseers with claimed agents"
    - "OAuth usage count correctly counts across all agents owned by an overseer"
  artifacts:
    - path: "backend/src/routes/subscriptions.ts"
      provides: "OAuth usage counting function"
      contains: "getOauthUsageCount"
      min_lines: 30
  key_links:
    - from: "backend/src/routes/subscriptions.ts"
      to: "oauth_requests table"
      via: "Drizzle inArray query"
      pattern: "inArray.*oauthRequests"
---

<objective>
Fix SQL error in subscription pane when counting OAuth usage.

Purpose: The subscription pane crashes with a PostgreSQL-style ANY() syntax error when an overseer with claimed agents tries to view OAuth usage. SQLite doesn't support ANY() array syntax.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-fixes/18-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace ANY() with inArray() in subscriptions.ts</name>
  <files>backend/src/routes/subscriptions.ts</files>
  <action>
    In the getOauthUsageCount function (around line 57-62), replace the raw SQL ANY() syntax with Drizzle's inArray() function.

    Current broken code:
    ```typescript
    const oauthCountResult = await drizzleDb
      .select({ count: sql<number>`count(*)` })
      .from(oauthRequests)
      .where(
        eq(oauthRequests.agent_id, sql`ANY(${agentIds})`)
      );
    ```

    Replace with:
    ```typescript
    const oauthCountResult = await drizzleDb
      .select({ count: sql<number>`count(*)` })
      .from(oauthRequests)
      .where(
        inArray(oauthRequests.agent_id, agentIds)
      );
    ```

    Make sure to import inArray from 'drizzle-orm' at the top of the file if not already present.
  </action>
  <verify>
    Run: cd backend && npx vitest run src/routes/__tests__/subscriptions.test.ts 2>/dev/null || echo "No specific tests, check manually"
    Verify: grep -q "inArray" backend/src/routes/subscriptions.ts
  </verify>
  <done>
    Subscriptions endpoint returns correct oauth_count without SQL errors
  </done>
</task>

</tasks>

<verification>
1. Verify inArray is imported from drizzle-orm
2. Verify the query uses inArray(oauthRequests.agent_id, agentIds) instead of sql`ANY()`
3. No PostgreSQL-specific syntax remains in the query
</verification>

<success_criteria>
- Subscription pane loads without SQL errors when overseer has claimed agents
- OAuth usage count is correct across all agents
</success_criteria>

<output>
After completion, create `.planning/phases/18-fixes/18-01-SUMMARY.md`
</output>
