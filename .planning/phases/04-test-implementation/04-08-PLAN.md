---
phase: 04-test-implementation
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/test/unit/client-limits.test.ts
  - backend/test/unit/ownership.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All backend unit tests pass (0 failures)"
    - "client-limits.test.ts: 4/4 tests passing"
    - "ownership.test.ts: 14/14 tests passing"
  artifacts:
    - path: "backend/test/unit/client-limits.test.ts"
      provides: "Fixed mock setup for subscription service"
      min_tests: 4
    - path: "backend/test/unit/ownership.test.ts"
      provides: "Fixed test for claimAgent with proper mock"
      min_tests: 14
  key_links:
    - from: "client-limits.test.ts"
      to: "backend/src/services/client-limits.ts"
      via: "vi.mock for subscription service"
      pattern: "vi.mocked(getActiveSubscription)"
---

<objective>
Fix all failing backend unit tests to enable accurate coverage reporting.

**Purpose:** 25 backend tests are failing due to mock setup issues, preventing coverage data from being collected. Fixing these is prerequisite to achieving 80% coverage targets.
**Output:** All backend tests passing (208 + 25 = 233 tests)
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-test-implementation/04-CONTEXT.md
@.planning/phases/04-test-implementation/04-VERIFICATION.md
@backend/test/unit/client-limits.test.ts
@backend/test/unit/ownership.test.ts
@backend/src/services/client-limits.ts
@backend/src/services/ownership.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix client-limits.test.ts mock setup</name>
  <files>backend/test/unit/client-limits.test.ts</files>
  <action>
Fix the 3 failing tests in client-limits.test.ts. The issue is that the mock setup for getActiveSubscription and getAgentSubscription isn't properly returning values when dynamically imported.

**Current Issue:**
- Tests dynamically import the service after mocking
- Mock values aren't being applied correctly
- Subscription functions return undefined causing test failures

**Fix Strategy:**
1. Change from factory mock to spy-based approach using vi.spyOn
2. Or move the mock setup to use doMock pattern that works with dynamic imports
3. Ensure getActiveSubscription returns proper subscription objects with tier limits

**Key functions to test:**
- canRegisterClient() - check FREE tier vs paid tier
- enforceClientLimitsForOverseer() - check limits enforcement

**Mock Requirements:**
- FREE tier: { tier_id: 'FREE', is_free_tier: true, num_allowed_agents: 0, num_allowed_requests: 10, num_allowed_registrations: 5 }
- Paid tier: { tier_id: 'PREMIUM', is_free_tier: false, num_allowed_agents: -1, num_allowed_requests: -1, num_allowed_registrations: -1 }

Verify all 4 tests pass after fix.
  </action>
  <verify>cd backend && npm test -- client-limits.test.ts</verify>
  <done>All 4 tests in client-limits.test.ts pass (was: 1 passing, 3 failing)</done>
</task>

<task type="auto">
  <name>Task 2: Fix ownership.test.ts failing test</name>
  <files>backend/test/unit/ownership.test.ts</files>
  <action>
Fix the 1 failing test in ownership.test.ts. The issue is similar - mock setup problems with the claimAgent function tests.

**Current Issue:**
- Tests use dynamic imports and vi.mock patterns that may not be working correctly
- claimAgent tests may be failing because dependencies aren't properly mocked

**Fix Strategy:**
1. Review the test "should throw error when agent not found" in Claim Agent section
2. Ensure getAgentById mock is properly set up before dynamic import
3. Check that mockEnv is properly passed to functions
4. Verify the mock for subscription service is working

**Current Working Pattern from other tests:**
- Use vi.mock at top of file with factory function
- Use vi.mocked() to get typed mocks
- Clear mocks in beforeEach

**Test to Fix:**
- "should throw error when agent not found" - ensure getAgentById mock returns null properly

Verify all 14 tests pass after fix.
  </action>
  <verify>cd backend && npm test -- ownership.test.ts</verify>
  <done>All 14 tests in ownership.test.ts pass (was: 13 passing, 1 failing)</done>
</task>

</tasks>

<verification>
After both tasks complete, run full backend test suite:
```bash
cd backend && npm test
```

Expected: 233 tests passing, 0 failing (was 208 passing, 25 failing)
</verification>

<success_criteria>
- [ ] client-limits.test.ts: 4/4 tests passing
- [ ] ownership.test.ts: 14/14 tests passing
- [ ] Total backend failures reduced from 25 to 0
- [ ] Coverage reports can now accurately measure code coverage
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-implementation/04-08-SUMMARY.md`
</output>
