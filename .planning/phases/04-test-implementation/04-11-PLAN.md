---
phase: 04-test-implementation
plan: 11
type: execute
wave: 3
depends_on: ['04-08', '04-09', '04-10']
files_modified:
  - frontend/test/unit/pages/overseer-dashboard.test.tsx
  - frontend/test/unit/pages/overseer-auth.test.tsx
  - frontend/test/unit/pages/subscription-management.test.tsx
  - backend/test/unit/registration-scenarios.test.ts
  - backend/test/unit/client-scenarios.test.ts
  - backend/test/unit/subscription-scenarios.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Frontend pages have comprehensive unit tests"
    - "Frontend coverage increased from 18.56% to >40%"
    - "All missing test scenarios from Gap 6 are implemented"
  artifacts:
    - path: "frontend/test/unit/pages/overseer-dashboard.test.tsx"
      provides: "Tests for OverseerDashboard.tsx (was listed as Dashboard.tsx)"
      min_tests: 10
    - path: "frontend/test/unit/pages/overseer-auth.test.tsx"
      provides: "Tests for OverseerAuth.tsx component"
      min_tests: 8
    - path: "frontend/test/unit/pages/subscription-management.test.tsx"
      provides: "Tests for SubscriptionManagement.tsx component"
      min_tests: 12
    - path: "backend/test/unit/registration-scenarios.test.ts"
      provides: "Missing registration test scenarios (TS-R006, TS-R011, TS-R014)"
      min_tests: 3
    - path: "backend/test/unit/client-scenarios.test.ts"
      provides: "Missing client test scenarios (TS-C003, TS-C005, TS-C006, TS-C009, TS-C010, TS-C012, TS-C015)"
      min_tests: 7
    - path: "backend/test/unit/subscription-scenarios.test.ts"
      provides: "Missing subscription test scenarios (TS-S005, TS-S006, TS-S013, TS-S014, TS-S016, TS-S019, TS-S020)"
      min_tests: 7
  key_links:
    - from: "frontend tests"
      to: "frontend/src/pages/*.tsx"
      via: "React Testing Library render"
      pattern: "render(<Component />)"
---

<objective>
Add frontend unit tests for untested pages and implement all remaining missing test scenarios from Gap 6.

**Purpose:** Frontend coverage is only 18.56% with critical pages untested. Additionally, 35 test scenarios from Gap 6 need implementation to reach full test coverage.
**Output:** Frontend page tests + all missing test scenarios (35 total)
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-test-implementation/04-CONTEXT.md
@.planning/phases/04-test-implementation/04-VERIFICATION.md
@frontend/src/pages/OverseerDashboard.tsx
@frontend/src/pages/OverseerAuth.tsx
@frontend/src/pages/SubscriptionManagement.tsx
@test/coverage/test-scenarios-matrix.md
@frontend/test/unit/auth-context.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create frontend page tests for OverseerDashboard</name>
  <files>frontend/test/unit/pages/overseer-dashboard.test.tsx</files>
  <action>
Create unit tests for frontend/src/pages/OverseerDashboard.tsx (this was listed as "Dashboard.tsx" in gaps but the actual file is OverseerDashboard.tsx).

**Component Structure to Test:**
- MyAgents component - agent list, claim functionality
- UserInfo component - user information display
- DowngradeModal component - subscription downgrade UI
- Sidebar navigation with NavLink
- Routes for nested pages (clients, user-info, subscription)

**Tests to Write:**

1. **MyAgents Section:**
   - Renders agent list correctly
   - Shows empty state when no agents
   - Displays agent count in header
   - Claim agent input and button work
   - Shows claim challenge after initiating claim
   - Declaim confirmation flow works
   - Shows over-limit warning when applicable

2. **DowngradeModal:**
   - Renders when in downgrade mode
   - Auto-selects excess agents
   - Requires selecting exact number of agents
   - Cancel and confirm buttons work

3. **UserInfo Section:**
   - Displays user information correctly
   - Formats dates properly

4. **Navigation:**
   - Sidebar links render correctly
   - Active link highlighting works
   - Routes render correct components

**Mock Requirements:**
```typescript
// Mock AuthContext
vi.mock('../../src/context/AuthContext', () => ({
  useAuth: vi.fn(() => ({
    user: { id: 'overseer-1', name: 'Test User', email: 'test@example.com', created_at: '2024-01-01' }
  }))
}));

// Mock API client
vi.mock('../../src/api/client', () => ({
  api: {
    getOverseerAgents: vi.fn(),
    getSubscription: vi.fn(),
    getSubscriptionUsage: vi.fn(),
    initiateAgentClaim: vi.fn(),
    declaimAgent: vi.fn(),
  }
}));

// Mock React Router
vi.mock('react-router-dom', async () => {
  const actual = await vi.importActual('react-router-dom');
  return {
    ...actual,
    useNavigate: vi.fn(),
  };
});
```

**Testing Pattern (follow existing tests):**
Use patterns from auth-context.test.tsx, header.test.tsx, and home.test.tsx.
  </action>
  <verify>cd frontend && npm test -- overseer-dashboard.test.tsx</verify>
  <done>OverseerDashboard tests created, all passing, >60% component coverage</done>
</task>

<task type="auto">
  <name>Task 2: Create frontend page tests for OverseerAuth</name>
  <files>frontend/test/unit/pages/overseer-auth.test.tsx</files>
  <action>
Create unit tests for frontend/src/pages/OverseerAuth.tsx.

**Component Structure to Test:**
- Auth mode toggle (login vs signup)
- Provider selection grid (Email, Google, Apple, GitHub)
- Login form with email/password
- Signup form with name/email/password
- Error handling
- Loading states

**Tests to Write:**

1. **Provider Selection:**
   - Renders provider grid initially
   - Only Email provider is available (others disabled)
   - Clicking Email shows form
   - Back button returns to provider grid

2. **Login Form:**
   - Renders email and password inputs
   - Submit calls loginAsOverseer with credentials
   - Shows error message on failed login
   - Shows loading state during submission
   - Form validation (required fields)

3. **Signup Form:**
   - Renders name, email, password inputs
   - Submit calls registerAsOverseer with data
   - Shows error message on failed signup
   - Password minimum length (8 chars)

4. **Mode Switching:**
   - Login/signup tabs switch modes
   - Form clears when switching modes
   - Error clears when switching modes

**Mock Requirements:**
```typescript
const mockLogin = vi.fn();
const mockRegister = vi.fn();

vi.mock('../../src/context/AuthContext', () => ({
  useAuth: vi.fn(() => ({
    loginAsOverseer: mockLogin,
    registerAsOverseer: mockRegister,
  }))
}));
```
  </action>
  <verify>cd frontend && npm test -- overseer-auth.test.tsx</verify>
  <done>OverseerAuth tests created, all passing, >60% component coverage</done>
</task>

<task type="auto">
  <name>Task 3: Create frontend page tests for SubscriptionManagement</name>
  <files>frontend/test/unit/pages/subscription-management.test.tsx</files>
  <action>
Create unit tests for frontend/src/pages/SubscriptionManagement.tsx.

**Component Structure to Test:**
- CurrentSubscriptionCard - shows current tier and usage
- TierComparisonCard - compares all tiers
- UpgradeOptionsCard - shows upgrade options
- UpgradeModal - confirms upgrade
- Loading and error states

**Tests to Write:**

1. **CurrentSubscriptionCard:**
   - Displays current tier badge with correct color
   - Shows usage stats (agents, clients, OAuth)
   - Progress bars show correct percentages
   - Shows expired/grace period warnings
   - Displays billing countdown
   - Handles null subscription gracefully

2. **TierComparisonCard:**
   - Renders comparison table
   - Highlights current tier column
   - Shows correct limits for each tier
   - Shows prices correctly

3. **UpgradeOptionsCard:**
   - Shows upgradeable tiers (not current, not FREE)
   - Shows "Most Popular" badge on PRO
   - Displays tier features correctly
   - Shows pricing cards
   - Handles highest tier (shows contact message)

4. **UpgradeModal:**
   - Opens when upgrade button clicked
   - Shows current and target tier
   - Shows price
   - Cancel closes modal
   - Confirm initiates Paddle checkout

5. **Integration:**
   - Loading state while fetching data
   - Error display on API failure
   - Retry button works

**Mock Requirements:**
```typescript
vi.mock('../../src/api/client', () => ({
  api: {
    getSubscription: vi.fn(),
    getSubscriptionTiers: vi.fn(),
    getSubscriptionUsage: vi.fn(),
    initiateUpgrade: vi.fn(),
  }
}));

// Mock Paddle.js
global.window.Paddle = {
  Checkout: {
    open: vi.fn()
  }
};
```

**Mock Data:**
```typescript
const mockTiers = [
  { tier: 'FREE', max_agents: 0, max_clients: 0, max_oauth_per_period: 0, price: 0 },
  { tier: 'BASIC', max_agents: 5, max_clients: 10, max_oauth_per_period: 100, price: 9 },
  { tier: 'PRO', max_agents: 25, max_clients: 50, max_oauth_per_period: 1000, price: 29 },
  { tier: 'PREMIUM', max_agents: -1, max_clients: -1, max_oauth_per_period: -1, price: 99 },
];

const mockSubscription = {
  tier: 'BASIC',
  is_active: true,
  max_agents: 5,
  max_clients: 10,
  max_oauth_per_period: 100,
  billing_period_end: '2024-12-31',
};

const mockUsage = {
  agents_claimed: 3,
  clients_registered: 5,
  oauth_count: 50,
};
```
  </action>
  <verify>cd frontend && npm test -- subscription-management.test.tsx</verify>
  <done>SubscriptionManagement tests created, all passing, >60% component coverage</done>
</task>

<task type="auto">
  <name>Task 4: Create missing test scenario files</name>
  <files>
    backend/test/unit/registration-scenarios.test.ts
    backend/test/unit/client-scenarios.test.ts
    backend/test/unit/subscription-scenarios.test.ts
  </files>
  <action>
Create test files for all remaining missing test scenarios from Gap 6.

**From test-scenarios-matrix.md - Missing Scenarios:**

**Registration Scenarios (3 scenarios):**
- TS-R006: Overseer Logout
- TS-R011: Agent Logout  
- TS-R014: Agent Registration with Missing Fields

Create `backend/test/unit/registration-scenarios.test.ts`:
- Test logout functionality for overseers
- Test logout functionality for agents
- Test agent registration validation (missing fields)

**Client Scenarios (7 scenarios):**
- TS-C003: Shadow-Claimed Agent Can Register Client
- TS-C005: Overseer Tier Limit Enforcement
- TS-C006: Shared Client Limit Across Overseer and Claimed Agents
- TS-C009: Multiple Claimed Agents Register Their Own Clients
- TS-C010: Unclaimed Agent Limited to 10 Registrations (Shadow)
- TS-C012: Client Registration with Duplicate Public Key
- TS-C015: Client Marked for Cancellation Cannot Complete OAuth

Create `backend/test/unit/client-scenarios.test.ts`:
- Test client registration for shadow-claimed agents
- Test tier limit enforcement
- Test shared limits
- Test multiple agents
- Test shadow agent limits
- Test duplicate key handling
- Test cancellation OAuth blocking

**Subscription Scenarios (7 scenarios):**
- TS-S005: Subscription Grace Period Access
- TS-S006: Agent Accesses Subscription Features When Claimed
- TS-S013: Payment Failure During Subscription Change
- TS-S014: Duplicate Webhook Event (Idempotency)
- TS-S016: Subscription Tier Limit Reached (Max Agents)
- TS-S019: Overseer Upgrades from FREE to BASIC Tier
- TS-S020: Overseer Downgrades from PRO to BASIC Tier

Create `backend/test/unit/subscription-scenarios.test.ts`:
- Test grace period access
- Test agent subscription inheritance
- Test payment failure handling
- Test webhook idempotency
- Test tier limit enforcement
- Test upgrade/downgrade flows

**Implementation Notes:**
- Use existing mock patterns from auth.test.ts, subscription.test.ts
- Focus on business logic validation
- Each scenario should be a describe block with clear test name
- Mock all external dependencies (DB, Paddle, etc.)

**Total: 17 additional test scenarios**
  </action>
  <verify>cd backend && npm test -- registration-scenarios.test.ts client-scenarios.test.ts subscription-scenarios.test.ts</verify>
  <done>All missing test scenario files created, tests passing, 17 new scenarios covered</done>
</task>

</tasks>

<verification>
Run full test coverage reports:
```bash
# Frontend
cd frontend && npm test -- --coverage

# Backend
cd backend && npm test -- --coverage
```

Expected improvements:
- Frontend: 18.56% → >40%
- Backend: Additional tests for scenario coverage
- Total scenarios: 28/63 → 45/63 (71%)
</verification>

<success_criteria>
- [ ] OverseerDashboard tests: >60% coverage, all passing
- [ ] OverseerAuth tests: >60% coverage, all passing
- [ ] SubscriptionManagement tests: >60% coverage, all passing
- [ ] registration-scenarios.test.ts: 3 scenarios implemented
- [ ] client-scenarios.test.ts: 7 scenarios implemented
- [ ] subscription-scenarios.test.ts: 7 scenarios implemented
- [ ] All 17 missing scenarios from Gap 6 now have tests
- [ ] Frontend coverage >40% (was 18.56%)
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-implementation/04-11-SUMMARY.md`
</output>
