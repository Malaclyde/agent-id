---
phase: 04-test-implementation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/test/unit/password.test.ts
  - backend/test/unit/crypto.test.ts
  - backend/test/unit/helpers.test.ts
  - backend/test/unit/auth-middleware.test.ts
  - backend/test/unit/webhook-handler.test.ts
autonomous: true

must_haves:
  truths:
    - "Backend utility functions have unit tests"
    - "Password utility (bcrypt) functions are tested"
    - "Cryptographic utility functions are tested"
    - "Helper utility functions are tested"
    - "Auth middleware functions are tested"
    - "Webhook handler functions are tested"
  artifacts:
    - path: "backend/test/unit/password.test.ts"
      provides: "Unit tests for password hashing/verification"
      min_lines: 50
    - path: "backend/test/unit/crypto.test.ts"
      provides: "Unit tests for crypto utilities"
      min_lines: 50
    - path: "backend/test/unit/helpers.test.ts"
      provides: "Unit tests for helper functions"
      min_lines: 50
    - path: "backend/test/unit/auth-middleware.test.ts"
      provides: "Unit tests for auth middleware"
      min_lines: 60
    - path: "backend/test/unit/webhook-handler.test.ts"
      provides: "Unit tests for webhook handler"
      min_lines: 80
  key_links:
    - from: "backend/test/unit/"
      to: "backend/src/utils/*.ts"
      via: "vitest imports"
      pattern: "import.*from.*utils"
    - from: "backend/test/unit/"
      to: "backend/src/middleware/*.ts"
      via: "vitest imports"
      pattern: "import.*from.*middleware"
---

<objective>
Write unit tests for backend utilities and middleware functions.

Purpose: Ensure all utility functions and middleware are tested, complementing service tests for complete backend coverage.
Output: Unit test files for utilities and middleware in backend/test/unit/
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/src/utils/password.ts
@backend/src/utils/crypto.ts
@backend/src/utils/helpers.ts
@backend/src/middleware/auth.ts
@backend/src/services/webhook-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create password utility tests</name>
  <files>backend/test/unit/password.test.ts</files>
  <action>
    Create password.test.ts file.
    Write unit tests for:
    - hashPassword: produces valid bcrypt hash
    - verifyPassword: correct password, wrong password, invalid hash format
    - Password strength validation
    
    Mock bcryptjs library using vi.mock().
  </action>
  <verify>Run `cd backend && npm test` - password tests pass</verify>
  <done>Password utility tests exist with good coverage</done>
</task>

<task type="auto">
  <name>Task 2: Create crypto and helpers utility tests</name>
  <files>
    backend/test/unit/crypto.test.ts
    backend/test/unit/helpers.test.ts
  </files>
  <action>
    Create crypto.test.ts:
    - generateKeyPair: produces valid Ed25519 key pair
    - signData: produces valid signature
    - verifySignature: valid signature, invalid signature, wrong key
    - randomId: generates expected format
    
    Create helpers.test.ts:
    - formatError: formats error objects correctly
    - parseAuthHeader: parses Bearer and DPoP headers
    - validateEmail: valid/invalid email formats
    - extractTokenFromHeader: extracts token correctly
  </action>
  <verify>Run `cd backend && npm test` - crypto and helpers tests pass</verify>
  <done>Utility test files exist for crypto and helpers</done>
</task>

<task type="auto">
  <name>Task 3: Create auth middleware and webhook handler tests</name>
  <files>
    backend/test/unit/auth-middleware.test.ts
    backend/test/unit/webhook-handler.test.ts
  </files>
  <action>
    Create auth-middleware.test.ts:
    - authenticateOverseer: valid Bearer token, expired token, no token
    - authenticateAgent: valid DPoP proof, invalid proof, missing proof
    - requireSubscription: active subscription, no subscription, expired
    
    Create webhook-handler.test.ts:
    - handleSubscriptionCreated: processes event correctly
    - handleSubscriptionUpdated: updates status correctly
    - handleSubscriptionCanceled: handles cancellation
    - verifyWebhookSignature: valid signature, invalid signature
    
    Mock dependencies (database, JWT, Paddle).
  </action>
  <verify>Run `cd backend && npm test` - middleware tests pass</verify>
  <done>Auth middleware and webhook handler tests exist</done>
</task>

</tasks>

<verification>
Run `cd backend && npm run test -- --coverage` and verify:
- Utilities and middleware have test coverage
- No critical utility functions are untested
</verification>

<success_criteria>
Backend utility and middleware functions have unit tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-implementation/04-02-SUMMARY.md`
</output>
