---
phase: 04-test-implementation
plan: 10
type: execute
wave: 2
depends_on: ['04-08']
files_modified:
  - backend/test/unit/paddle.test.ts
  - backend/test/unit/agent-expanded.test.ts
  - backend/test/unit/overseer-expanded.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "paddle.ts has >80% code coverage"
    - "agent.ts coverage increased from 5.19% to >60%"
    - "overseer.ts coverage increased from 19.44% to >60%"
  artifacts:
    - path: "backend/test/unit/paddle.test.ts"
      provides: "Complete coverage of paddle.ts service"
      exports: ["getSubscriptionFromPaddle", "getSubscriptionTier", "isSubscriptionActive", "getCustomerTransactions", "isShadowPaymentValid", "getPaddleCustomer", "createPaddleCustomer", "createPaddleCheckout", "getPaddlePriceId"]
      min_coverage: 80
    - path: "backend/test/unit/agent-expanded.test.ts"
      provides: "Additional coverage for agent.ts service"
      exports: ["createAgent", "getAgentById", "getAgentByPublicKey", "incrementOAuthCount", "incrementOAuthCountWithLimitCheck", "canAgentPerformOAuth"]
      target_coverage: 60
    - path: "backend/test/unit/overseer-expanded.test.ts"
      provides: "Additional coverage for overseer.ts service"
      exports: ["createOverseer", "authenticateOverseer", "getOverseerById"]
      target_coverage: 60
  key_links:
    - from: "paddle.test.ts"
      to: "backend/src/services/paddle.ts"
      via: "Direct import with mocked fetch"
      pattern: "global.fetch = vi.fn()"
---

<objective>
Add unit tests for remaining critical backend services: paddle.ts (0% coverage), agent.ts (5.19%), and overseer.ts (19.44%).

**Purpose:** These services handle payments, agent management, and authentication. Low coverage represents significant risk.
**Output:** Comprehensive test coverage for Paddle integration, agent lifecycle, and overseer management
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-test-implementation/04-CONTEXT.md
@.planning/phases/04-test-implementation/04-VERIFICATION.md
@backend/src/services/paddle.ts
@backend/src/services/agent.ts
@backend/src/services/overseer.ts
@backend/test/unit/auth.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create paddle.test.ts for Paddle API service</name>
  <files>backend/test/unit/paddle.test.ts</files>
  <action>
Create comprehensive unit tests for backend/src/services/paddle.ts. Currently 0% coverage - this handles all Paddle payment integration.

**Functions to Test:**

1. **Paddle API Client (Internal):**
   - paddleAPIRequest() - Test fetch calls with proper headers
   - Error handling for 4xx/5xx responses

2. **Subscription Operations:**
   - getSubscriptionFromPaddle() - Mock sandbox-api.paddle.com/subscriptions/{id}
   - getSubscriptionTier() - Extract tier from subscription
   - isSubscriptionActive() - Check active statuses (active, trialing, past_due)

3. **Customer & Transaction Operations:**
   - getCustomerTransactions() - Mock /transactions endpoint
   - isShadowPaymentValid() - Check 30-day validity window
   - getPaddleCustomer() - Mock /customers/{id}

4. **Checkout & Customer Creation:**
   - createPaddleCustomer() - Mock POST /customers
   - createPaddleCheckout() - Mock POST /checkouts
   - getPaddlePriceId() - Map tier to price ID from env

5. **Price ID Mapping:**
   - mapPriceIdToTier() - Internal function via env vars
   - Test all tier mappings (BASIC, PRO, PREMIUM, SHADOW)

**Mock Strategy:**
```typescript
// Mock global fetch for Paddle API calls
global.fetch = vi.fn();

// Mock env
const mockEnv = {
  PADDLE_API_KEY: 'test-api-key',
  PADDLE_PRICE_ID_BASIC: 'pri_basic_xxx',
  PADDLE_PRICE_ID_PRO: 'pri_pro_xxx',
  PADDLE_PRICE_ID_PREMIUM: 'pri_premium_xxx',
  PADDLE_PRICE_ID_SHADOW: 'pri_shadow_xxx',
};
```

**Test Examples:**
- Successful subscription fetch returns mapped tier
- 404 response returns null
- Invalid API key throws error
- Shadow payment valid within 30 days, invalid after
- Checkout creation returns URL
- Price ID mapping works for all tiers

Target: >80% coverage for paddle.ts
  </action>
  <verify>cd backend && npm test -- paddle.test.ts --coverage --reporter=verbose</verify>
  <done>paddle.ts coverage >80%, all tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Create agent-expanded.test.ts</name>
  <files>backend/test/unit/agent-expanded.test.ts</files>
  <action>
Create additional tests for backend/src/services/agent.ts to increase coverage from 5.19% to >60%.

**Current Coverage Gaps (from VERIFICATION.md):**
- createAgent() - likely tested but needs more edge cases
- getAgentById() - basic test exists, needs more
- getAgentByPublicKey() - likely untested
- incrementOAuthCount() - likely untested
- incrementOAuthCountWithLimitCheck() - critical for OAuth limiting, likely untested
- canAgentPerformOAuth() - critical for OAuth authorization, likely untested

**Functions to Test:**

1. **createAgent() - Additional Cases:**
   - Valid agent creation (may exist)
   - Duplicate public key error
   - Invalid public key format (not Ed25519)
   - Missing name error
   - Empty description handled

2. **getAgentByPublicKey():**
   - Find agent by public key
   - Return null for non-existent key

3. **incrementOAuthCount() - Critical:**
   - Increment within billing period
   - Reset count when billing period expired
   - Update billing_period_end on reset

4. **incrementOAuthCountWithLimitCheck() - Critical:**
   - Success case: increment within limits
   - Failure: agent not found
   - Failure: subscription not active
   - Failure: OAuth limit reached
   - Success: unlimited tier (-1 limit)
   - Retry logic on database contention

5. **canAgentPerformOAuth() - Critical:**
   - Returns true for paid subscription
   - Returns false for FREE tier
   - Returns false for non-existent agent
   - Returns true when billing period reset due
   - Returns false when limit exceeded

**Mock Requirements:**
- Mock database for agent CRUD
- Mock subscription service for OAuth limit checks
- Mock env for subscription lookups

Target: agent.ts coverage >60% (from 5.19%)
  </action>
  <verify>cd backend && npm test -- agent-expanded.test.ts --coverage --reporter=verbose</verify>
  <done>agent.ts coverage >60%, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Create overseer-expanded.test.ts</name>
  <files>backend/test/unit/overseer-expanded.test.ts</files>
  <action>
Create additional tests for backend/src/services/overseer.ts to increase coverage from 19.44% to >60%.

**Current Coverage Gaps:**
- createOverseer() - partial tests exist in auth.test.ts
- authenticateOverseer() - partial tests exist
- getOverseerById() - likely untested
- Email validation logic
- Paddle customer creation integration

**Functions to Test:**

1. **createOverseer() - Additional Cases:**
   - Valid overseer creation (may exist)
   - Duplicate email error
   - Invalid email format
   - Short password (<8 chars) error
   - Missing name error
   - Paddle customer creation success
   - Paddle customer creation failure (continues without)
   - Password hashing occurs

2. **authenticateOverseer() - Additional Cases:**
   - Valid credentials return overseer
   - Invalid email returns null
   - Invalid password returns null
   - Password verification uses proper hashing

3. **getOverseerById():**
   - Find overseer by ID
   - Return null for non-existent ID
   - Return full overseer object

4. **Email Validation (isValidEmail - internal):**
   - Valid email formats
   - Invalid email formats (missing @, missing domain, etc.)

**Test Pattern:**
Use similar patterns to auth.test.ts but expand coverage:
```typescript
describe('createOverseer', () => {
  it('should create overseer with valid data', async () => { ... });
  it('should hash password before storing', async () => { ... });
  it('should create Paddle customer when env provided', async () => { ... });
  it('should continue without Paddle customer on error', async () => { ... });
  it('should throw on duplicate email', async () => { ... });
  it('should throw on invalid email', async () => { ... });
  it('should throw on short password', async () => { ... });
  it('should throw on missing name', async () => { ... });
});
```

Target: overseer.ts coverage >60% (from 19.44%)
  </action>
  <verify>cd backend && npm test -- overseer-expanded.test.ts --coverage --reporter=verbose</verify>
  <done>overseer.ts coverage >60%, all tests passing</done>
</task>

</tasks>

<verification>
Run full coverage report:
```bash
cd backend && npm test -- --coverage
```

Expected improvements:
- paddle.ts: 0% → >80%
- agent.ts: 5.19% → >60%
- overseer.ts: 19.44% → >60%
- Overall backend moving toward 80% target
</verification>

<success_criteria>
- [ ] paddle.test.ts created with >80% coverage of paddle.ts
- [ ] agent-expanded.test.ts created, agent.ts coverage >60%
- [ ] overseer-expanded.test.ts created, overseer.ts coverage >60%
- [ ] All tests follow existing mock patterns from auth.test.ts
- [ ] No dynamic import issues (all tests use proper mocking)
- [ ] Tests cover both success and error cases
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-implementation/04-10-SUMMARY.md`
</output>
