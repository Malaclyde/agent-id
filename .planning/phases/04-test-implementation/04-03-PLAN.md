---
phase: 04-test-implementation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/test/integration/paddle-api.test.ts
autonomous: true

must_haves:
  truths:
    - "Backend integration tests verify Paddle API client with mocked responses"
    - "Checkout flow can be tested with mocked API"
    - "Webhook events are handled correctly with mocked Paddle"
    - "Customer queries work as expected with mocked responses"
  artifacts:
    - path: "backend/test/integration/paddle-api.test.ts"
      provides: "Integration tests for Paddle API client (mocked)"
      min_lines: 150
  key_links:
    - from: "backend/test/integration/"
      to: "backend/src/services/paddle-api.ts"
      via: "mocked Paddle client"
      pattern: "createCustomer|getCustomer|createCheckout"
---

<objective>
Write backend integration tests for Paddle API client with mocked responses.

Purpose: Verify Paddle API client functions work correctly using mocked responses. Per user decision: Unit & Integration tests mock Paddle entirely (no real API calls).
Output: Integration test file at backend/test/integration/paddle-api.test.ts
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/src/services/paddle-api.ts
@backend/src/services/paddle-customer.ts
@backend/test/paddle-api.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand Paddle API integration tests with mocks</name>
  <files>backend/test/integration/paddle-api.test.ts</files>
  <action>
    Create backend/test/integration/ directory and expand paddle-api.test.ts.
    
    Per user decision: Mock Paddle entirely for Unit & Integration tests (no real API calls).
    
    Use vi.fn() or a mock library to mock the Paddle SDK client. Mock the following functions:
    - createCustomer: mock returns customer object with ID
    - getCustomer: mock returns customer details
    - listCustomers: mock returns paginated customer list
    - createCheckout: mock returns checkout session object
    - getSubscription: mock returns subscription details
    - updateSubscription: mock returns updated subscription
    - cancelSubscription: mock returns canceled subscription
    - createCustomerPortalSession: mock returns portal URL
    
    Test error handling paths:
    - API errors (network failure, invalid request)
    - Invalid customer ID
    - Checkout creation failures
    
    Verify the paddle-api.ts module's logic handles responses and errors correctly.
  </action>
  <verify>Run `cd backend && npm run test:integration` - all Paddle integration tests pass</verify>
  <done>Paddle integration tests verify mocked API client interactions</done>
</task>

<task type="auto">
  <name>Task 2: Add webhook event integration tests</name>
  <files>backend/test/integration/webhook-events.test.ts</files>
  <action>
    Create webhook-events.test.ts file.
    
    Write tests that simulate webhook event processing:
    - subscription.created: verifies database update
    - subscription.updated: verifies tier change processing
    - subscription.canceled: verifies cancellation handling
    - subscription.reactivated: verifies reactivation
    
    Mock the incoming webhook payload from Paddle.
    Test signature verification with real h1= format signatures.
  </action>
  <verify>Run `cd backend && npm test` - webhook event tests pass</verify>
  <done>Webhook event handling is tested with simulated events</done>
</task>

</tasks>

<verification>
Run `cd backend && npm run test:integration` and verify:
- All Paddle API mock calls succeed
- Webhook event processing works correctly with mocked events
</verification>

<success_criteria>
Backend integration tests verify Paddle API client with mocked interactions (checkout, webhooks, customer queries)
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-implementation/04-03-SUMMARY.md`
</output>
