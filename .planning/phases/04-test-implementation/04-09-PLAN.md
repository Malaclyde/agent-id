---
phase: 04-test-implementation
plan: 09
type: execute
wave: 2
depends_on: ['04-08']
files_modified:
  - backend/test/unit/ownership.test.ts
  - backend/test/unit/oversights.test.ts
  - backend/test/unit/claim-scenarios.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ownership.ts has >80% code coverage"
    - "oversights.ts has >80% code coverage"
    - "Claim test scenarios TS-001 through TS-014 have unit tests"
  artifacts:
    - path: "backend/test/unit/ownership.test.ts"
      provides: "Complete coverage of ownership.ts service"
      exports: ["claimAgent", "revokeOverseer", "generateShadowOverseerId", "isShadowOverseer", "validateOverseerId", "getOverseerAgents", "isAgentClaimed", "isAgentOwnedBy", "countAgentsByOverseer", "markAgentForCancellation"]
      min_coverage: 80
    - path: "backend/test/unit/oversights.test.ts"
      provides: "Complete coverage of oversights.ts service"
      exports: ["createOversight", "deactivateOversight", "getActiveOversight", "getOverseerAgents", "getOverseerActiveAgents", "markOversightForCancellation", "unmarkOversightForCancellation", "countActiveAgentsByOverseer", "isAgentOversightedBy", "getOversightForAgent"]
      min_coverage: 80
    - path: "backend/test/unit/claim-scenarios.test.ts"
      provides: "Test scenarios TS-001 through TS-014 for claim flow"
      min_tests: 14
  key_links:
    - from: "ownership.test.ts"
      to: "backend/src/services/ownership.ts"
      via: "Direct import and function testing"
      pattern: "import.*from.*services/ownership"
    - from: "oversights.test.ts"
      to: "backend/src/services/oversights.ts"
      via: "Direct import and function testing"
      pattern: "import.*from.*services/oversights"
---

<objective>
Add comprehensive unit tests for ownership.ts and oversights.ts services, plus implement all 14 claim test scenarios (TS-001 through TS-014).

**Purpose:** These services handle the critical claim/unclaim flow (0% coverage currently). This is a core business requirement that must be tested thoroughly.
**Output:** Complete test coverage for claim/unclaim functionality + all claim scenario tests
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-test-implementation/04-CONTEXT.md
@.planning/phases/04-test-implementation/04-VERIFICATION.md
@backend/src/services/ownership.ts
@backend/src/services/oversights.ts
@test/coverage/test-scenarios-matrix.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive oversights.test.ts</name>
  <files>backend/test/unit/oversights.test.ts</files>
  <action>
Create comprehensive unit tests for backend/src/services/oversights.ts. Currently 0% coverage.

**Functions to Test:**
1. createOversight() - Create oversight relationship
2. deactivateOversight() - Deactivate an oversight
3. getActiveOversight() - Get active oversight for agent
4. getOverseerAgents() - Get all agents for overseer
5. getOverseerActiveAgents() - Get only active agents
6. markOversightForCancellation() - Mark for cancellation
7. unmarkOversightForCancellation() - Unmark cancellation
8. countActiveAgentsByOverseer() - Count active agents
9. getOversightById() - Get by ID
10. isAgentUnderActiveOversight() - Check if agent has oversight
11. isAgentOversightedBy() - Check specific overseer
12. getAgentsMarkedForCancellation() - Get marked agents
13. getOversightForAgent() - Get most recent oversight (even inactive)

**Test Pattern:**
- Mock D1Database using existing test patterns from other unit tests
- Use vi.fn() for database queries
- Test both success and error cases
- Verify database queries are called with correct parameters

**Example Structure:**
```typescript
describe('createOversight', () => {
  it('should create oversight with valid data', async () => {
    // mock db.insert().values().returning()
    // call createOversight
    // verify returned oversight has correct fields
  });
  
  it('should throw on database error', async () => {
    // mock db.insert to throw
    // expect createOversight to throw
  });
});
```

Target: >80% coverage for oversights.ts
  </action>
  <verify>cd backend && npm test -- oversights.test.ts --coverage --reporter=verbose</verify>
  <done>oversights.ts coverage >80%, all tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Expand ownership.test.ts for full coverage</name>
  <files>backend/test/unit/ownership.test.ts</files>
  <action>
Expand the existing ownership.test.ts to achieve >80% coverage. Currently has basic tests but doesn't cover the main claimAgent and revokeOverseer logic.

**Functions to Add Tests For:**

1. **claimAgent() - Critical path:**
   - Successfully claim an unclaimed agent
   - Attempt to claim non-existent agent (error)
   - Attempt to claim by FREE tier overseer (error)
   - Attempt to claim when at agent limit (error)
   - Claim agent that was shadow-claimed (should deactivate old oversight, delete shadow overseer)
   - Invalid overseer ID (error)
   - Missing env (error)

2. **revokeOverseer() - Critical path:**
   - Successfully revoke oversight
   - Attempt to revoke non-existent agent (error)
   - Attempt to revoke when no active oversight (error)
   - Revoke shadow overseer (should delete overseer record)

3. **getOverseerAgents() - Critical path:**
   - Get agents for overseer with multiple agents
   - Get agents for overseer with no agents
   - Get agents with some inactive oversights

4. **validateOverseerId():**
   - Valid overseer in database
   - Valid shadow overseer (cryptographic validation)
   - Invalid overseer ID
   - Missing env for shadow validation

5. **isAgentOwnedBy() and countAgentsByOverseer():**
   - Basic functionality tests

**Mock Requirements:**
- Mock all services: agent.ts, overseer.ts, oversights.ts, subscription.ts
- Mock database for ownership.ts direct DB calls
- Mock env with SHADOW_SECRET for cryptographic tests

Target: >80% coverage for ownership.ts
  </action>
  <verify>cd backend && npm test -- ownership.test.ts --coverage --reporter=verbose</verify>
  <done>ownership.ts coverage >80%, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Create claim-scenarios.test.ts for TS-001 through TS-014</name>
  <files>backend/test/unit/claim-scenarios.test.ts</files>
  <action>
Create a dedicated test file implementing all 14 claim test scenarios from the test scenarios matrix.

**Test Scenarios to Implement (from test-scenarios-matrix.md):**

| TS ID | Scenario | Test Implementation |
|-------|----------|---------------------|
| TS-001 | Overseer Claims Unclaimed Agent | claimAgent() with valid unclaimed agent |
| TS-002 | Agent Renounces Overseer | revokeOverseer() from agent perspective |
| TS-003 | Overseer Ends Oversight | revokeOverseer() called by overseer |
| TS-004 | Unclaimed Agent Gets Shadow Claimed | create shadow overseer, claim with shadow ID |
| TS-005 | Shadow-Claimed Agent Gets Shadow Claimed Again | new shadow overseer claims already shadow-claimed agent |
| TS-006 | Shadow-Claimed Agent Gets Claimed by Human | real overseer claims shadow-claimed agent (deletes shadow) |
| TS-007 | Overseer Attempts to Claim Already Claimed Agent | claimAgent on already-claimed agent (error) |
| TS-008 | Agent Does Not Respond to Claim Procedure | Test challenge expiration (if applicable) |
| TS-009 | Overseer Without Subscription Attempts to Claim | FREE tier overseer tries to claim (error) |
| TS-010 | Invalid Claim Challenge ID | Test with invalid challenge (error) |
| TS-011 | Overseer Checks Claim Status (Pending) | Check oversight status |
| TS-012 | Overseer Checks Claim Status (Expired) | Check expired oversight |
| TS-013 | Agent Approves Wrong Overseer in Claim | Security test - wrong overseer ID |
| TS-014 | Overseer Tries to Check Another Overseer's Claim | Authorization test |

**Implementation Notes:**
- These are integration-style tests within the unit test framework
- Mock all external dependencies (DB, Paddle, etc.)
- Focus on business logic validation
- Each test should be self-contained with proper setup/teardown

**Structure:**
```typescript
describe('Claim Test Scenarios (TS-001 to TS-014)', () => {
  describe('TS-001: Overseer Claims Unclaimed Agent', () => { ... });
  describe('TS-002: Agent Renounces Overseer', () => { ... });
  // ... etc
});
```
  </action>
  <verify>cd backend && npm test -- claim-scenarios.test.ts</verify>
  <done>All 14 claim scenario tests implemented and passing</done>
</task>

</tasks>

<verification>
Run coverage report to verify improvements:
```bash
cd backend && npm test -- --coverage
```

Expected coverage improvements:
- oversights.ts: 0% → >80%
- ownership.ts: 0% → >80%
- Overall backend: 35.83% → target 50%+ (this plan alone)
</verification>

<success_criteria>
- [ ] oversights.ts coverage >80%
- [ ] ownership.ts coverage >80%
- [ ] 14 claim scenario tests (TS-001 through TS-014) implemented and passing
- [ ] All tests using proper mock patterns (no dynamic import issues)
- [ ] Test file follows project naming conventions (kebab-case)
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-implementation/04-09-SUMMARY.md`
</output>
