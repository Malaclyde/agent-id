---
phase: 04-test-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/test/unit/auth.test.ts
  - backend/test/unit/subscription.test.ts
  - backend/test/unit/client-limits.test.ts
  - backend/test/unit/oauth-flow.test.ts
  - backend/test/unit/dpop.test.ts
  - backend/test/unit/ownership.test.ts
autonomous: true

must_haves:
  truths:
    - "Backend service functions have unit tests with >80% coverage"
    - "Auth service (overseer, agent) functions are tested"
    - "Subscription service functions are tested"
    - "Client-limits service functions are tested"
    - "OAuth-flow service functions are tested"
    - "DPoP service functions are tested"
    - "Ownership service functions are tested"
  artifacts:
    - path: "backend/test/unit/auth.test.ts"
      provides: "Unit tests for overseer and agent auth services"
      min_lines: 100
    - path: "backend/test/unit/subscription.test.ts"
      provides: "Unit tests for subscription service"
      min_lines: 80
    - path: "backend/test/unit/client-limits.test.ts"
      provides: "Unit tests for client-limits service"
      min_lines: 60
    - path: "backend/test/unit/oauth-flow.test.ts"
      provides: "Unit tests for oauth-flow service"
      min_lines: 80
    - path: "backend/test/unit/dpop.test.ts"
      provides: "Unit tests for DPoP proof generation/verification"
      min_lines: 60
    - path: "backend/test/unit/ownership.test.ts"
      provides: "Unit tests for ownership/claim services"
      min_lines: 60
  key_links:
    - from: "backend/test/unit/"
      to: "backend/src/services/*.ts"
      via: "vitest imports"
      pattern: "import.*from.*services"
---

<objective>
Write comprehensive unit tests for backend services covering auth, subscription, client-limits, oauth-flow, dpop, and ownership services.

Purpose: Ensure backend business logic is thoroughly tested with mocked dependencies, targeting >80% code coverage.
Output: Unit test files in backend/test/unit/ directory
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/src/services/overseer.ts
@backend/src/services/agent.ts
@backend/src/services/subscription.ts
@backend/src/services/client-limits.ts
@backend/src/services/oauth-flow.ts
@backend/src/services/dpop.ts
@backend/src/services/ownership.ts
@backend/src/services/__tests__/limits.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth service unit tests</name>
  <files>backend/test/unit/auth.test.ts</files>
  <action>
    Create backend/test/unit/ directory and auth.test.ts file.
    Write unit tests for:
    - registerOverseer: valid input, duplicate email, invalid password
    - loginOverseer: valid credentials, wrong password, non-existent email
    - verifyOverseerSession: valid session, expired session, invalid session
    - logoutOverseer: successful logout
    
    Use vitest with vi.mock() for dependencies (bcrypt, jose, database).
    Mock D1 database, JWT signing, password hashing.
    Test boundary conditions and error cases.
  </action>
  <verify>Run `cd backend && npm test` - all auth tests pass</verify>
  <done>Auth service tests exist with >80% coverage on overseer.ts and agent.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create subscription service unit tests</name>
  <files>backend/test/unit/subscription.test.ts</files>
  <action>
    Create subscription.test.ts file.
    Write unit tests for:
    - getActiveSubscription: with valid tier, no subscription, expired
    - getAgentSubscription: agent with active subscription, without subscription
    - Subscription tier limits mapping (FREE, BASIC, PRO, PREMIUM, SHADOW)
    - Subscription status validation
    
    Mock Paddle API calls (per mocking strategy - unit tests mock Paddle).
    Mock database queries.
  </action>
  <verify>Run `cd backend && npm test` - subscription tests pass</verify>
  <done>Subscription service tests exist with >80% coverage</done>
</task>

<task type="auto">
  <name>Task 3: Create client-limits, oauth-flow, dpop, ownership tests</name>
  <files>
    backend/test/unit/client-limits.test.ts
    backend/test/unit/oauth-flow.test.ts
    backend/test/unit/dpop.test.ts
    backend/test/unit/ownership.test.ts
  </files>
  <action>
    Create all four test files:
    
    client-limits.test.ts:
    - countClientsByOverseer
    - canRegisterClient: under limit, at limit, over limit
    - enforceClientLimitsForOverseer
    
    oauth-flow.test.ts:
    - generateAuthorizationCode
    - validateAuthorizationRequest
    - exchangeCodeForTokens
    - generateDPoPToken
    
    dpop.test.ts:
    - generateDPoPProof
    - verifyDPoPProof
    - createDPoPAccessToken
    
    ownership.test.ts:
    - claimAgent
    - unclaimAgent
    - verifyOwnership
    - getOverseerForAgent
    
    Use vi.mock() to mock all dependencies. Test happy paths and error cases.
  </action>
  <verify>Run `cd backend && npm test` - all new tests pass</verify>
  <done>All four service test files exist with >80% coverage each</done>
</task>

</tasks>

<verification>
Run `cd backend && npm run test -- --coverage` and verify:
- Overall backend coverage >80%
- All service functions have at least one test
- No untested critical paths in auth, subscription, OAuth flows
</verification>

<success_criteria>
Backend unit tests exist for all service-layer functions with >80% coverage
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-implementation/04-01-SUMMARY.md`
</output>
