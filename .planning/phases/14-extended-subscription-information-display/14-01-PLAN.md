---
phase: 14-extended-subscription-information-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/paddle.ts
  - backend/src/services/subscription.ts
  - backend/src/routes/subscriptions.ts
  - frontend/src/types/index.ts
  - frontend/src/pages/SubscriptionManagement.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see whether their subscription will renew"
    - "User sees 'Cancel Subscription' when subscription will renew"
    - "User sees 'Renew Subscription' when subscription will not renew"
    - "User sees renewal status message (e.g., 'Renews on [date]' or 'Cancels on [date]')"
    - "Button click action is appropriate for the state"
  artifacts:
    - path: "backend/src/services/paddle.ts"
      provides: "PaddleSubscription interface updated with scheduled_change, next_billed_at, canceled_at"
      min_lines: 50
    - path: "backend/src/services/subscription.ts"
      provides: "SubscriptionWithLimits interface updated with will_renew, scheduled_cancel_at"
      min_lines: 30
    - path: "backend/src/routes/subscriptions.ts"
      provides: "GET /v1/subscriptions/me returns will_renew and scheduled_cancel_at"
      exports: ["GET /me"]
    - path: "frontend/src/types/index.ts"
      provides: "Subscription type updated with will_renew and scheduled_cancel_at"
    - path: "frontend/src/pages/SubscriptionManagement.tsx"
      provides: "Dynamic button text and status message based on will_renew"
  key_links:
    - from: "backend/src/services/paddle.ts"
      to: "backend/src/services/subscription.ts"
      via: "PaddleSubscription returned to getActiveSubscription"
      pattern: "getSubscriptionsByCustomer.*env"
    - from: "backend/src/services/subscription.ts"
      to: "backend/src/routes/subscriptions.ts"
      via: "getActiveSubscription called in /me endpoint"
      pattern: "getActiveSubscription.*DB.*env"
    - from: "backend/src/routes/subscriptions.ts"
      to: "frontend/src/pages/SubscriptionManagement.tsx"
      via: "API response to api.getSubscription()"
      pattern: "will_renew.*scheduled_cancel_at"
---

<objective>
Add billing period end date and renewal status to the subscription pane. The "Cancel Subscription" button should change to "Renew Subscription" when the subscription is set to cancel at period end.

Purpose: Users should understand their subscription renewal status and have the option to renew if they've canceled.

Output: Backend returns `will_renew` and `scheduled_cancel_at` fields; frontend displays appropriate button and status message.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-extended-subscription-information-display/14-CONTEXT.md
@.planning/phases/14-extended-subscription-information-display/14-RESEARCH.md

# Current implementation files
@backend/src/services/paddle.ts
@backend/src/services/subscription.ts
@backend/src/routes/subscriptions.ts
@frontend/src/types/index.ts
@frontend/src/pages/SubscriptionManagement.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend - Add renewal status fields to Paddle subscription service</name>
  <files>backend/src/services/paddle.ts</files>
  <action>
    1. Update the `PaddleSubscription` interface to include:
       - `scheduled_change`: { action: string; effective_at: string } | null
       - `next_billed_at`: string | null
       - `canceled_at`: string | null

    2. Update `getSubscriptionsByCustomer()` function to map these fields from Paddle API response:
       - Map `sub.scheduled_change` from the response
       - Map `sub.next_billed_at` from the response
       - Map `sub.canceled_at` from the response
  </action>
  <verify>
    - grep "scheduled_change" backend/src/services/paddle.ts
    - grep "next_billed_at" backend/src/services/paddle.ts
    - Verify function returns these fields in the mapped object
  </verify>
  <done>
    PaddleSubscription interface includes scheduled_change, next_billed_at, canceled_at
    getSubscriptionsByCustomer maps these fields from Paddle API response
  </done>
</task>

<task type="auto">
  <name>Task 2: Backend - Add will_renew and scheduled_cancel_at to subscription service</name>
  <files>backend/src/services/subscription.ts</files>
  <action>
    1. Update `SubscriptionWithLimits` interface to include:
       - `will_renew`: boolean (true if next_billed_at is set, false if scheduled cancel or no future billing)
       - `scheduled_cancel_at`: string | null (effective_at from scheduled_change if action is "cancel")

    2. Update `getActiveSubscription()` function to calculate these values:
       - If paddleSub exists:
         - will_renew = next_billed_at !== null && no scheduled cancel
         - scheduled_cancel_at = scheduled_change?.effective_at if action is "cancel"
  </action>
  <verify>
    - grep "will_renew" backend/src/services/subscription.ts
    - grep "scheduled_cancel_at" backend/src/services/subscription.ts
  </verify>
  <done>
    SubscriptionWithLimits includes will_renew and scheduled_cancel_at
    getActiveSubscription calculates will_renew based on next_billed_at and scheduled_change
  </done>
</task>

<task type="auto">
  <name>Task 3: Backend - Update subscriptions endpoint to return renewal fields</name>
  <files>backend/src/routes/subscriptions.ts</files>
  <action>
    Update GET /v1/subscriptions/me endpoint to include will_renew and scheduled_cancel_at in the response:
    - Add will_renew: sanitized.will_renew
    - Add scheduled_cancel_at: sanitized.scheduled_cancel_at
  </action>
  <verify>
    - grep "will_renew" backend/src/routes/subscriptions.ts
    - grep "scheduled_cancel_at" backend/src/routes/subscriptions.ts
    - Verify these fields are in the JSON response object
  </verify>
  <done>
    GET /v1/subscriptions/me returns will_renew and scheduled_cancel_at in the subscription object
  </done>
</task>

<task type="auto">
  <name>Task 4: Frontend - Update Subscription type</name>
  <files>frontend/src/types/index.ts</files>
  <action>
    Update the Subscription interface to include:
    - `will_renew`: boolean
    - `scheduled_cancel_at`: string | null
  </action>
  <verify>
    - grep "will_renew" frontend/src/types/index.ts
    - grep "scheduled_cancel_at" frontend/src/types/index.ts
  </verify>
  <done>
    Subscription type includes will_renew and scheduled_cancel_at fields
  </done>
</task>

<task type="auto">
  <name>Task 5: Frontend - Update SubscriptionManagement with dynamic button and status</name>
  <files>frontend/src/pages/SubscriptionManagement.tsx</files>
  <action>
    1. Update the button text logic in CurrentSubscriptionCard:
       - If subscription.tier !== 'FREE' AND subscription.is_active:
         - If subscription.will_renew === false: show "Renew Subscription"
         - Else: show "Cancel Subscription"

    2. Add status message display:
       - If will_renew === true: show "Renews on [billing_period_end]"
       - If will_renew === false AND scheduled_cancel_at: show "Cancels on [scheduled_cancel_at]"
       - If status === 'past_due': show "Payment overdue"
       - If status === 'trialing': show "Trial ends on [billing_period_end]"
       - If status === 'paused': show "Paused"

    3. Update the onCancel/onRenew handler:
       - If will_renew === false: call api.initiateUpgrade(currentTier) to create new subscription
       - Otherwise: show cancel confirmation modal (existing behavior)
  </action>
  <verify>
    - grep "will_renew" frontend/src/pages/SubscriptionManagement.tsx
    - Verify button text changes based on will_renew
    - Verify status message displays based on subscription state
  </verify>
  <done>
    Button text dynamically changes between "Cancel Subscription" and "Renew Subscription"
    Status message displays appropriate renewal/cancellation information
  </done>
</task>

</tasks>

<verification>
- Backend: Start the dev server and call GET /v1/subscriptions/me with an authenticated overseer
- Verify response includes will_renew and scheduled_cancel_at fields
- Frontend: Run npm run build to verify no TypeScript errors
- Manual test: Navigate to SubscriptionManagement page, verify:
  - Active subscription with renewal shows "Cancel Subscription" button with "Renews on [date]"
  - Canceled subscription shows "Renew Subscription" button with "Cancels on [date]"
</verification>

<success_criteria>
- [ ] Backend returns will_renew and scheduled_cancel_at in subscription response
- [ ] Frontend Subscription type includes will_renew and scheduled_cancel_at
- [ ] Button shows "Cancel Subscription" when will_renew is true
- [ ] Button shows "Renew Subscription" when will_renew is false
- [ ] Status message displays appropriate renewal/cancellation information
- [ ] No TypeScript errors in frontend build
</success_criteria>

<output>
After completion, create `.planning/phases/14-extended-subscription-information-display/14-01-SUMMARY.md`
</output>
