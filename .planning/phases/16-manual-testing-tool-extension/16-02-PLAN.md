---
phase: 16-manual-testing-tool-extension
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - test/manual-script/agent-notebook.ipynb
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Notebook runs end-to-end OAuth flow with DPoP"
    - "Notebook includes client registration, userinfo, and token refresh"
    - "Notebook is fully self-contained with no external dependencies beyond requests and cryptography"
  artifacts:
    - path: "test/manual-script/agent-notebook.ipynb"
      provides: "Python notebook for agent/client simulation"
      cells: ["setup", "authorization", "token", "key_generation", "dpop", "client_registration", "userinfo", "token_refresh"]
  key_links:
    - from: "test/manual-script/agent-notebook.ipynb"
      to: "backend/src/services/dpop.ts"
      via: "Reference implementation for DPoP proof structure"
      pattern: "DPoP.*htu.*htm"
---

<objective>
Create Python notebook for agent/client simulation with OAuth flow, DPoP, and helper functions.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/16-manual-testing-tool-extension/16-CONTEXT.md

## Phase 16 Requirements (from ROADMAP.md)

**Python Notebook Goal:** Create agent-notebook.ipynb with DPoP, OAuth flow, client registration

## Notebook Implementation Details (from CONTEXT.md)

**Organization:**
- Separate cells for each function
- Results saved in variables for reuse across cells

**Error Handling:**
- Return error dicts with full info (not raise exceptions)

**Self-Contained:**
- Fully self-contained - no external dependencies beyond requests and cryptography

**OAuth Flow:**
- Setup Cell: Save necessary info in variables: client_id, client_secret, base_url, claims, etc.; Generate code_verifier and code_challenge based on client private key; Leave placeholders for user to fill in manually
- Authorization Cell: Calculate JWT for the chosen agent; Send request to /authorize endpoint; Authorization code returned in response
- Token Cell: Calculate JWT for client based on client private key; Include code_verifier in request; Simultaneously start listening on localhost:8789; Receive and capture access_token and refresh_token from callback

**DPoP Implementation:**
- Key Generation: Use cryptography library for ED25519 key generation; Dedicated function in separate cell; Reference backend implementation for correct structure
- DPoP JWT: Dedicated function in separate cell; Include htu (HTTP target URI) and htm (HTTP method) claims; Reference backend dpop.ts implementation

**Additional Features:**
- Agent Client Registration: Add separate cell for agent to register a new client; Include all necessary parameters (name, public_key, redirect_uris, etc.)
- UserInfo Query: Add function to query /userinfo with retrieved access token
- Token Refresh: Add function to refresh access token using refresh token
</context>

<tasks>

<task type="auto">
  <name>Task 3: Create notebook structure</name>
  <files>
    - test/manual-script/agent-notebook.ipynb
  </files>
  <action>
    Create the notebook at test/manual-script/agent-notebook.ipynb:
    - Dependencies: requests, cryptography
    - Structure: Separate cells for each function
    - Error handling: Return error dicts (not raise exceptions)
    - Self-contained: No external dependencies beyond requests and cryptography
    
    Create the basic notebook structure with cells for:
    - Imports and setup
    - Each function in its own cell
    - Results saved in variables for reuse
  </action>
  <verify>Notebook file exists with proper Jupyter structure</verify>
  <done>Notebook created with proper structure and cells</done>
</task>

<task type="auto">
  <name>Task 4: Implement OAuth flow cells</name>
  <files>
    - test/manual-script/agent-notebook.ipynb
  </files>
  <action>
    Implement the OAuth flow cells:
    
    **Setup Cell:**
    - Save in variables: client_id, client_secret, base_url, claims, etc.
    - Generate code_verifier using PKCE
    - Generate code_challenge based on client private key
    - Leave placeholders for user to fill in manually
    
    **Authorization Cell:**
    - Calculate JWT for the chosen agent
    - Send request to /authorize endpoint
    - Capture authorization code returned in response
    
    **Token Cell:**
    - Calculate JWT for client based on client private key
    - Include code_verifier in request
    - Simultaneously start listening on localhost:8789
    - Receive and capture access_token and refresh_token from callback
  </action>
  <verify>OAuth flow cells execute successfully</verify>
  <done>Notebook can complete OAuth authorization code flow end-to-end</done>
</task>

<task type="auto">
  <name>Task 5: Implement DPoP and helper functions</name>
  <files>
    - test/manual-script/agent-notebook.ipynb
  </files>
  <action>
    Implement DPoP and helper function cells:
    
    **Key Generation Cell:**
    - Use cryptography library for ED25519 key generation
    - Dedicated function in separate cell
    - Reference backend implementation for correct structure
    
    **DPoP Proof Cell:**
    - Dedicated function in separate cell
    - Include htu (HTTP target URI) and htm (HTTP method) claims
    - Reference backend dpop.ts implementation
    
    **Client Registration Cell:**
    - Agent registers new client with name, public_key, redirect_uris, etc.
    
    **UserInfo Cell:**
    - Query /userinfo with retrieved access token
    
    **Token Refresh Cell:**
    - Refresh access token using refresh token
  </action>
  <verify>All helper functions work correctly</verify>
  <done>Notebook includes DPoP, client registration, userinfo, and token refresh</done>
</task>

</tasks>

<verification>
1. Notebook runs end-to-end OAuth flow with DPoP
2. Notebook includes client registration, userinfo, and token refresh
3. Notebook is fully self-contained with no external dependencies beyond requests and cryptography
</verification>

<success_criteria>
- [ ] Notebook runs end-to-end OAuth flow with DPoP
- [ ] Notebook includes client registration, userinfo, and token refresh
- [ ] Notebook is fully self-contained with no external dependencies beyond requests and cryptography
</success_criteria>

<output>
After completion, create `.planning/phases/16-manual-testing-tool-extension/16-02-SUMMARY.md`
</output>
