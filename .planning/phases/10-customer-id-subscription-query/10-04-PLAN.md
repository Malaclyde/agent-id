---
phase: 10-customer-id-subscription-query
plan: 04
type: execute
wave: 4
depends_on: [10-03]
files_modified: [backend/src/services/paddle.ts]
autonomous: true

must_haves:
  truths:
    - "No getSubscriptionFromPaddle calls remain in backend code"
    - "Helper functions updated to use customer_id"
  artifacts:
    - path: "backend/src/services/paddle.ts"
      contains: "getSubscriptionByCustomer"
---

<objective>
Deprecate or update the remaining subscription_id-based functions in paddle.ts.

Purpose: Ensure no backend code uses subscription_id to query Paddle. Update or deprecate getSubscriptionFromPaddle, getSubscriptionTier, and isSubscriptionActive.

Output: Cleaned up paddle.ts with customer_id-based functions.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/src/services/paddle.ts

Project context:
- getSubscriptionFromPaddle is still defined but should not be used
- getSubscriptionTier and isSubscriptionActive use it internally
- These should either be deprecated or updated to use customer_id
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update getSubscriptionTier to use customer_id</name>
  <files>backend/src/services/paddle.ts</files>
  <action>
    Update getSubscriptionTier function (line 134-140) to accept customer_id instead of subscription_id:

    Change:
    ```typescript
    export async function getSubscriptionTier(
      subscriptionId: string,
      env: Env
    ): Promise<string | null> {
      const subscription = await getSubscriptionFromPaddle(subscriptionId, env);
      return subscription?.tier_id || null;
    }
    ```

    To:
    ```typescript
    /**
     * Get subscription tier for a customer
     * @param customerId - Paddle customer ID (ctm_xxx format)
     * @returns Tier ID (BASIC, PRO, PREMIUM) or null
     * @deprecated Use getSubscriptionByCustomer instead
     */
    export async function getSubscriptionTier(
      customerId: string,
      env: Env
    ): Promise<string | null> {
      const subscription = await getSubscriptionByCustomer(customerId, env);
      return subscription?.tier_id || null;
    }
    ```

    Add @deprecated tag noting to use getSubscriptionByCustomer instead.
  </action>
  <verify>
    Run `grep -n "getSubscriptionTier" backend/src/services/paddle.ts` to confirm updated.
  </verify>
  <done>
    getSubscriptionTier now uses customer_id.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update isSubscriptionActive to use customer_id</name>
  <files>backend/src/services/paddle.ts</files>
  <action>
    Update isSubscriptionActive function (line 147-160) to accept customer_id instead of subscription_id:

    Change:
    ```typescript
    export async function isSubscriptionActive(
      subscriptionId: string,
      env: Env
    ): Promise<boolean> {
      const subscription = await getSubscriptionFromPaddle(subscriptionId, env);

      if (!subscription) {
        return false;
      }

      // Paddle subscription statuses that are considered "active"
      const activeStatuses = ['active', 'trialing', 'past_due'];
      return activeStatuses.includes(subscription.status);
    }
    ```

    To:
    ```typescript
    /**
     * Check if customer has an active subscription
     * @param customerId - Paddle customer ID (ctm_xxx format)
     * @returns true if customer has active subscription, false otherwise
     * @deprecated Use getSubscriptionByCustomer instead and check status
     */
    export async function isSubscriptionActive(
      customerId: string,
      env: Env
    ): Promise<boolean> {
      const subscription = await getSubscriptionByCustomer(customerId, env);

      if (!subscription) {
        return false;
      }

      // Paddle subscription statuses that are considered "active"
      const activeStatuses = ['active', 'trialing', 'past_due'];
      return activeStatuses.includes(subscription.status);
    }
    ```

    Add @deprecated tag.
  </action>
  <verify>
    Run `grep -n "isSubscriptionActive" backend/src/services/paddle.ts` to confirm updated.
  </verify>
  <done>
    isSubscriptionActive now uses customer_id.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mark getSubscriptionFromPaddle as deprecated</name>
  <files>backend/src/services/paddle.ts</files>
  <action>
    Add @deprecated tag to getSubscriptionFromPaddle function:

    Change the function comment from:
    ```typescript
    /**
     * Get subscription details from Paddle
     * @param subscriptionId - Paddle subscription ID (sub_xxx format)
     * @returns Subscription object with tier information or null if not found
     */
    ```

    To:
    ```typescript
    /**
     * Get subscription details from Paddle
     * @param subscriptionId - Paddle subscription ID (sub_xxx format)
     * @returns Subscription object with tier information or null if not found
     * @deprecated Use getSubscriptionByCustomer or getSubscriptionsByCustomer instead
     */
    ```

    This marks it as deprecated but keeps it for backward compatibility during transition.
  </action>
  <verify>
    Run `grep -n "@deprecated" backend/src/services/paddle.ts` to confirm deprecation tags present.
  </verify>
  <done>
    getSubscriptionFromPaddle marked as deprecated.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. getSubscriptionTier uses customer_id
2. isSubscriptionActive uses customer_id
3. getSubscriptionFromPaddle marked as deprecated
4. TypeScript compiles without errors
</verification>

<success_criteria>
- All functions use customer_id
- Deprecated tags added
- No active calls to subscription_id-based queries
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-id-subscription-query/10-04-SUMMARY.md`
</output>
