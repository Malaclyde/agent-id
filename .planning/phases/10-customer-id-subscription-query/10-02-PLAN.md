---
phase: 10-customer-id-subscription-query
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified: [backend/src/services/subscription.ts]
autonomous: true

must_haves:
  truths:
    - "getActiveSubscription uses customer_id to query Paddle"
    - "subscription_id is not used in subscription query logic"
    - "Shadow overseers handled correctly (no subscription = FREE tier)"
  artifacts:
    - path: "backend/src/services/subscription.ts"
      provides: "Customer-based subscription queries"
      contains: "getSubscriptionByCustomer"
      not_contains: "getSubscriptionFromPaddle"
---

<objective>
Update subscription.ts to use customer_id-based queries instead of subscription_id.

Purpose: Replace all Paddle subscription queries to use customer_id instead of subscription_id. This ensures shadow overseers (who don't have subscriptions) are handled correctly - they can have a customer_id but no subscription.

Output: Updated subscription.ts that queries subscriptions via customer_id.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/src/services/paddle.ts
@backend/src/services/subscription.ts

Project context:
- Plan 10-01 created getSubscriptionByCustomer function
- Now need to update subscription.ts to use it
- Current code uses getSubscriptionFromPaddle(subscriptionId, env) which needs to be replaced
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update imports in subscription.ts</name>
  <files>backend/src/services/subscription.ts</files>
  <action>
    Update the imports at the top of the file to include the new function:

    Change:
    ```typescript
    import {
      getSubscriptionFromPaddle,
      isShadowPaymentValid,
      isSubscriptionActive as isPaddleSubscriptionActive
    } from './paddle';
    ```

    To:
    ```typescript
    import {
      getSubscriptionByCustomer,
      isShadowPaymentValid,
      isSubscriptionActive as isPaddleSubscriptionActive
    } from './paddle';
    ```

    Remove the old getSubscriptionFromPaddle import as it will no longer be used.
  </action>
  <verify>
    Run `grep "getSubscriptionByCustomer" backend/src/services/subscription.ts` to confirm import exists.
  </verify>
  <done>
    Imports updated to use customer-based function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update getActiveSubscription to use customer_id</name>
  <files>backend/src/services/subscription.ts</files>
  <action>
    Update the getActiveSubscription function to query via customer_id instead of subscription_id.

    The key change is at line 110 where:
    ```typescript
    const paddleSub = await getSubscriptionFromPaddle(overseer.paddle_subscription_id, env);
    ```

    Should become:
    ```typescript
    // Query subscription via customer_id (not subscription_id)
    const paddleSub = overseer.paddle_customer_id 
      ? await getSubscriptionByCustomer(overseer.paddle_customer_id, env)
      : null;
    ```

    The full logic should be:
    1. If no paddle_customer_id and not shadow → FREE tier
    2. If shadow → check transactions (existing logic)
    3. If has paddle_customer_id → query via getSubscriptionByCustomer(customer_id)
    4. If no subscription found → FREE tier

    Also update the check at line 113 to not rely on subscription_id:
    ```typescript
    // If subscription not found or not active: return FREE tier
    if (!paddleSub) {
      return getFreeTierDefaults();
    }
    ```

    Remove any references to `overseer.paddle_subscription_id` in the subscription query logic.
  </action>
  <verify>
    Run `grep -n "paddle_subscription_id" backend/src/services/subscription.ts` to confirm it's removed from subscription queries. Run `grep -n "getSubscriptionByCustomer" backend/src/services/subscription.ts` to confirm the new function is used.
  </verify>
  <done>
    getActiveSubscription now queries subscriptions using customer_id instead of subscription_id.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. getSubscriptionByCustomer is imported in subscription.ts
2. getSubscriptionFromPaddle is no longer imported
3. No use of paddle_subscription_id in subscription query logic
4. TypeScript compiles without errors
5. Unit tests pass
</verification>

<success_criteria>
- subscription.ts uses customer_id for Paddle queries
- Shadow overseers handled correctly
- No subscription_id used in query logic
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-id-subscription-query/10-02-SUMMARY.md`
</output>
