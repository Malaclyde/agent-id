---
phase: 10-customer-id-subscription-query
plan: 03
type: execute
wave: 3
depends_on: [10-02]
files_modified: [backend/src/services/webhook-handler.ts]
autonomous: true

must_haves:
  truths:
    - "Webhook handlers use customer_id to fetch subscription info"
    - "handleSubscriptionCancellation works without subscription_id"
    - "Customer-based queries work for all webhook handlers"
  artifacts:
    - path: "backend/src/services/webhook-handler.ts"
      provides: "Customer-based webhook handling"
      contains: "getSubscriptionByCustomer"
---

<objective>
Update webhook handlers to use customer_id for subscription queries.

Purpose: Ensure webhook handlers (cancellation, tier updates, etc.) also use customer_id instead of subscription_id when querying subscription information.

Output: Updated webhook-handler.ts that uses customer-based queries.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/src/services/webhook-handler.ts
@backend/src/services/paddle.ts

Project context:
- Webhook handlers may query subscriptions for various operations
- Need to ensure they use customer_id instead of subscription_id
- Check which handlers use subscription queries
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit webhook handlers for subscription_id usage</name>
  <files>backend/src/services/webhook-handler.ts</files>
  <action>
    First, find all places in webhook-handler.ts that use subscription_id:

    Run: `grep -n "subscription_id" backend/src/services/webhook-handler.ts`

    Identify which handlers query subscriptions and need updating.
  </action>
  <verify>
    Report which handlers use subscription_id and need customer_id update.
  </verify>
  <done>
    Audit complete - identified handlers needing update.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update webhook handlers to use customer_id</name>
  <files>backend/src/services/webhook-handler.ts</files>
  <action>
    For each handler that needs updating, change the subscription query from:

    ```typescript
    const subscription = await getSubscriptionFromPaddle(subscriptionId, env);
    ```

    To:
    ```typescript
    // Query via customer_id if available
    const subscription = customerId 
      ? await getSubscriptionByCustomer(customerId, env)
      : null;
    ```

    Add import for getSubscriptionByCustomer if not already present:
    ```typescript
    import { ..., getSubscriptionByCustomer } from './paddle';
    ```

    The key handlers to check:
    - handleSubscriptionCancellation
    - handleSubscriptionPaused  
    - handleSubscriptionResumed
    - handleTierUpdate

    Note: Many handlers already use paddle_subscription_id from the database to find the overseer. The change is to use customer_id instead for querying subscription details.
  </action>
  <verify>
    Run `grep -n "getSubscriptionByCustomer" backend/src/services/webhook-handler.ts` to confirm the function is used. Run TypeScript compiler to check for errors.
  </verify>
  <done>
    Webhook handlers updated to use customer_id for subscription queries.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. All webhook handlers use customer_id for subscription queries
2. No remaining getSubscriptionFromPaddle calls in webhook-handler.ts
3. TypeScript compiles without errors
</verification>

<success_criteria>
- Webhook handlers use customer_id
- Subscription queries work via customer
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-id-subscription-query/10-03-SUMMARY.md`
</output>
