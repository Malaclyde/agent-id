---
phase: 10-customer-id-subscription-query
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [backend/src/services/paddle.ts]
autonomous: true

must_haves:
  truths:
    - "Backend queries subscriptions using customer_id, not subscription_id"
    - "getSubscriptionsByCustomer function exists in paddle.ts"
    - "subscription_id is not used in any Paddle API calls"
  artifacts:
    - path: "backend/src/services/paddle.ts"
      provides: "Customer-based subscription queries"
      exports: ["getSubscriptionsByCustomer"]
      contains: "/customers/${customerId}/subscriptions"
---

<objective>
Add a new function to query subscriptions by customer_id instead of subscription_id.

Purpose: Currently the backend queries subscriptions using subscription_id handle, which causes issues with shadow overseers who don't have subscriptions. By querying via customer_id, we can properly identify if a customer has any active subscriptions.

Output: New `getSubscriptionsByCustomer()` function in paddle.ts that fetches subscriptions using customer_id.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@backend/src/services/paddle.ts
@backend/src/services/subscription.ts

Project context:
- Current implementation uses subscription_id to query Paddle
- This fails for shadow overseers who don't have subscriptions
- Need to query via customer_id instead
- Paddle API endpoint: GET /customers/{customer_id}/subscriptions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getSubscriptionsByCustomer function to paddle.ts</name>
  <files>backend/src/services/paddle.ts</files>
  <action>
    Add a new function after the existing subscription functions (after line 126) that queries subscriptions by customer_id:

    ```typescript
    /**
     * Get all subscriptions for a Paddle customer
     * @param customerId - Paddle customer ID (ctm_xxx format)
     * @returns Array of subscription objects with tier information
     */
    export async function getSubscriptionsByCustomer(
      customerId: string,
      env: Env
    ): Promise<PaddleSubscription[]> {
      try {
        const response = await paddleAPIRequest<{ data: any[] }>(
          env,
          `/customers/${customerId}/subscriptions`
        );

        const subscriptions = response.data || [];

        return subscriptions.map((sub: any) => ({
          id: sub.id,
          customer_id: sub.customer_id,
          status: sub.status,
          tier_id: mapPriceIdToTier(sub.items?.[0]?.price?.id, env),
          current_period_start: sub.current_period?.starts_at,
          current_period_end: sub.current_period?.ends_at,
          price_id: sub.items?.[0]?.price?.id,
        }));
      } catch (error) {
        console.error('Failed to fetch subscriptions by customer from Paddle:', error);
        return [];
      }
    }
    ```

    This function:
    - Takes customer_id instead of subscription_id
    - Calls Paddle's `/customers/{customer_id}/subscriptions` endpoint
    - Returns an array of subscriptions (customer may have multiple)
    - Maps price_id to tier for each subscription
  </action>
  <verify>
    Run `grep -n "getSubscriptionsByCustomer" backend/src/services/paddle.ts` to confirm the function exists. Run `grep -n "/customers/\${customerId}/subscriptions" backend/src/services/paddle.ts` to confirm the endpoint is correct.
  </verify>
  <done>
    New getSubscriptionsByCustomer function exists in paddle.ts that queries subscriptions using customer_id.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getSubscriptionByCustomer function</name>
  <files>backend/src/services/paddle.ts</files>
  <action>
    Add a helper function that returns a single (first/active) subscription by customer:

    ```typescript
    /**
     * Get the first active subscription for a Paddle customer
     * @param customerId - Paddle customer ID (ctm_xxx format)
     * @returns First active subscription or null if none found
     */
    export async function getSubscriptionByCustomer(
      customerId: string,
      env: Env
    ): Promise<PaddleSubscription | null> {
      const subscriptions = await getSubscriptionsByCustomer(customerId, env);
      
      if (subscriptions.length === 0) {
        return null;
      }

      // Return the first active subscription, or the first one if none active
      const activeStatuses = ['active', 'trialing', 'past_due'];
      const activeSub = subscriptions.find(sub => activeStatuses.includes(sub.status));
      
      return activeSub || subscriptions[0] || null;
    }
    ```

    This provides a simpler interface for the common case of needing just one subscription.
  </action>
  <verify>
    Run `grep -n "getSubscriptionByCustomer" backend/src/services/paddle.ts` to confirm the function exists.
  </verify>
  <done>
    New getSubscriptionByCustomer function exists in paddle.ts.
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. getSubscriptionsByCustomer function exists and exports
2. getSubscriptionByCustomer function exists and exports
3. Both functions use customer_id, not subscription_id
4. TypeScript compiles without errors
</verification>

<success_criteria>
- getSubscriptionsByCustomer function added to paddle.ts
- getSubscriptionByCustomer function added to paddle.ts
- Both use customer_id for queries
- subscription_id not used in these new functions
</success_criteria>

<output>
After completion, create `.planning/phases/10-customer-id-subscription-query/10-01-SUMMARY.md`
</output>
