---
phase: 21-agent-oauth-registration-limit
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema/agents.ts
  - backend/src/services/agent.ts
  - backend/src/routes/oauth.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Unclaimed agents (FREE tier) limited to 10 OAuth requests per calendar month"
    - "Claimed agents use billing period from Paddle subscription"
    - "Limit checked at /authorize endpoint, returns 403 access_denied when exceeded"
    - "OAuth request recorded to oauth_requests table at /token exchange (not /authorize)"
    - "Old oauth_count and billing_period_end columns removed from agents table"
    - "Auto-prune keeps last 20 records per agent in oauth_requests"
  artifacts:
    - path: "backend/src/db/schema/agents.ts"
      provides: "Schema without oauth_count and billing_period_end columns"
      contains: "Remove lines 11-12"
    - path: "backend/src/services/agent.ts"
      provides: "Agent service without old OAuth limit functions"
      contains: "Remove incrementOAuthCount, incrementOAuthCountWithLimitCheck, canAgentPerformOAuth"
    - path: "backend/src/services/oauth-limit.ts"
      provides: "New OAuth limit checking service"
      exports: ["checkOAuthLimit", "getOAuthRequestCountInPeriod"]
    - path: "backend/src/routes/oauth.ts"
      provides: "OAuth routes with new limit checking at /authorize and record at /token"
      contains: "checkOAuthLimit call at /authorize, recordOAuthRequest at /token"
  key_links:
    - from: "oauth.ts /authorize"
      to: "oauth-limit.ts checkOAuthLimit"
      via: "import and function call"
      pattern: "checkOAuthLimit.*agentId.*env"
    - from: "oauth.ts /token handleAuthorizationCodeGrant"
      to: "oauth-history.ts recordOAuthRequest"
      via: "function call after successful token exchange"
      pattern: "recordOAuthRequest.*approved"
    - from: "oauth-limit.ts"
      to: "ownership.ts isAgentClaimed"
      via: "import to determine if agent has overseer"
      pattern: "isAgentClaimed.*agentId"
    - from: "oauth-limit.ts"
      to: "subscription-config.ts SUBSCRIPTION_TIERS"
      via: "import to get tier limits"
      pattern: "SUBSCRIPTION_TIERS.*FREE.*max_oauth_per_period"
---

<objective>
Replace the broken oauth_count/billing_period_end tracking with proper OAuth request limiting using the oauth_requests table. Unclaimed agents use calendar month limits (10 requests). Claimed agents use billing period from Paddle. Limit check at /authorize, record at /token exchange.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-agent-oauth-registration-limit/21-CONTEXT.md

# Existing implementation (to be removed):
@backend/src/db/schema/agents.ts (lines 11-12: oauth_count, billing_period_end)
@backend/src/services/agent.ts (lines 87-227: incrementOAuthCount, incrementOAuthCountWithLimitCheck, canAgentPerformOAuth)
@backend/src/routes/oauth.ts (line 123: incrementOAuthCountWithLimitCheck call)

# Reference implementations:
@backend/src/services/oauth-history.ts (recordOAuthRequest, pruneOldRequests)
@backend/src/services/ownership.ts (isAgentClaimed function)
@backend/src/services/subscription-config.ts (SUBSCRIPTION_TIERS.FREE.max_oauth_per_period = 10)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove old OAuth tracking from schema and agent service</name>
  <files>backend/src/db/schema/agents.ts, backend/src/services/agent.ts</files>
  <action>
## agents.ts schema changes:
1. Remove line 11: `oauth_count: integer('oauth_count').notNull().default(0),`
2. Remove line 12: `billing_period_end: text('billing_period_end').notNull().default(sql\`datetime('now', '+1 month')\`),`

## agent.ts service changes:
1. Remove import of `getNextBillingPeriod` (line 6) if no longer needed
2. Remove `incrementOAuthCount` function (lines 87-115)
3. Remove `incrementOAuthCountWithLimitCheck` function (lines 117-206)
4. Remove `canAgentPerformOAuth` function (lines 208-227)
5. In `createAgent` function, remove setting oauth_count and billing_period_end from the insert (lines 44-53 and 55-64)
6. Remove import of `sql` from drizzle-orm (line 5) if no longer needed after removing these functions

Keep all other functions in agent.ts unchanged (createAgent, getAgentById, getAgentByPublicKey).
  </action>
  <verify>
- grep -n "oauth_count" backend/src/db/schema/agents.ts returns no matches
- grep -n "billing_period_end" backend/src/db/schema/agents.ts returns no matches  
- grep -n "incrementOAuthCount\|canAgentPerformOAuth" backend/src/services/agent.ts returns no matches
- backend builds without errors: cd backend && npm run build
  </verify>
  <done>
- agents.ts schema has no oauth_count or billing_period_end columns
- agent.ts service has no OAuth increment or limit checking functions
- createAgent no longer sets oauth_count or billing_period_end
  </done>
</task>

<task type="auto">
  <name>Task 2: Create new OAuth limit checking service and update /authorize</name>
  <files>backend/src/services/oauth-limit.ts, backend/src/routes/oauth.ts</files>
  <action>
## Create new file: backend/src/services/oauth-limit.ts

This service handles OAuth limit checking using the oauth_requests table.

### Imports needed:
- { createDB } from '../db'
- { oauthRequests } from '../db/schema'
- { eq, and, gte, lte, desc } from 'drizzle-orm'
- { isAgentClaimed } from './ownership' (for checking if agent has overseer)
- { getEntitySubscription } from './subscription' (for getting Paddle subscription)
- { SUBSCRIPTION_TIERS } from './subscription-config'
- { generateUUID } from '../utils/helpers'

### Functions to implement:

1. **getOAuthRequestCountInPeriod(db, agentId, startDate, endDate): number**
   - Query oauth_requests table counting rows where agent_id matches and created_at between startDate and endDate
   - Return count as number

2. **getCalendarMonthPeriod(): {start: Date, end: Date}**
   - Returns current calendar month: start = 1st of current month, end = last day of current month

3. **getBillingPeriodFromPaddle(db, agentId, env): Promise<{start: Date, end: Date} | null>**
   - Use getEntitySubscription to get subscription for the agent's overseer
   - Return billing period dates from subscription (billing_period_end - 30 days to billing_period_end)
   - Return null if agent unclaimed or no subscription

4. **checkOAuthLimit(db, agentId, env): Promise<{allowed: boolean, current: number, limit: number, periodEnd: Date, message?: string}>**
   - Check if agent is claimed using isAgentClaimed
   - If unclaimed: use calendar month period, limit = SUBSCRIPTION_TIERS.FREE.max_oauth_per_period (10)
   - If claimed: get billing period from Paddle, limit from subscription (usually -1 = unlimited)
   - If limit is -1 (unlimited): return {allowed: true, current: 0, limit: -1, periodEnd}
   - Count requests in period using getOAuthRequestCountInPeriod
   - If current >= limit: return {allowed: false, current, limit, periodEnd, message}
   - Otherwise: return {allowed: true, current, limit, periodEnd}

### Update oauth.ts /authorize endpoint:
1. Remove import of incrementOAuthCountWithLimitCheck from agent.ts
2. Import checkOAuthLimit from new ./oauth-limit service
3. At line 122-130, replace the incrementOAuthCountWithLimitCheck call with:
   ```typescript
   const limitCheck = await checkOAuthLimit(c.env.DB, agentId, c.env);
   if (!limitCheck.allowed) {
     await recordOAuthRequest(c.env.DB, agentId, body.client_id, body.scope || '', 'denied');
     return c.json({
       error: 'access_denied',
       error_description: limitCheck.message || `OAuth limit reached (${limitCheck.current}/${limitCheck.limit} for this period)`
     }, 403);
   }
   ```

Note: DO NOT record to oauth_requests at /authorize - only at /token exchange.
  </action>
  <verify>
- File backend/src/services/oauth-limit.ts exists with checkOAuthLimit function
- backend builds without errors
- grep -n "checkOAuthLimit" backend/src/routes/oauth.ts shows usage in /authorize
- No incrementOAuthCountWithLimitCheck remaining in oauth.ts
  </verify>
  <done>
- New oauth-limit.ts service created with checkOAuthLimit function
- /authorize endpoint checks OAuth limits using new service
- Returns 403 with access_denied error when limit exceeded
- Limit checked at /authorize, not at /token
  </done>
</task>

<task type="auto">
  <name>Task 3: Update /token to record OAuth requests and clean up userinfo</name>
  <files>backend/src/routes/oauth.ts</files>
  <action>
## Update handleAuthorizationCodeGrant in oauth.ts (around line 190):

After successful token exchange (after generating access_token and refresh_token, before returning response), add:

```typescript
// Record successful OAuth request to oauth_requests table for tracking limits
await recordOAuthRequest(
  c.env.DB,
  codeData.agent_id,
  codeData.client_id,
  codeData.scope,
  'approved'
);
```

This should be added after line 284 (after refresh token generated) and before the return statement at line 286.

## Update /userinfo endpoint (lines 458-461):

The subscription scope currently returns agent.oauth_count and agent.billing_period_end which no longer exist.

Change lines 458-461 from:
```typescript
if (scopes.includes('subscription')) {
  response.oauth_count = agent.oauth_count;
  response.billing_period_end = agent.billing_period_end;
}
```

To query oauth_requests for the count instead (optional - could also just return 0 or remove this):

```typescript
if (scopes.includes('subscription')) {
  // OAuth count now tracked in oauth_requests table - query for current month count
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
  const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).toISOString();
  
  const drizzleDb = createDB(c.env.DB);
  const countResult = await drizzleDb
    .select({ count: sql<number>`count(*)` })
    .from(oauthRequests)
    .where(
      and(
        eq(oauthRequests.agent_id, agent.id),
        eq(oauthRequests.status, 'approved'),
        gte(oauthRequests.created_at, startOfMonth),
        lte(oauthRequests.created_at, endOfMonth)
      )
    );
  
  response.oauth_count = countResult[0]?.count || 0;
  response.billing_period_end = endOfMonth;
}
```

Or simpler: just remove this subscription scope handling entirely since it's no longer relevant with the new tracking approach.

## Verify imports:
- Ensure oauthRequests is imported from db/schema in userinfo if you implement the query
- Ensure createDB is imported if needed
  </action>
  <verify>
- recordOAuthRequest is called in handleAuthorizationCodeGrant after successful token exchange
- OAuth requests are recorded with status 'approved' at /token (not /authorize)
- userinfo endpoint handles subscription scope correctly (either query or remove)
- backend builds without errors
  </verify>
  <done>
- /token endpoint records OAuth request to oauth_requests on successful code exchange
- recordOAuthRequest called with 'approved' status only after tokens generated
- userinfo endpoint no longer references removed columns
  </done>
</task>

</tasks>

<verification>
1. Verify schema changes: agents table no longer has oauth_count or billing_period_end columns
2. Verify old functions removed: agent.ts has no OAuth limit checking functions
3. Verify new service: oauth-limit.ts has checkOAuthLimit that:
   - Uses calendar month for unclaimed agents
   - Uses billing period from Paddle for claimed agents
   - Returns proper error format
4. Verify /authorize: uses checkOAuthLimit, returns 403 access_denied when limit exceeded
5. Verify /token: records OAuth request only after successful token exchange
6. Verify pruning: oauth-history.ts already prunes to MAX_HISTORY_PER_AGENT (10), but CONTEXT says keep last 20 - update MAX_HISTORY_PER_AGENT from 10 to 20
7. Run backend build to ensure no TypeScript errors
</verification>

<success_criteria>
- Unclaimed agents (FREE tier) limited to 10 OAuth requests per calendar month
- Claimed agents use billing period from Paddle subscription
- Limit check happens at /authorize endpoint
- Returns 403 with access_denied error when limit exceeded
- OAuth request recorded to oauth_requests table at /token exchange (not /authorize)
- Old oauth_count and billing_period_end columns removed
- Auto-prune keeps last 20 records per agent
</success_criteria>

<output>
After completion, create `.planning/phases/21-agent-oauth-registration-limit/21-01-SUMMARY.md`
</output>
