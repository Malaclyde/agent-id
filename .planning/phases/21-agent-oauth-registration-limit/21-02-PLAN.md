---
phase: 21-agent-oauth-registration-limit
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/subscription.ts
  - backend/src/services/oauth-limit.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Claimed agents with paused subscriptions have billing_period_end from Paddle"
    - "checkOAuthLimit correctly uses billing period for paused subscriptions"
  artifacts:
    - path: "backend/src/services/subscription.ts"
      provides: "Include billing_period_end for paused subscriptions"
      lines: "130-138"
    - path: "backend/src/services/oauth-limit.ts"
      provides: "Handle paused subscription status correctly"
      lines: "65-81"
  key_links:
    - from: "backend/src/services/oauth-limit.ts"
      to: "backend/src/services/subscription.ts"
      via: "getEntitySubscription call"
      pattern: "getBillingPeriodFromPaddle.*getEntitySubscription"
---

<objective>
Fix the billing period lookup for claimed agents with paused subscriptions.

Purpose: When a subscription is 'paused', getEntitySubscription currently returns FREE tier defaults without billing_period_end, causing getBillingPeriodFromPaddle to return null. This makes checkOAuthLimit fall back to FREE tier calendar month limits incorrectly.

Output: Claimed agents with paused subscriptions will have billing_period_end from Paddle, allowing correct OAuth limit calculations.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/21-agent-oauth-registration-limit/21-01-SUMMARY.md
@.planning/phases/21-agent-oauth-registration-limit/21-UAT.md

# Gap context from UAT.md:
# - truth: "Claimed agents use billing period from Paddle subscription"
# - status: failed
# - reason: "User reported: the paddlePeriod in the checkOAuthLimit function is null"
# - root_cause: "getActiveSubscription returns FREE tier defaults (no billing_period_end) when subscription status is not active/trialing/past_due - status='paused' causes fallback to FREE with no period"
# - missing:
#     - "Include billing_period_end from Paddle even for paused subscriptions"
#     - "Handle subscription status='paused' correctly in oauth-limit.ts"
</context>

<tasks>

<task type="auto">
  <name>Fix subscription.ts to include billing_period_end for paused subscriptions</name>
  <files>backend/src/services/subscription.ts</files>
  <action>
In getEntitySubscription function (lines 130-138), change the logic for non-active statuses:

Currently (lines 130-138):
```
const activeStatuses = ['active', 'trialing', 'past_due'];
if (!paddleSub || !activeStatuses.includes(paddleSub.status)) {
  return { 
    ...getFreeTierDefaults(), 
    billing_period_end: undefined,
    status: paddleSub?.status || 'inactive'
  };
}
```

Change to include billing_period_end from Paddle even when status is not active:
```
const activeStatuses = ['active', 'trialing', 'past_due'];
const pausedStatuses = ['paused'];

if (paddleSub && pausedStatuses.includes(paddleSub.status)) {
  // Paused subscriptions still have billing period - return tier limits with paused status
  const tierLimits = getTierLimits(paddleSub.tier_id);
  return {
    ...tierLimits,
    id: paddleSub.id,
    status: paddleSub.status,
    billing_period_end: paddleSub.current_period_end,
    current_period_start: paddleSub.current_period_start,
    will_renew: false,
    scheduled_cancel_at: null,
  };
}

if (!paddleSub || !activeStatuses.includes(paddleSub.status)) {
  return { 
    ...getFreeTierDefaults(), 
    billing_period_end: undefined,
    status: paddleSub?.status || 'inactive'
  };
}
```

This ensures paused subscriptions return their billing_period_end from Paddle.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd backend && npx tsc --noEmit
```
  </verify>
  <done>subscription.ts returns billing_period_end for paused subscriptions</done>
</task>

<task type="auto">
  <name>Verify oauth-limit.ts handles paused subscriptions correctly</name>
  <files>backend/src/services/oauth-limit.ts</files>
  <action>
Review getBillingPeriodFromPaddle function (lines 65-81):

The function already handles the case where subscription.billing_period_end exists. With the subscription.ts fix above, paused subscriptions will now have billing_period_end populated, so getBillingPeriodFromPaddle will return the correct period.

No code changes needed in oauth-limit.ts - the existing logic at lines 72-74 will now work correctly:
```
if (!subscription || !subscription.billing_period_end) {
  return null;
}
```

This will only return null for truly inactive subscriptions, not for paused ones.

Optional: Add a comment clarifying that paused subscriptions are handled by subscription.ts returning billing_period_end.
  </action>
  <verify>
TypeScript compiles and function logic is sound:
```bash
cd backend && npx tsc --noEmit
```
  </verify>
  <done>oauth-limit.ts correctly uses billing period for paused subscriptions</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run TypeScript compile to verify no errors
2. The checkOAuthLimit function will now correctly use billing period for paused subscriptions
3. Claimed agents with paused subscriptions will NOT fall back to FREE tier calendar month limits
</verification>

<success_criteria>
- subscription.ts returns billing_period_end for paused subscriptions
- checkOAuthLimit uses the billing period (not calendar month) for claimed agents with paused subscriptions
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-agent-oauth-registration-limit/{phase}-{plan}-SUMMARY.md`
</output>
